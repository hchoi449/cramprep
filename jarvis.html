<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Jarvis - ThinkBigPrep</title>
    <meta name="description" content="Jarvis: your AI study assistant at ThinkBigPrep." />
    <link rel="shortcut icon" href="assets/logo/thinkbigprep-icon.svg" type="image/svg+xml" />
    <link rel="stylesheet" href="css/index.css?v=1.1" />
    <link rel="stylesheet" href="css/login.css?v=1.0" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.11.3/font/bootstrap-icons.min.css" />
  </head>
  <body>
    <header class="header">
      <div class="header-container">
        <a href="index.html#home" class="logo" aria-label="ThinkBigPrep Logo" style="text-decoration:none;color:inherit;">
          <img src="./assets/logo/thinkbigprep-logo.svg" alt="ThinkBigPrep" />
        </a>
        <nav class="nav-desktop">
          <a href="index.html#home">Home</a>
          <a href="timetable.html">Timetable</a>
          <a href="index.html#courses">Plans</a>
          <a href="index.html#coaches">Available Tutors</a>
          <a href="about.html">About Us</a>
          <a href="jarvis.html" class="active">Jarvis</a>
          <a href="ai-curriculum.html">AI Curriculum</a>
          <a href="problem-sets.html">Think Lab <span class="new-tag">NEW</span></a>
          <a href="login.html" class="student-login-link">Student Login</a>
        </nav>
        <button class="mobile-menu-btn" onclick="toggleMobileMenu()"><i class="bi bi-list"></i></button>
      </div>
      <nav class="nav-mobile" id="mobile-menu">
        <a href="index.html#home">Home</a>
        <a href="timetable.html">Timetable</a>
        <a href="index.html#courses">Plans</a>
        <a href="index.html#coaches">Available Tutors</a>
        <a href="about.html">About Us</a>
        <a href="jarvis.html" class="active">Jarvis</a>
        <a href="ai-curriculum.html">AI Curriculum</a>
        <a href="problem-sets.html">Think Lab <span class="new-tag">NEW</span></a>
      </nav>
    </header>

    <main class="settings-wrap" style="min-height:calc(100vh - 220px);">
      <section class="settings-card" aria-labelledby="jarvisTitle" style="max-width:900px; margin:120px auto 0;">
        <div class="settings-head">
          <h1 id="jarvisTitle" class="settings-title">Jarvis</h1>
          <p class="settings-sub">Your AI study assistant for fast summaries, practice questions, and explanations.</p>
        </div>
        
      </section>

      <!-- Drag & Drop File Uploader -->
      <section class="settings-card" aria-labelledby="uploadTitle" style="max-width:900px; margin:24px auto 80px;">
        <div class="settings-head">
          <h2 id="uploadTitle" class="settings-title">Upload Worksheets</h2>
          <p class="settings-sub">Drag & drop PDFs or images, or browse to upload. Progress is shown per file.</p>
        </div>
        <div style="padding:16px; display:grid; gap:12px;">
          <div style="display:grid; gap:10px; grid-template-columns:1fr 1fr;">
            <div>
              <label class="setting-label" for="schoolInput">School</label>
              <div style="position:relative">
                <input id="schoolInput" type="text" placeholder="Search school..." autocomplete="off" style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:8px" />
                <div id="schoolSuggest" style="position:absolute;left:0;right:0;top:46px;background:#fff;border:1px solid #e5e7eb;border-radius:8px;box-shadow:0 10px 20px rgba(0,0,0,.08);display:none;max-height:220px;overflow:auto;z-index:20"></div>
              </div>
            </div>
            <div>
              <label class="setting-label" for="courseSelect">Course</label>
              <select id="courseSelect" style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:8px;background:#fff">
                <option value="">Select course</option>
                <option>Pre-Algebra</option>
                <option>Geometry</option>
                <option>Algebra I</option>
                <option>Algebra II</option>
                <option>Pre-Calculus</option>
                <option>Calculus AB</option>
                <option>Calculus BC</option>
              </select>
            </div>
            <div>
              <label class="setting-label" for="teacherInput">Teacher</label>
              <input id="teacherInput" type="text" placeholder="ex. Mrs. Smith" autocomplete="off" style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:8px" />
            </div>
          </div>
          <div>
            <label class="setting-label" for="lessonSlugInput">Lesson Slug</label>
            <input id="lessonSlugInput" type="text" placeholder="e.g., algebra-ii" value="jarvis-uploads" style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:8px" />
          </div>
          <div id="tbp-uploader" class="rounded-2xl border border-slate-200 bg-white p-4" style="box-shadow:0 10px 30px rgba(0,0,0,.08);">
            <div id="tbp-dropzone" class="rounded-2xl border border-dashed border-slate-300" style="padding:24px; text-align:center; background:#f8fafb; cursor:pointer;">
              <div style="display:inline-flex; align-items:center; justify-content:center; height:64px; width:64px; border-radius:9999px; background:#fff; color:#6b7280; box-shadow:0 1px 4px rgba(0,0,0,.08); margin-bottom:8px;">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden style="height:28px; width:28px;">
                  <path d="M19.35 10.04a7.49 7.49 0 0 0-14-2.09A5.5 5.5 0 0 0 6.5 21H18a4.5 4.5 0 0 0 1.35-10.96ZM12 13a1 1 0 0 1 1 1v3.586l.293-.293a1 1 0 1 1 1.414 1.414l-2.707 2.707a1 1 0 0 1-1.414 0L7.879 18.707a1 1 0 0 1 1.414-1.414L9.586 17V14a1 1 0 0 1 1-1h1.414Z"/>
                </svg>
              </div>
              <h3 style="margin:4px 0 0; font-size:18px; font-weight:700; color:#1f2937;">Upload files</h3>
              <p style="margin:2px 0 0; color:#6b7280;">JPEG, PNG, PDF up to 50MB each</p>
              <div class="rounded-2xl border border-dashed border-slate-300" style="padding:16px; margin-top:12px;">
                <p style="font-weight:600; color:#1f2937;">Choose a file or drag & drop it here</p>
                <p style="margin-top:4px; color:#6b7280; font-size:14px;">Click to browse or drop multiple files</p>
                <div style="margin-top:10px;">
                  <button id="tbp-browse" type="button" class="btn btn-primary">Browse File</button>
                </div>
                <input id="tbp-file-input" type="file" multiple accept="image/jpeg,image/png,application/pdf" style="display:none" />
              </div>
            </div>

            <!-- Selected / Upload list -->
            <div id="tbp-file-list" style="margin-top:16px; display:none;" class="rounded-2xl bg-slate-50 p-4">
              <div style="display:flex; align-items:center; justify-content:space-between;">
                <p id="tbp-file-count" style="font-weight:600; color:#334155; font-size:14px;">0 files selected</p>
                <div style="display:flex; gap:8px;">
                  <button id="tbp-clear" type="button" class="btn">Clear</button>
                  <button id="tbp-upload" type="button" class="btn btn-secondary" disabled>Upload</button>
                </div>
              </div>
              <div id="tbp-rows" style="margin-top:8px;"></div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <!-- Full-screen loading overlay -->
    <div id="jarvisLoading" style="display:none;position:fixed;inset:0;background:rgba(255,255,255,0.92);backdrop-filter:saturate(140%) blur(2px);z-index:50;align-items:center;justify-content:center;">
      <div style="text-align:center;">
        <div class="tbp-star-spinner" aria-label="Loading" style="margin:0 auto 12px;"></div>
        <div style="font-size:20px;font-weight:800;color:#6b3410;">Custom made Study Guide loading....</div>
      </div>
    </div>

    <footer class="footer">
      <div class="container">
        <div class="footer-content">
          <div class="footer-section">
            <div class="footer-logo"><img src="./assets/logo/thinkbigprep-logo.svg" alt="ThinkBigPrep" /><span>ThinkBigPrep</span></div>
          </div>
          <div class="footer-section">
            <h4>SEE ALSO</h4>
            <ul>
              <li><a href="index.html#home">Home</a></li>
              <li><a href="timetable.html">Timetable</a></li>
              <li><a href="ai-curriculum.html">AI Curriculum</a></li>
              <li><a href="problem-sets.html">Think Lab</a></li>
            </ul>
          </div>
          <div class="footer-section"><h4>CONTACT US</h4><p>Phone: 201-665-0123</p><p>Email: info@thinkbigprep.com</p></div>
        </div>
        <div class="footer-bottom"><p>ThinkBigPrep © 2025</p></div>
      </div>
    </footer>

    <script>window.TBP_AUTH_BASE='https://cramprep.onrender.com';</script>
    <script src="index.js"></script>
    <script src="login.js?v=1.0"></script>
    <script>
      (function(){
        function val(){ return (document.getElementById('jarvisPrompt').value||'').trim(); }
        function setOut(html){ document.getElementById('jarvisOutput').innerHTML = html; }
        async function callJarvis(prompt){
          try{
            setOut('<div class="tbp-star-spinner" aria-label="Loading"></div>');
            const res = await fetch((window.TBP_AUTH_BASE||'') + '/ai/agent1/generate-assist-v2?lesson=ad-hoc', {
              method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ user: prompt })
            });
            const j = await res.json().catch(()=>({}));
            if (!res.ok || !j || !j.ok){ throw new Error((j && j.error)||'Jarvis failed'); }
            setOut('<pre style="white-space:pre-wrap">'+ (j.preview||'') +'</pre>');
          }catch(e){ setOut('<div style="color:#b00">'+ String(e && e.message || e) +'</div>'); }
        }
        document.getElementById('btnSummary').addEventListener('click', function(){
          const p = val(); if (!p) return; callJarvis('Give a concise study summary:\n\n'+p);
        });
        document.getElementById('btnQuestions').addEventListener('click', function(){
          const p = val(); if (!p) return; callJarvis('Create 5 practice questions with answers based on this content:\n\n'+p);
        });
        document.getElementById('btnExplain').addEventListener('click', function(){
          const p = val(); if (!p) return; callJarvis('Explain step-by-step, with examples, for:\n\n'+p);
        });
      })();
    </script>
    <script>
      (function(){
        const ACCEPT = ['image/jpeg','image/png','application/pdf'];
        const MAX_MB = 50; const MAX_BYTES = MAX_MB * 1024 * 1024;
        const MAX_FILES = 5;
        const els = {
          drop: document.getElementById('tbp-dropzone'),
          browse: document.getElementById('tbp-browse'),
          input: document.getElementById('tbp-file-input'),
          list: document.getElementById('tbp-file-list'),
          count: document.getElementById('tbp-file-count'),
          clear: document.getElementById('tbp-clear'),
          upload: document.getElementById('tbp-upload'),
          rows: document.getElementById('tbp-rows'),
          slug: document.getElementById('lessonSlugInput')
        };
        const overlay = document.getElementById('jarvisLoading');
        let items = [];

        function fmtBytes(bytes){ if (bytes===0) return '0 B'; const k=1024; const sizes=['B','KB','MB','GB']; const i=Math.floor(Math.log(bytes)/Math.log(k)); return `${(bytes/Math.pow(k,i)).toFixed(i===0?0:2)} ${sizes[i]}`; }
        function setDragging(on){ els.drop.style.background = on ? '#eff6ff' : '#f8fafb'; }
        function dedupeKey(f){ return f.name + '|' + f.size; }
        function render(){
          els.list.style.display = items.length ? 'block' : 'none';
          els.count.textContent = `${items.length} file${items.length>1?'s':''} selected`;
          els.upload.disabled = !items.some(x => x.status==='ready');
          els.rows.innerHTML = items.map(it => {
            const badge = it.file.type.includes('pdf')? 'PDF' : (it.file.type.includes('png')?'PNG':'JPG');
            const barColor = it.status==='error'? '#ef4444' : '#0ea5e9';
            const showBar = it.status !== 'ready';
            return `
              <div class="flex items-start justify-between gap-4 py-3" style="display:flex;align-items:flex-start;justify-content:space-between;gap:16px;padding:12px 0;border-top:1px solid #e5e7eb;">
                <div class="min-w-0 flex-1" style="min-width:0;flex:1;">
                  <div class="flex items-center gap-2" style="display:flex;align-items:center;gap:8px;">
                    <span class="inline-flex h-8 w-8 items-center justify-content-center rounded-xl bg-slate-100 text-slate-600" style="display:inline-flex;height:32px;width:32px;border-radius:12px;background:#f1f5f9;color:#475569;align-items:center;justify-content:center;">${badge}</span>
                    <div class="min-w-0" style="min-width:0;">
                      <p class="truncate text-sm font-medium text-slate-900" style="margin:0;font-weight:600;color:#111827;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${it.file.name}</p>
                      <p class="text-xs text-slate-500" style="margin:2px 0 0;color:#6b7280;font-size:12px;">${fmtBytes(it.file.size)}</p>
                    </div>
                  </div>
                  <div class="mt-2" style="margin-top:8px;display:flex;align-items:center;gap:8px;">
                    <label style="font-size:12px;color:#475569;">Type:</label>
                    <select data-type-for="${it.id}" class="tbp-type" style="padding:6px 8px;border:1px solid #e5e7eb;border-radius:8px;background:#fff;">
                      <option value="blank" ${it.wtype==='blank'?'selected':''}>Blank Worksheet</option>
                      <option value="answer" ${it.wtype==='answer'?'selected':''}>Answer Key</option>
                      <option value="notes" ${it.wtype==='notes'?'selected':''}>Notes</option>
                    </select>
                  </div>
                  ${showBar?`
                    <div class="mt-2" style="margin-top:8px;">
                      <div class="h-2 w-full overflow-hidden rounded-full bg-slate-100" style="height:8px;border-radius:9999px;background:#f1f5f9;">
                        <div style="height:8px;border-radius:9999px;background:${barColor};width:${it.progress||0}%;"></div>
                      </div>
                      <p class="mt-1 text-xs text-slate-500" style="margin-top:4px;color:#64748b;font-size:12px;">
                        ${it.status==='uploading'?`Uploading… ${Math.round(it.progress||0)}%`: it.status==='done'?'Uploaded': it.status==='error'?(it.error||'Upload failed') : 'Ready'}
                      </p>
                      ${it.pngs && it.pngs.length ? `<p class="text-xs" style="margin-top:2px;color:#475569;">Converted ${it.pngs.length} PNG${it.pngs.length>1?'s':''}</p>` : ''}
                    </div>
                  `:''}
                </div>
                <button type="button" data-id="${it.id}" class="btn" style="border:1px solid #e5e7eb;border-radius:12px;padding:6px 12px;font-size:12px;" aria-label="Remove ${it.file.name}">Remove</button>
              </div>
            `; }).join('');
          // bind remove buttons
          els.rows.querySelectorAll('button[data-id]').forEach(btn => {
            btn.addEventListener('click', function(){ const id=this.getAttribute('data-id'); items = items.filter(x => x.id!==id); render(); });
          });
          // bind per-file type selects
          els.rows.querySelectorAll('select.tbp-type').forEach(sel => {
            sel.addEventListener('change', function(){
              const id = this.getAttribute('data-type-for');
              items = items.map(x => x.id===id ? ({ ...x, wtype: this.value }) : x);
            });
          });
        }

        function addFiles(fileList){
          if (!fileList) return;
          if (items.length >= MAX_FILES){ alert(`You can upload up to ${MAX_FILES} files.`); return; }
          const remaining = MAX_FILES - items.length;
          const arr = Array.from(fileList).slice(0, Math.max(0, remaining));
          const truncated = fileList.length > remaining;
          const existingKeys = new Set(items.map(x => dedupeKey(x.file)));
          for (const f of arr){
            let error;
            if (!ACCEPT.includes(f.type)) error = 'Unsupported file type';
            else if (f.size > MAX_BYTES) error = `File exceeds ${MAX_MB}MB`;
            const key = dedupeKey(f); if (existingKeys.has(key)) continue;
            items.push({ id: crypto.randomUUID(), file: f, status: error?'error':'ready', error, progress: error?0:1, wtype: 'blank' });
          }
          render();
          if (truncated){ alert(`Only ${MAX_FILES} files allowed. Extra files were not added.`); }
        }

        // Drag & drop handlers
        ['dragenter','dragover'].forEach(evt => els.drop.addEventListener(evt, e => { e.preventDefault(); e.stopPropagation(); setDragging(true); }));
        ;['dragleave','dragend'].forEach(evt => els.drop.addEventListener(evt, e => { e.preventDefault(); e.stopPropagation(); setDragging(false); }));
        els.drop.addEventListener('drop', e => { e.preventDefault(); e.stopPropagation(); setDragging(false); addFiles(e.dataTransfer.files); });
        els.drop.addEventListener('click', () => els.input.click());
        els.browse.addEventListener('click', e => { e.stopPropagation(); els.input.click(); });
        els.input.addEventListener('change', e => addFiles(e.currentTarget.files));

        els.clear.addEventListener('click', () => { items = []; render(); });

        // Custom dropdown suggestions for School (limit 5)
        let schoolIdx = -1; let schoolOpts = []; let schoolOpen = false;
        function renderSchoolSuggest(){
          const box = document.getElementById('schoolSuggest');
          if (!schoolOpen){ box.style.display='none'; return; }
          box.style.display='block';
          if (!schoolOpts.length){
            box.innerHTML = `<div style="padding:10px 12px;color:#6b7280;">No results</div>`;
            return;
          }
          box.innerHTML = schoolOpts.map((s,i)=> `<div data-i="${i}" style="padding:10px 12px;cursor:pointer;${i===schoolIdx?'background:#f1f5f9':''}">${s}</div>`).join('');
          Array.from(box.querySelectorAll('div[data-i]')).forEach(el=>{
            el.addEventListener('mousedown', function(e){ // select before blur
              e.preventDefault();
              const i = Number(this.getAttribute('data-i'))||0;
              const v = schoolOpts[i]||''; document.getElementById('schoolInput').value = v; schoolOpen=false; renderSchoolSuggest();
            });
          });
        }
        async function refreshSchools(q){
          try{
            const qs = (q? ('?q='+encodeURIComponent(q)) : '') + (q? '&' : '?') + 'limit=5';
            const r = await fetch((window.TBP_AUTH_BASE||'') + '/ai/schools'+qs);
            const j = await r.json().catch(()=>({}));
            schoolOpts = ((j && j.schools) || []).filter(Boolean).slice(0,5);
            schoolIdx = -1; renderSchoolSuggest();
          }catch{ schoolOpts=[]; renderSchoolSuggest(); }
        }
        // Keyboard navigation + Enter autocomplete
        document.getElementById('schoolInput').addEventListener('keydown', function(e){
          const box = document.getElementById('schoolSuggest');
          if (e.key==='ArrowDown'){ if (schoolOpts.length){ schoolOpen=true; schoolIdx = (schoolIdx+1)%schoolOpts.length; renderSchoolSuggest(); e.preventDefault(); } }
          else if (e.key==='ArrowUp'){ if (schoolOpts.length){ schoolOpen=true; schoolIdx = (schoolIdx>0?schoolIdx-1:schoolOpts.length-1); renderSchoolSuggest(); e.preventDefault(); } }
          else if (e.key==='Enter'){
            if (schoolOpts.length){ const v = schoolOpts[schoolIdx>=0?schoolIdx:0]; this.value = v; schoolOpen=false; renderSchoolSuggest(); e.preventDefault(); }
          } else if (e.key==='Escape') { schoolOpen=false; renderSchoolSuggest(); }
        });
        document.getElementById('schoolInput').addEventListener('focus', function(){ schoolOpen=true; renderSchoolSuggest(); });
        document.addEventListener('click', function(e){ const box=document.getElementById('schoolSuggest'); const inp=document.getElementById('schoolInput'); if (!box.contains(e.target) && e.target!==inp){ schoolOpen=false; renderSchoolSuggest(); } });

        // no teacher auto-fetch; user types manually now
        document.getElementById('schoolInput').addEventListener('input', function(){ refreshSchools(this.value); });
        // no teacher auto-fetch; user types manually now
        document.getElementById('schoolInput').addEventListener('focus', function(){ refreshSchools(this.value || ''); });

        els.upload.addEventListener('click', async function(){
          const slug = (els.slug.value||'jarvis-uploads').trim();
          const school = (document.getElementById('schoolInput').value||'').trim();
          const course = (document.getElementById('courseSelect').value||'').trim();
          const teacher = (document.getElementById('teacherInput').value||'').trim();
          // mark uploading & show overlay
          try { overlay.style.display='flex'; } catch{}
          items = items.map(it => it.status==='ready'? { ...it, status:'uploading', progress:5 } : it);
          render();
          for (const it of items){
            if (it.status !== 'uploading') continue;
            try {
              await new Promise((resolve, reject) => {
                const xhr = new XMLHttpRequest();
                xhr.open('POST', (window.TBP_AUTH_BASE||'') + '/ai/worksheet/upload');
                xhr.upload.onprogress = (e) => {
                  if (!e.lengthComputable) return;
                  const p = Math.round((e.loaded / e.total) * 100);
                  it.progress = p; render();
                };
                xhr.onreadystatechange = function(){
                  if (xhr.readyState === 4){
                    try {
                      const j = JSON.parse(xhr.responseText||'{}');
                      if (xhr.status>=200 && xhr.status<300 && j && j.ok){
                        // After successful upload, convert to PNGs via preprocess
                        const fileUrl = j.url || '';
                        const doPre = fileUrl ? fetch((window.TBP_AUTH_BASE||'') + '/ai/worksheet/preprocess', {
                          method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ url: fileUrl, dpi: 300 })
                        }).then(r=>r.json()).catch(()=>({})): Promise.resolve({});
                        doPre.then(pp=>{
                          try { it.pngs = (pp && pp.images) || []; } catch {}
                          it.status='done'; it.progress=100; render(); resolve(null);
                        }).catch(()=>{ it.status='done'; it.progress=100; render(); resolve(null); });
                      } else {
                        it.status='error'; it.error=(j&&j.error)||('Upload failed '+xhr.status); render(); reject(new Error(it.error));
                      }
                    }
                    catch(e){ it.status='error'; it.error='Invalid server response'; render(); reject(e); }
                  }
                };
                const form = new FormData();
                form.append('lessonSlug', slug);
                form.append('file', it.file, it.file.name);
                if (school) form.append('school', school);
                if (course) form.append('course', course);
                if (teacher) form.append('teacher', teacher);
                if (it.wtype) form.append('worksheetType', it.wtype);
                xhr.send(form);
              });
            } catch { /* already marked */ }
          }
          render();
          try { overlay.style.display='none'; } catch{}
        });

        // initial render
        render();
        // teacher suggestions removed
      })();
    </script>
  </body>
  </html>


