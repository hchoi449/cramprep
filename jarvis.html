<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Jarvis - ThinkBigPrep</title>
    <meta name="description" content="Jarvis: your AI study assistant at ThinkBigPrep." />
    <link rel="shortcut icon" href="assets/logo/thinkbigprep-icon.svg" type="image/svg+xml" />
    <link rel="stylesheet" href="css/index.css?v=1.1" />
    <link rel="stylesheet" href="css/login.css?v=1.0" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.11.3/font/bootstrap-icons.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" />
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    <style>
      .ps-container{display:grid;grid-template-columns:360px minmax(0,1fr);gap:28px;width:min(96vw,1400px);margin:48px auto;padding:0 16px;}
      .ps-sidebar{position:sticky;top:110px;align-self:start;height:calc(100vh - 150px);overflow:auto;border:1px solid #e5e7eb;border-radius:12px;padding:14px;background:#fff;}
      .ps-lesson{display:flex;align-items:center;justify-content:space-between;border:1px solid #eee;border-radius:10px;padding:10px 12px;margin:6px 0;background:#F5E6D3;color:#6b3410;cursor:pointer;width:100%;text-align:left;font:inherit;font-weight:600;gap:10px;}
      .ps-lesson.active{background:#8B4513;color:#fff;border-color:#8B4513;}
      .ps-lesson:focus-visible{outline:2px solid #8B4513;outline-offset:2px;}
      .ps-outline-empty{padding:14px;border-radius:10px;border:1px dashed #e5e7eb;color:#6b7280;background:#fff;margin-top:10px;text-align:center;font-size:.95rem;}
      .ps-exam-meta{margin-bottom:16px;padding:14px;border:1px solid #f0e2d0;border-radius:12px;background:#fbf5ee;color:#6b3410;}
      .ps-exam-meta h3{margin:0;font-size:1.15rem;font-weight:800;color:#6b3410;}
      .ps-exam-meta p{margin:4px 0 0;font-size:.95rem;color:#6b7280;}
      .ps-content{border-radius:12px;padding:22px;background:#fff;border:1px solid rgba(0,0,0,0.04);}
      .ps-breadcrumb{color:#6b7280;font-size:.9rem;margin-bottom:6px;}
      .ps-title{font-size:1.6rem;font-weight:800;color:#1a1a1a;margin:6px 0 14px;}
      .ps-body{line-height:1.7;color:#1a1a1a;}
      .ps-question-stem{font-size:1.2rem;font-weight:700;margin-bottom:12px;}
      .ps-instruction{font-size:1rem;color:#4b5563;margin-bottom:12px;white-space:pre-wrap;}
      .ps-opts{display:flex;flex-direction:column;gap:10px;margin:0;padding:0;}
      .ps-opt{display:flex;align-items:flex-start;gap:10px;border:1px solid #efe7dc;border-radius:10px;padding:12px 14px;background:#fbf5ee;color:#1f2937;}
      .ps-opt-label{font-weight:700;min-width:24px;}
      .ps-explain{flex:1;min-width:0;white-space:pre-wrap;}
      .ps-solution{margin-top:18px;padding:14px;border:1px solid #e5e7eb;border-radius:12px;background:#f9fafb;}
      .ps-solution h4{margin:0 0 8px;font-size:1rem;color:#8B4513;}
      .ps-answer{margin-top:14px;font-weight:600;color:#4b5563;}
      @media(max-width:1000px){.ps-container{grid-template-columns:1fr;gap:20px;margin:32px auto;}.ps-sidebar{position:relative;top:auto;height:auto;overflow:visible;}}
    </style>
  </head>
  <body>
    <header class="header">
      <div class="header-container">
        <a href="index.html#home" class="logo" aria-label="ThinkBigPrep Logo" style="text-decoration:none;color:inherit;">
          <img src="./assets/logo/thinkbigprep-logo.svg" alt="ThinkBigPrep" style="height:48px;width:auto;" />
        </a>
        <nav class="nav-desktop">
          <a href="index.html#home">Home</a>
          <a href="timetable.html">Timetable</a>
          <a href="index.html#courses">Plans</a>
          <a href="index.html#coaches">Available Tutors</a>
          <a href="about.html">About Us</a>
          <a href="jarvis.html" class="active">Jarvis</a>
          <a href="ai-curriculum.html">AI Curriculum</a>
          <a href="problem-sets.html">Think Lab <span class="new-tag">NEW</span></a>
          <a href="login.html" class="student-login-link">Student Login</a>
        </nav>
        <button class="mobile-menu-btn" onclick="toggleMobileMenu()"><i class="bi bi-list"></i></button>
      </div>
      <nav class="nav-mobile" id="mobile-menu">
        <a href="index.html#home">Home</a>
        <a href="timetable.html">Timetable</a>
        <a href="index.html#courses">Plans</a>
        <a href="index.html#coaches">Available Tutors</a>
        <a href="about.html">About Us</a>
        <a href="jarvis.html" class="active">Jarvis</a>
        <a href="ai-curriculum.html">AI Curriculum</a>
        <a href="problem-sets.html">Think Lab <span class="new-tag">NEW</span></a>
      </nav>
    </header>

    <main class="settings-wrap" style="min-height:calc(100vh - 220px);">
      <section id="jarvisAuthWarning" class="settings-card" aria-live="polite" style="max-width:900px; margin:120px auto 0;" hidden>
        <div class="settings-head">
          <h1 class="settings-title">Login Required</h1>
          <p class="settings-sub">Please sign in to your ThinkBigPrep account to access Jarvis and upload study materials.</p>
        </div>
        <div style="display:flex; gap:12px; flex-wrap:wrap;">
          <a href="login.html" class="btn btn-primary student-login-link">Log In</a>
          <a href="index.html#home" class="btn btn-secondary">Back to Home</a>
        </div>
      </section>

      <div id="jarvisApp">
        <section class="settings-card" aria-labelledby="jarvisTitle" style="max-width:900px; margin:120px auto 0;">
          <div class="settings-head">
            <h1 id="jarvisTitle" class="settings-title">Jarvis</h1>
            <p class="settings-sub">Your AI study assistant for fast summaries, practice questions, and explanations.</p>
          </div>
        </section>

        <section id="jarvisResults" class="ps-container">
          <aside class="ps-sidebar">
            <button type="button" id="jarvisMakeGuideBtn" class="btn btn-primary" style="width:100%;margin-bottom:14px;">Make a Study Guide</button>
            <div class="ps-exam-meta">
              <h3 id="jarvisExamTitle">Your Study Guides</h3>
              <p id="jarvisExamDate" style="display:none;"></p>
              <p id="jarvisExamDetails" style="display:none;"></p>
            </div>
            <div id="jarvisResultsOutline"></div>
            <div id="jarvisResultsEmpty" class="ps-outline-empty">Use "Make a Study Guide" to upload worksheets and populate this list.</div>
          </aside>
          <section class="ps-content">
            <div class="ps-breadcrumb" id="jarvisResultBreadcrumb">Your Study Guides</div>
            <h2 class="ps-title" id="jarvisResultTitle">No problems yet</h2>
            <div class="ps-body" id="jarvisResultBody">
              <p class="ps-instruction">Upload a worksheet to generate tailored problems. They will appear here once ready.</p>
            </div>
          </section>
        </section>
      </div>
    </main>

    <footer class="footer">
      <div class="container">
        <div class="footer-content">
          <div class="footer-section">
            <div class="footer-logo"><img src="./assets/logo/thinkbigprep-logo.svg" alt="ThinkBigPrep" /><span>ThinkBigPrep</span></div>
          </div>
          <div class="footer-section">
            <h4>SEE ALSO</h4>
            <ul>
              <li><a href="index.html#home">Home</a></li>
              <li><a href="timetable.html">Timetable</a></li>
              <li><a href="ai-curriculum.html">AI Curriculum</a></li>
              <li><a href="problem-sets.html">Think Lab</a></li>
            </ul>
          </div>
          <div class="footer-section"><h4>CONTACT US</h4><p>Phone: 201-665-0123</p><p>Email: info@thinkbigprep.com</p></div>
        </div>
        <div class="footer-bottom"><p>ThinkBigPrep Â© 2025</p></div>
      </div>
    </footer>

    <script>window.TBP_AUTH_BASE='https://cramprep.onrender.com';</script>
    <script src="index.js"></script>
    <script src="login.js?v=1.0"></script>
    <script>
      (function(){
        const jarvisApp = document.getElementById('jarvisApp');
        const warning = document.getElementById('jarvisAuthWarning');
        if (!jarvisApp || !warning) return;

        let lastAuthState = null;

        function setState(authenticated) {
          jarvisApp.hidden = !authenticated;
          warning.hidden = authenticated;
          if (authenticated) jarvisApp.removeAttribute('aria-hidden');
          else jarvisApp.setAttribute('aria-hidden', 'true');
          if (authenticated && lastAuthState !== true) {
            try { window.dispatchEvent(new CustomEvent('tbp:jarvis:authenticated')); } catch {}
          }
          if (!authenticated && lastAuthState === true) {
            try { window.dispatchEvent(new CustomEvent('tbp:jarvis:unauthenticated')); } catch {}
          }
          lastAuthState = authenticated;
        }

        async function verifyAuth() {
          let token = null;
          try { token = localStorage.getItem('tbp_token'); } catch {}
          if (!token) {
            setState(false);
            return;
          }
          const base = (window.TBP_AUTH_BASE || '').replace(/\/$/, '');
          const url = base ? `${base}/auth/me` : '/auth/me';
          try {
            const res = await fetch(url, { headers: { 'Authorization': `Bearer ${token}` } });
            const data = await res.json().catch(() => ({}));
            if (res.ok && data && data.authenticated) {
              setState(true);
              return;
            }
            if (res.status === 401 || res.status === 403) {
              try {
                localStorage.removeItem('tbp_token');
                localStorage.removeItem('tbp_user');
              } catch {}
            }
          } catch (err) {
            console.warn('Jarvis auth verification failed', err);
          }
          setState(false);
        }

        function init() {
          jarvisApp.hidden = true;
          warning.hidden = true;
          verifyAuth();
        }

        init();
        window.addEventListener('tbp:auth:login', verifyAuth);
        window.addEventListener('storage', function(e){
          if (!e) return;
          if (e.key === 'jarvisGuides') {
            try { window.dispatchEvent(new CustomEvent('tbp:jarvis:guides-updated')); } catch {}
          }
          if (e.key === 'tbp_token' || e.key === 'tbp_user') {
            verifyAuth();
          }
        });
      })();
    </script>
    <script>
      (function(){
        const makeGuideBtn = document.getElementById('jarvisMakeGuideBtn');
        const resultsOutline = document.getElementById('jarvisResultsOutline');
        const resultsEmpty = document.getElementById('jarvisResultsEmpty');
        const resultsExamTitle = document.getElementById('jarvisExamTitle');
        const resultsExamDate = document.getElementById('jarvisExamDate');
        const resultsBreadcrumb = document.getElementById('jarvisResultBreadcrumb');
        const resultsTitle = document.getElementById('jarvisResultTitle');
        const resultsBody = document.getElementById('jarvisResultBody');
        const resultsExamDetails = document.getElementById('jarvisExamDetails');

        if (makeGuideBtn) makeGuideBtn.addEventListener('click', () => { window.location.href = 'jarvis-upload.html'; });

        let storedGuides = [];
        const questionCache = {};
        let currentGuideSlug = null;

        function loadStoredGuides(){
          try {
            const raw = localStorage.getItem('jarvisGuides');
            const arr = raw ? JSON.parse(raw) : [];
            if (!Array.isArray(arr)) return [];
            return arr.filter(g => g && g.slug).sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0));
          } catch {
            return [];
          }
        }

        function formatExamDateLabel(iso){
          if (!iso) return '';
          const date = new Date(iso);
          if (Number.isNaN(date.getTime())) return '';
          return new Intl.DateTimeFormat(undefined, { weekday:'long', month:'short', day:'numeric' }).format(date);
        }

        function formatGuideLabel(guide){
          const title = (guide.title || guide.slug || 'Study Guide').trim();
          const dateLabel = formatExamDateLabel(guide.examDate);
          return dateLabel ? `${title} â ${dateLabel}` : title;
        }

        function highlightSelected(){
          if (!resultsOutline) return;
          Array.from(resultsOutline.querySelectorAll('button[data-slug]')).forEach(btn => {
            btn.classList.toggle('active', btn.dataset.slug === currentGuideSlug);
          });
        }

        function updateMetaForGuide(guide){
          if (!guide) return;
          const title = (guide.title || guide.slug || 'Study Guide').trim();
          const dateLabel = formatExamDateLabel(guide.examDate);
          if (resultsExamTitle) resultsExamTitle.textContent = title;
          if (resultsBreadcrumb) resultsBreadcrumb.textContent = title;
          if (resultsTitle) resultsTitle.textContent = title;
          if (resultsExamDate) {
            if (dateLabel) {
              resultsExamDate.textContent = dateLabel;
              resultsExamDate.style.display = '';
            } else {
              resultsExamDate.textContent = '';
              resultsExamDate.style.display = 'none';
            }
          }
          if (resultsExamDetails) {
            const details = [];
            if (guide.course) details.push(`Course: ${guide.course}`);
            if (guide.teacher) details.push(`Teacher: ${guide.teacher}`);
            if (guide.school) details.push(`School: ${guide.school}`);
            if (details.length) {
              resultsExamDetails.textContent = details.join(' â¢ ');
              resultsExamDetails.style.display = '';
            } else {
              resultsExamDetails.textContent = '';
              resultsExamDetails.style.display = 'none';
            }
          }
        }

        function renderGuideList(){
          if (!resultsOutline) return;
          storedGuides = loadStoredGuides();
          resultsOutline.innerHTML = '';
          if (!storedGuides.length){
            if (resultsEmpty) {
              resultsEmpty.style.display = '';
              resultsEmpty.textContent = 'Use "Make a Study Guide" to upload worksheets and populate this list.';
            }
            if (resultsExamTitle) resultsExamTitle.textContent = 'Your Study Guides';
            if (resultsExamDate) resultsExamDate.style.display = 'none';
            if (resultsExamDetails) resultsExamDetails.style.display = 'none';
            if (resultsBreadcrumb) resultsBreadcrumb.textContent = 'Your Study Guides';
            if (resultsTitle) resultsTitle.textContent = 'No problems yet';
            if (resultsBody) {
              resultsBody.innerHTML = '<p class="ps-instruction">Upload a worksheet to generate tailored problems. They will appear here once ready.</p>';
            }
            currentGuideSlug = null;
            highlightSelected();
            return;
          }

          if (resultsEmpty) resultsEmpty.style.display = 'none';
          storedGuides.forEach(guide => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'ps-lesson';
            btn.dataset.slug = guide.slug;
            btn.textContent = formatGuideLabel(guide);
            btn.addEventListener('click', () => openGuide(guide.slug));
            resultsOutline.appendChild(btn);
          });
          highlightSelected();
        }

        function renderGuideContent(guide, questions){
          updateMetaForGuide(guide);
          if (!resultsBody) return;
          resultsBody.innerHTML = '';
          if (!Array.isArray(questions) || !questions.length){
            resultsBody.innerHTML = '<p class="ps-outline-empty" style="border:none;background:none;padding:0;text-align:left;">No problems available yet for this study guide.</p>';
            return;
          }

          questions.forEach((q, idx) => {
            const wrapper = document.createElement('article');
            wrapper.className = 'ps-q-card';
            wrapper.style.marginBottom = '26px';

            const heading = document.createElement('h3');
            heading.className = 'ps-question-stem';
            heading.textContent = `Problem ${idx + 1}`;
            wrapper.appendChild(heading);

            if (q.instruction){
              const instruct = document.createElement('p');
              instruct.className = 'ps-instruction';
              instruct.textContent = q.instruction;
              wrapper.appendChild(instruct);
            }

            if (q.stem){
              const stem = document.createElement('p');
              stem.className = 'ps-instruction';
              stem.style.fontWeight = '600';
              stem.textContent = q.stem;
              wrapper.appendChild(stem);
            }

            if (Array.isArray(q.options) && q.options.length){
              const opts = document.createElement('div');
              opts.className = 'ps-opts';
              q.options.forEach((opt, optIdx) => {
                const row = document.createElement('div');
                row.className = 'ps-opt';
                const label = document.createElement('span');
                label.className = 'ps-opt-label';
                label.textContent = `${String.fromCharCode(65 + optIdx)}.`;
                const text = document.createElement('span');
                text.className = 'ps-explain';
                text.textContent = opt;
                row.appendChild(label);
                row.appendChild(text);
                opts.appendChild(row);
              });
              wrapper.appendChild(opts);
            }

            if (q.solution || q.answer){
              const sol = document.createElement('div');
              sol.className = 'ps-solution';
              const headingSol = document.createElement('h4');
              headingSol.textContent = 'Solution';
              sol.appendChild(headingSol);
              if (q.solution){
                const solBody = document.createElement('p');
                solBody.textContent = q.solution;
                sol.appendChild(solBody);
              }
              if (q.answer){
                const answer = document.createElement('p');
                answer.className = 'ps-answer';
                answer.textContent = `Answer: ${q.answer}`;
                sol.appendChild(answer);
              }
              wrapper.appendChild(sol);
            }

            resultsBody.appendChild(wrapper);
          });

          try {
            if (window.renderMathInElement) {
              window.renderMathInElement(resultsBody, {
                delimiters: [
                  { left: '\\(', right: '\\)', display: false },
                  { left: '\\[', right: '\\]', display: true },
                  { left: '$$', right: '$$', display: true },
                  { left: '$', right: '$', display: false }
                ],
                throwOnError: false
              });
            }
          } catch (err) {
            console.warn('KaTeX render failed', err);
          }
        }

        async function fetchGuideQuestions(slug){
          const base = (window.TBP_AUTH_BASE || '').replace(/\/$/, '');
          let token = null;
          try { token = localStorage.getItem('tbp_token'); } catch {}
          const headers = token ? { 'Authorization': `Bearer ${token}` } : {};
          const res = await fetch(`${base}/ai/agent2/questions?lesson=${encodeURIComponent(slug)}&ordered=1&n=40`, { headers });
          const data = await res.json().catch(() => ({}));
          if (!res.ok || !data || !Array.isArray(data.questions)) throw new Error('failed_to_load');
          return data.questions;
        }

        async function openGuide(slug){
          if (!slug) return;
          storedGuides = loadStoredGuides();
          const guide = storedGuides.find(g => g.slug === slug);
          if (!guide) return;
          currentGuideSlug = slug;
          highlightSelected();
          updateMetaForGuide(guide);
          localStorage.setItem('jarvisLatestGuide', slug);

          if (questionCache[slug]) {
            renderGuideContent(guide, questionCache[slug]);
            return;
          }

          if (resultsBody) resultsBody.innerHTML = '<p class="ps-outline-empty" style="border:none;background:none;padding:0;text-align:left;">Loading problemsâ¦</p>';
          try {
            const questions = await fetchGuideQuestions(slug);
            questionCache[slug] = questions;
            renderGuideContent(guide, questions);
          } catch (err) {
            console.warn('Failed to load guide', err);
            if (resultsBody) resultsBody.innerHTML = '<p class="ps-outline-empty" style="border:none;background:none;padding:0;text-align:left;">Unable to load problems for this guide.</p>';
          }
        }

        function init(){
          renderGuideList();
          const params = new URLSearchParams(window.location.search);
          const initialSlug = params.get('guide') || localStorage.getItem('jarvisLatestGuide');
          if (initialSlug) openGuide(initialSlug);
        }

        window.addEventListener('tbp:jarvis:guides-updated', renderGuideList);
        window.addEventListener('storage', function(e){
          if (e && e.key === 'jarvisGuides') renderGuideList();
        });

        init();
      })();
    </script>
  </body>
</html>
