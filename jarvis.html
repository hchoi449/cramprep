<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Jarvis - ThinkBigPrep</title>
    <meta name="description" content="Jarvis: your AI study assistant at ThinkBigPrep." />
    <link rel="shortcut icon" href="assets/logo/thinkbigprep-icon.svg" type="image/svg+xml" />
    <link rel="stylesheet" href="css/index.css?v=1.1" />
    <link rel="stylesheet" href="css/login.css?v=1.0" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.11.3/font/bootstrap-icons.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" />
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    <style>
      .ps-container{display:grid;grid-template-columns:360px minmax(0,1fr);gap:28px;width:min(96vw,1400px);margin:48px auto;padding:0 16px;}
      .ps-sidebar{position:sticky;top:110px;align-self:start;height:calc(100vh - 150px);overflow:auto;border:1px solid #e5e7eb;border-radius:12px;padding:14px;background:#fff;}
      .ps-lesson{display:flex;align-items:center;justify-content:space-between;border:1px solid #eee;border-radius:10px;padding:10px 12px;margin:6px 0;background:#F5E6D3;color:#6b3410;cursor:pointer;width:100%;text-align:left;font:inherit;font-weight:600;gap:10px;}
      .ps-lesson.active{background:#8B4513;color:#fff;border-color:#8B4513;}
      .ps-lesson:focus-visible{outline:2px solid #8B4513;outline-offset:2px;}
      .ps-outline-empty{padding:14px;border-radius:10px;border:1px dashed #e5e7eb;color:#6b7280;background:#fff;margin-top:10px;text-align:center;font-size:.95rem;}
      .ps-lesson-row{display:flex;align-items:center;gap:8px;margin:6px 0;}
      .ps-lesson-row .ps-lesson{margin:0;flex:1;}
      .ps-lesson-delete{border:1px solid #fee2e2;background:#fff;color:#b91c1c;border-radius:8px;padding:6px 10px;font-size:.8rem;font-weight:600;cursor:pointer;transition:background .2s ease;}
      .ps-lesson-delete:hover,.ps-lesson-delete:focus-visible{background:#fee2e2;}
      .ps-opt.sel{border-color:#8B4513;background:#fbf5ee;}
      .ps-opt.correct{border-color:#16a34a;background:#dcfce7;color:#065f46;}
      .ps-opt.wrong{border-color:#b91c1c;background:#fee2e2;color:#7f1d1d;}
      .ps-q-nav{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:18px;}
      .ps-q-nav button{min-width:120px;}
      .ps-q-progress{font-weight:700;color:#6b3410;}
      .ps-q-content{min-height:260px;}
      .ps-q-feedback{min-height:24px;font-weight:600;}
      .ps-exam-meta{margin-bottom:16px;padding:14px;border:1px solid #f0e2d0;border-radius:12px;background:#fbf5ee;color:#6b3410;}
      .ps-exam-meta h3{margin:0;font-size:1.15rem;font-weight:800;color:#6b3410;}
      .ps-exam-meta p{margin:4px 0 0;font-size:.95rem;color:#6b7280;}
      .ps-content{border-radius:12px;padding:22px;background:#fff;border:1px solid rgba(0,0,0,0.04);}
      .ps-breadcrumb{color:#6b7280;font-size:.9rem;margin-bottom:6px;}
      .ps-title{font-size:1.6rem;font-weight:800;color:#1a1a1a;margin:6px 0 14px;}
      .ps-body{line-height:1.7;color:#1a1a1a;}
      .ps-question-stem{font-size:1.2rem;font-weight:700;margin-bottom:12px;}
      .ps-instruction{font-size:1rem;color:#4b5563;margin-bottom:12px;white-space:pre-wrap;}
      .ps-opts{display:flex;flex-direction:column;gap:10px;margin:0;padding:0;}
      .ps-opt{display:flex;align-items:flex-start;gap:10px;border:1px solid #efe7dc;border-radius:10px;padding:12px 14px;background:#fbf5ee;color:#1f2937;cursor:pointer;text-align:left;width:100%;transition:background .15s ease,border-color .15s ease;}
      .ps-opt-label{font-weight:700;min-width:24px;}
      .ps-explain{flex:1;min-width:0;white-space:pre-wrap;}
      .ps-solution{margin-top:18px;padding:14px;border:1px solid #e5e7eb;border-radius:12px;background:#f9fafb;}
      .ps-solution h4{margin:0 0 8px;font-size:1rem;color:#8B4513;}
      .ps-answer{margin-top:14px;font-weight:600;color:#4b5563;}
      @media(max-width:1000px){.ps-container{grid-template-columns:1fr;gap:20px;margin:32px auto;}.ps-sidebar{position:relative;top:auto;height:auto;overflow:visible;}}
    </style>
  </head>
  <body>
    <header class="header">
      <div class="header-container">
        <a href="index.html#home" class="logo" aria-label="ThinkBigPrep Logo" style="text-decoration:none;color:inherit;">
          <img src="./assets/logo/thinkbigprep-logo.svg" alt="ThinkBigPrep" style="height:48px;width:auto;" />
        </a>
        <nav class="nav-desktop">
          <a href="index.html#home">Home</a>
          <a href="timetable.html">Timetable</a>
          <a href="index.html#courses">Plans</a>
          <a href="index.html#coaches">Available Tutors</a>
          <a href="about.html">About Us</a>
          <a href="jarvis.html" class="active">Jarvis</a>
          <a href="ai-curriculum.html">AI Curriculum</a>
          <a href="problem-sets.html">Think Lab <span class="new-tag">NEW</span></a>
          <a href="login.html" class="student-login-link">Student Login</a>
        </nav>
        <button class="mobile-menu-btn" onclick="toggleMobileMenu()"><i class="bi bi-list"></i></button>
      </div>
      <nav class="nav-mobile" id="mobile-menu">
        <a href="index.html#home">Home</a>
        <a href="timetable.html">Timetable</a>
        <a href="index.html#courses">Plans</a>
        <a href="index.html#coaches">Available Tutors</a>
        <a href="about.html">About Us</a>
        <a href="jarvis.html" class="active">Jarvis</a>
        <a href="ai-curriculum.html">AI Curriculum</a>
        <a href="problem-sets.html">Think Lab <span class="new-tag">NEW</span></a>
      </nav>
    </header>

    <main class="settings-wrap" style="min-height:calc(100vh - 220px);">
      <section id="jarvisAuthWarning" class="settings-card" aria-live="polite" style="max-width:900px; margin:120px auto 0;" hidden>
        <div class="settings-head">
          <h1 class="settings-title">Login Required</h1>
          <p class="settings-sub">Please sign in to your ThinkBigPrep account to access Jarvis and upload study materials.</p>
        </div>
        <div style="display:flex; gap:12px; flex-wrap:wrap;">
          <a href="login.html" class="btn btn-primary student-login-link">Log In</a>
          <a href="index.html#home" class="btn btn-secondary">Back to Home</a>
        </div>
      </section>

      <div id="jarvisApp">
        <section class="settings-card" aria-labelledby="jarvisTitle" style="max-width:900px; margin:120px auto 0;">
          <div class="settings-head">
            <h1 id="jarvisTitle" class="settings-title">Jarvis</h1>
            <p class="settings-sub">Your AI study assistant for fast summaries, practice questions, and explanations.</p>
          </div>
        </section>

        <section id="jarvisResults" class="ps-container">
          <aside class="ps-sidebar">
            <button type="button" id="jarvisMakeGuideBtn" class="btn btn-primary" style="width:100%;margin-bottom:14px;">Make a Study Guide</button>
            <div class="ps-exam-meta">
              <h3 id="jarvisExamTitle">Your Study Guides</h3>
              <p id="jarvisExamDate" style="display:none;"></p>
              <p id="jarvisExamDetails" style="display:none;"></p>
            </div>
            <div id="jarvisGuideActions" style="display:none;gap:8px;margin-bottom:12px;flex-wrap:wrap;">
              <button type="button" id="jarvisClearGuidesBtn" class="btn btn-secondary" style="flex:1;">Clear All</button>
            </div>
            <div id="jarvisResultsOutline"></div>
            <div id="jarvisResultsEmpty" class="ps-outline-empty">Use "Make a Study Guide" to upload worksheets and populate this list.</div>
          </aside>
          <section class="ps-content">
            <div class="ps-breadcrumb" id="jarvisResultBreadcrumb">Your Study Guides</div>
            <h2 class="ps-title" id="jarvisResultTitle">No problems yet</h2>
            <div class="ps-body" id="jarvisResultBody">
              <p class="ps-instruction">Upload a worksheet to generate tailored problems. They will appear here once ready.</p>
            </div>
          </section>
        </section>
      </div>
    </main>

    <footer class="footer">
      <div class="container">
        <div class="footer-content">
          <div class="footer-section">
            <div class="footer-logo"><img src="./assets/logo/thinkbigprep-logo.svg" alt="ThinkBigPrep" /><span>ThinkBigPrep</span></div>
          </div>
          <div class="footer-section">
            <h4>SEE ALSO</h4>
            <ul>
              <li><a href="index.html#home">Home</a></li>
              <li><a href="timetable.html">Timetable</a></li>
              <li><a href="ai-curriculum.html">AI Curriculum</a></li>
              <li><a href="problem-sets.html">Think Lab</a></li>
            </ul>
          </div>
          <div class="footer-section"><h4>CONTACT US</h4><p>Phone: 201-665-0123</p><p>Email: info@thinkbigprep.com</p></div>
        </div>
        <div class="footer-bottom"><p>ThinkBigPrep © 2025</p></div>
      </div>
    </footer>

    <script>window.TBP_AUTH_BASE='https://cramprep.onrender.com';</script>
    <script src="index.js"></script>
    <script src="login.js?v=1.0"></script>
    <script>
      (function(){
        const jarvisApp = document.getElementById('jarvisApp');
        const warning = document.getElementById('jarvisAuthWarning');
        if (!jarvisApp || !warning) return;

        let lastAuthState = null;

        function setState(authenticated) {
          jarvisApp.hidden = !authenticated;
          warning.hidden = authenticated;
          if (authenticated) jarvisApp.removeAttribute('aria-hidden');
          else jarvisApp.setAttribute('aria-hidden', 'true');
          if (authenticated && lastAuthState !== true) {
            try { window.dispatchEvent(new CustomEvent('tbp:jarvis:authenticated')); } catch {}
          }
          if (!authenticated && lastAuthState === true) {
            try { window.dispatchEvent(new CustomEvent('tbp:jarvis:unauthenticated')); } catch {}
          }
          lastAuthState = authenticated;
        }

        async function verifyAuth() {
          let token = null;
          try { token = localStorage.getItem('tbp_token'); } catch {}
          if (!token) {
            setState(false);
            return;
          }
          const base = (window.TBP_AUTH_BASE || '').replace(/\/$/, '');
          const url = base ? `${base}/auth/me` : '/auth/me';
          try {
            const res = await fetch(url, { headers: { 'Authorization': `Bearer ${token}` } });
            const data = await res.json().catch(() => ({}));
            if (res.ok && data && data.authenticated) {
              setState(true);
              return;
            }
            if (res.status === 401 || res.status === 403) {
              try {
                localStorage.removeItem('tbp_token');
                localStorage.removeItem('tbp_user');
              } catch {}
            }
          } catch (err) {
            console.warn('Jarvis auth verification failed', err);
          }
          setState(false);
        }

        function init() {
          jarvisApp.hidden = true;
          warning.hidden = true;
          verifyAuth();
        }

        init();
        window.addEventListener('tbp:auth:login', verifyAuth);
        window.addEventListener('storage', function(e){
          if (!e) return;
          if (e.key === 'jarvisGuides') {
            try { window.dispatchEvent(new CustomEvent('tbp:jarvis:guides-updated')); } catch {}
          }
          if (e.key === 'tbp_token' || e.key === 'tbp_user') {
            verifyAuth();
          }
        });
      })();
    </script>
    <script>
      (function(){
        const makeGuideBtn = document.getElementById('jarvisMakeGuideBtn');
        const resultsOutline = document.getElementById('jarvisResultsOutline');
        const resultsEmpty = document.getElementById('jarvisResultsEmpty');
        const resultsExamTitle = document.getElementById('jarvisExamTitle');
        const resultsExamDate = document.getElementById('jarvisExamDate');
        const resultsBreadcrumb = document.getElementById('jarvisResultBreadcrumb');
        const resultsTitle = document.getElementById('jarvisResultTitle');
        const resultsBody = document.getElementById('jarvisResultBody');
        const resultsExamDetails = document.getElementById('jarvisExamDetails');
        const guideActions = document.getElementById('jarvisGuideActions');
        const clearGuidesBtn = document.getElementById('jarvisClearGuidesBtn');

        if (makeGuideBtn) makeGuideBtn.addEventListener('click', () => { window.location.href = 'jarvis-upload.html'; });

        let storedGuides = [];
        const questionCache = {};
        const guidePositions = {};
        let currentGuideSlug = null;

        function loadStoredGuides(){
          try {
            const raw = localStorage.getItem('jarvisGuides');
            const arr = raw ? JSON.parse(raw) : [];
            if (!Array.isArray(arr)) return [];
            return arr.filter(g => g && g.slug).sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0));
          } catch {
            return [];
          }
        }

        function formatExamDateLabel(iso){
          if (!iso) return '';
          const date = new Date(iso);
          if (Number.isNaN(date.getTime())) return '';
          return new Intl.DateTimeFormat(undefined, { weekday:'long', month:'short', day:'numeric' }).format(date);
        }

        function formatGuideLabel(guide){
          const title = (guide.title || guide.slug || 'Study Guide').trim();
          const dateLabel = formatExamDateLabel(guide.examDate);
          return dateLabel ? `${title} — ${dateLabel}` : title;
        }

        function deleteGuide(slug){
          if (!slug) return;
          const guides = loadStoredGuides().filter(g => g.slug !== slug);
          try { localStorage.setItem('jarvisGuides', JSON.stringify(guides)); } catch {}
          const latest = localStorage.getItem('jarvisLatestGuide');
          if (latest === slug){
            if (guides.length) localStorage.setItem('jarvisLatestGuide', guides[0].slug);
            else localStorage.removeItem('jarvisLatestGuide');
          }
          delete questionCache[slug];
          delete guidePositions[slug];
          const wasCurrent = currentGuideSlug === slug;
          storedGuides = guides;
          if (wasCurrent){
            currentGuideSlug = guides.length ? guides[0].slug : null;
          }
          renderGuideList();
          if (currentGuideSlug){
            openGuide(currentGuideSlug);
          } else {
            Object.keys(questionCache).forEach(key => {
              if (!guides.some(g => g.slug === key)) delete questionCache[key];
            });
          }
          try { window.dispatchEvent(new CustomEvent('tbp:jarvis:guides-updated')); } catch {}
        }

        function clearAllGuides(){
          if (!storedGuides.length) return;
          const confirmClear = window.confirm('Delete all saved study guides? This cannot be undone.');
          if (!confirmClear) return;
          try {
            localStorage.removeItem('jarvisGuides');
            localStorage.removeItem('jarvisLatestGuide');
          } catch {}
          storedGuides = [];
          currentGuideSlug = null;
          Object.keys(questionCache).forEach(key => delete questionCache[key]);
          Object.keys(guidePositions).forEach(key => delete guidePositions[key]);
          renderGuideList();
          try { window.dispatchEvent(new CustomEvent('tbp:jarvis:guides-updated')); } catch {}
        }

        if (clearGuidesBtn){
          clearGuidesBtn.addEventListener('click', clearAllGuides);
        }

        function highlightSelected(){
          if (!resultsOutline) return;
          Array.from(resultsOutline.querySelectorAll('button[data-slug]')).forEach(btn => {
            btn.classList.toggle('active', btn.dataset.slug === currentGuideSlug);
          });
        }

        function updateMetaForGuide(guide){
          if (!guide) return;
          const title = (guide.title || guide.slug || 'Study Guide').trim();
          const dateLabel = formatExamDateLabel(guide.examDate);
          if (resultsExamTitle) resultsExamTitle.textContent = title;
          if (resultsBreadcrumb) resultsBreadcrumb.textContent = title;
          if (resultsTitle) resultsTitle.textContent = title;
          if (resultsExamDate) {
            if (dateLabel) {
              resultsExamDate.textContent = dateLabel;
              resultsExamDate.style.display = '';
            } else {
              resultsExamDate.textContent = '';
              resultsExamDate.style.display = 'none';
            }
          }
          if (resultsExamDetails) {
            const details = [];
            if (guide.course) details.push(`Course: ${guide.course}`);
            if (guide.teacher) details.push(`Teacher: ${guide.teacher}`);
            if (guide.school) details.push(`School: ${guide.school}`);
            if (details.length) {
              resultsExamDetails.textContent = details.join(' • ');
              resultsExamDetails.style.display = '';
            } else {
              resultsExamDetails.textContent = '';
              resultsExamDetails.style.display = 'none';
            }
          }
        }

        function renderGuideList(){
          if (!resultsOutline) return;
          storedGuides = loadStoredGuides();
          resultsOutline.innerHTML = '';
          if (guideActions){
            guideActions.style.display = storedGuides.length ? 'flex' : 'none';
          }
          if (clearGuidesBtn){
            clearGuidesBtn.disabled = storedGuides.length === 0;
          }
          if (!storedGuides.length){
            if (resultsEmpty) {
              resultsEmpty.style.display = '';
              resultsEmpty.textContent = 'Use "Make a Study Guide" to upload worksheets and populate this list.';
            }
            if (resultsExamTitle) resultsExamTitle.textContent = 'Your Study Guides';
            if (resultsExamDate) resultsExamDate.style.display = 'none';
            if (resultsExamDetails) resultsExamDetails.style.display = 'none';
            if (resultsBreadcrumb) resultsBreadcrumb.textContent = 'Your Study Guides';
            if (resultsTitle) resultsTitle.textContent = 'No problems yet';
            if (resultsBody) {
              resultsBody.innerHTML = '<p class="ps-instruction">Upload a worksheet to generate tailored problems. They will appear here once ready.</p>';
            }
            currentGuideSlug = null;
            highlightSelected();
            return;
          }

          if (resultsEmpty) resultsEmpty.style.display = 'none';
          storedGuides.forEach(guide => {
            const row = document.createElement('div');
            row.className = 'ps-lesson-row';
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'ps-lesson';
            btn.dataset.slug = guide.slug;
            btn.textContent = formatGuideLabel(guide);
            btn.addEventListener('click', () => openGuide(guide.slug));
            const delBtn = document.createElement('button');
            delBtn.type = 'button';
            delBtn.className = 'ps-lesson-delete';
            delBtn.setAttribute('aria-label', `Delete ${guide.title || guide.slug}`);
            delBtn.textContent = 'Delete';
            delBtn.addEventListener('click', (event) => {
              event.stopPropagation();
              deleteGuide(guide.slug);
            });
            row.appendChild(btn);
            row.appendChild(delBtn);
            resultsOutline.appendChild(row);
          });
          highlightSelected();
        }

        function formatDisplayText(val){
          if (val === null || typeof val === 'undefined') return '';
          if (typeof val === 'string') return val;
          if (Array.isArray(val)) return val.map(formatDisplayText).join('\n');
          if (typeof val === 'object'){
            if (typeof val.latex === 'string' && val.latex.trim()) return val.latex;
            if (typeof val.text === 'string' && val.text.trim()) return val.text;
          }
          return String(val);
        }

        function applyMath(el){
          try {
            if (window.renderMathInElement) {
              window.renderMathInElement(el, {
                delimiters: [
                  { left: '\\(', right: '\\)', display: false },
                  { left: '\\[', right: '\\]', display: true },
                  { left: '$$', right: '$$', display: true },
                  { left: '$', right: '$', display: false }
                ],
                throwOnError: false
              });
            }
          } catch (err) {
            console.warn('KaTeX render failed', err);
          }
        }

        function renderGuideContent(guide, questions){
          updateMetaForGuide(guide);
          if (!resultsBody) return;
          resultsBody.innerHTML = '';
          if (!Array.isArray(questions) || !questions.length){
            resultsBody.innerHTML = '<p class="ps-outline-empty" style="border:none;background:none;padding:0;text-align:left;">No problems available yet for this study guide.</p>';
            return;
          }

          const total = questions.length;
          let index = Math.max(0, Math.min(Number.isInteger(guidePositions[guide.slug]) ? guidePositions[guide.slug] : 0, total - 1));
          guidePositions[guide.slug] = index;

          const viewer = document.createElement('div');
          viewer.className = 'ps-q-viewer';
          const nav = document.createElement('div');
          nav.className = 'ps-q-nav';
          const prevBtn = document.createElement('button');
          prevBtn.type = 'button';
          prevBtn.className = 'btn btn-secondary';
          prevBtn.textContent = 'Previous';
          const nextBtn = document.createElement('button');
          nextBtn.type = 'button';
          nextBtn.className = 'btn btn-secondary';
          nextBtn.textContent = 'Next';
          const progress = document.createElement('div');
          progress.className = 'ps-q-progress';
          nav.appendChild(prevBtn);
          nav.appendChild(progress);
          nav.appendChild(nextBtn);

          const content = document.createElement('div');
          content.className = 'ps-q-content';
          viewer.appendChild(nav);
          viewer.appendChild(content);
          resultsBody.appendChild(viewer);

          function updateNavState(){
            progress.textContent = `Problem ${index + 1} of ${total}`;
            prevBtn.disabled = total <= 1 || index === 0;
            nextBtn.disabled = total <= 1 || index === total - 1;
          }

          function setIndex(newIndex){
            index = Math.max(0, Math.min(newIndex, total - 1));
            guidePositions[guide.slug] = index;
            renderProblem();
          }

          function renderProblem(){
            updateNavState();
            const question = questions[index];
            content.innerHTML = '';
            if (!question){
              const empty = document.createElement('p');
              empty.className = 'ps-outline-empty';
              empty.style.border = 'none';
              empty.style.background = 'none';
              empty.style.padding = '0';
              empty.style.textAlign = 'left';
              empty.textContent = 'Problem unavailable.';
              content.appendChild(empty);
              return;
            }

            const card = document.createElement('article');
            card.className = 'ps-q-card';
            card.style.marginBottom = '0';
            content.appendChild(card);

            const heading = document.createElement('h3');
            heading.className = 'ps-question-stem';
            heading.textContent = `Problem ${index + 1}`;
            card.appendChild(heading);

            const instructionText = formatDisplayText(question.instruction || question.instructions || '');
            if (instructionText){
              const instruct = document.createElement('p');
              instruct.className = 'ps-instruction';
              instruct.textContent = instructionText;
              card.appendChild(instruct);
            }

            const stemText = formatDisplayText(
              question.stem_latex ||
              question.stem ||
              question.stimulus_latex ||
              question.stimulus_text ||
              question.promptLatex ||
              question.prompt ||
              question.question ||
              ''
            );
            if (stemText){
              const stem = document.createElement('p');
              stem.className = 'ps-instruction';
              stem.style.fontWeight = '600';
              stem.textContent = stemText;
              card.appendChild(stem);
            }

            const imageUrl = question.imageUrl || question.image || question.pngUrl || '';
            if (imageUrl){
              const imgWrap = document.createElement('div');
              imgWrap.style.margin = '14px 0';
              imgWrap.style.textAlign = 'center';
              const img = document.createElement('img');
              img.src = imageUrl;
              img.alt = 'Worksheet reference';
              img.style.maxWidth = '100%';
              img.style.borderRadius = '12px';
              img.style.boxShadow = '0 8px 26px rgba(0,0,0,0.08)';
              imgWrap.appendChild(img);
              card.appendChild(imgWrap);
            }

            let selectedIdx = null;
            const optionButtons = [];

            const options = Array.isArray(question.options) ? question.options : [];
            if (options.length){
              const opts = document.createElement('div');
              opts.className = 'ps-opts';
              options.forEach((opt, optIdx) => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'ps-opt';
                btn.textContent = formatDisplayText(opt);
                btn.dataset.optionIndex = String(optIdx);
                btn.addEventListener('click', () => {
                  optionButtons.forEach(b => {
                    b.classList.remove('sel', 'correct', 'wrong');
                    b.setAttribute('aria-pressed', 'false');
                  });
                  btn.classList.add('sel');
                  btn.setAttribute('aria-pressed', 'true');
                  selectedIdx = optIdx;
                  feedback.textContent = '';
                  feedback.style.color = '';
                  actionBtn.textContent = 'Check';
                  actionBtn.dataset.mode = 'check';
                  solutionBox.style.display = 'none';
                });
                optionButtons.push(btn);
                opts.appendChild(btn);
              });
              card.appendChild(opts);
            } else {
              const notice = document.createElement('p');
              notice.className = 'ps-outline-empty';
              notice.style.border = 'none';
              notice.style.background = 'none';
              notice.style.padding = '0';
              notice.style.textAlign = 'left';
              notice.textContent = 'No multiple-choice options available for this problem.';
              card.appendChild(notice);
            }

            const actions = document.createElement('div');
            actions.className = 'ps-q-actions';
            actions.style.display = 'flex';
            actions.style.flexDirection = 'column';
            actions.style.gap = '12px';
            actions.style.marginTop = '18px';
            card.appendChild(actions);

            const feedback = document.createElement('div');
            feedback.className = 'ps-q-feedback';
            feedback.setAttribute('role', 'status');
            actions.appendChild(feedback);

            const actionBtn = document.createElement('button');
            actionBtn.type = 'button';
            actionBtn.className = 'btn btn-primary';
            actionBtn.textContent = 'Check';
            actionBtn.dataset.mode = 'check';
            actions.appendChild(actionBtn);

            const solutionBox = document.createElement('div');
            solutionBox.className = 'ps-solution';
            solutionBox.style.display = 'none';
            const solHeading = document.createElement('h4');
            solHeading.textContent = 'Solution';
            solutionBox.appendChild(solHeading);
            const solBody = document.createElement('p');
            solutionBox.appendChild(solBody);
            const answerLine = document.createElement('p');
            answerLine.className = 'ps-answer';
            solutionBox.appendChild(answerLine);
            card.appendChild(solutionBox);

            const correctIndex = Number.isInteger(question.correct) ? Number(question.correct) :
              Number.isInteger(question.answer_index) ? Number(question.answer_index) :
              (Array.isArray(options) ? 0 : -1);

            function revealSolution(){
              const explanation = formatDisplayText(question.explanation || question.solution || '');
              const answerText = formatDisplayText(question.answer || (Array.isArray(options) ? options[correctIndex] : ''));
              if (explanation){
                solBody.textContent = explanation;
                solBody.style.display = '';
              } else {
                solBody.textContent = '';
                solBody.style.display = 'none';
              }
              if (answerText){
                answerLine.textContent = `Answer: ${answerText}`;
                answerLine.style.display = '';
              } else {
                answerLine.textContent = '';
                answerLine.style.display = 'none';
              }
              solutionBox.style.display = explanation || answerText ? '' : 'none';
              applyMath(solutionBox);
            }

            if (!options.length){
              revealSolution();
              if (!feedback.textContent){
                feedback.textContent = 'Review the walkthrough below.';
                feedback.style.color = '#6b3410';
              }
              actionBtn.disabled = true;
            }

            function handleCheck(){
              if (actionBtn.dataset.mode === 'next'){
                if (index < total - 1){
                  setIndex(index + 1);
                } else {
                  setIndex(0);
                }
                return;
              }
              if (!options.length){
                feedback.textContent = 'No answer choices available.';
                feedback.style.color = '#b45309';
                return;
              }
              if (selectedIdx === null){
                feedback.textContent = 'Please select an answer.';
                feedback.style.color = '#b45309';
                return;
              }
              const isCorrect = Number(correctIndex) === Number(selectedIdx);
              optionButtons.forEach(btn => {
                btn.classList.remove('correct', 'wrong');
                const idx = Number(btn.dataset.optionIndex);
                if (isCorrect && idx === selectedIdx){
                  btn.classList.add('correct');
                } else if (!isCorrect && idx === selectedIdx){
                  btn.classList.add('wrong');
                }
              });
              if (isCorrect){
                feedback.textContent = 'Great job! That is correct.';
                feedback.style.color = '#065f46';
                actionBtn.textContent = index < total - 1 ? 'Next Problem' : 'Restart';
                actionBtn.dataset.mode = 'next';
                optionButtons.forEach(btn => btn.disabled = true);
                revealSolution();
              } else {
                feedback.textContent = 'Not quite. Try again.';
                feedback.style.color = '#b91c1c';
                actionBtn.textContent = 'Try Again';
                actionBtn.dataset.mode = 'check';
              }
            }

            actionBtn.addEventListener('click', handleCheck);
            applyMath(card);
          }

          prevBtn.addEventListener('click', () => {
            if (index > 0) setIndex(index - 1);
          });
          nextBtn.addEventListener('click', () => {
            if (index < total - 1) setIndex(index + 1);
          });

          renderProblem();
        }

        async function fetchGuideQuestions(slug){
          const base = (window.TBP_AUTH_BASE || '').replace(/\/$/, '');
          let token = null;
          try { token = localStorage.getItem('tbp_token'); } catch {}
          const headers = token ? { 'Authorization': `Bearer ${token}` } : {};
          const res = await fetch(`${base}/ai/agent2/questions?lesson=${encodeURIComponent(slug)}&ordered=1&n=20`, { headers });
          const data = await res.json().catch(() => ({}));
          if (!res.ok || !data || !Array.isArray(data.questions)) throw new Error('failed_to_load');
          return data.questions;
        }

        async function openGuide(slug){
          if (!slug) return;
          storedGuides = loadStoredGuides();
          const guide = storedGuides.find(g => g.slug === slug);
          if (!guide) return;
          currentGuideSlug = slug;
          highlightSelected();
          updateMetaForGuide(guide);
          localStorage.setItem('jarvisLatestGuide', slug);
          if (!Number.isInteger(guidePositions[slug])) guidePositions[slug] = 0;

          if (questionCache[slug]) {
            renderGuideContent(guide, questionCache[slug]);
            return;
          }

          if (resultsBody) resultsBody.innerHTML = '<p class="ps-outline-empty" style="border:none;background:none;padding:0;text-align:left;">Loading problems…</p>';
          try {
            const questions = await fetchGuideQuestions(slug);
            questionCache[slug] = questions;
            renderGuideContent(guide, questions);
          } catch (err) {
            console.warn('Failed to load guide', err);
            if (resultsBody) resultsBody.innerHTML = '<p class="ps-outline-empty" style="border:none;background:none;padding:0;text-align:left;">Unable to load problems for this guide.</p>';
          }
        }

        function init(){
          renderGuideList();
          const params = new URLSearchParams(window.location.search);
          const initialSlug = params.get('guide') || localStorage.getItem('jarvisLatestGuide');
          if (initialSlug) openGuide(initialSlug);
        }

        window.addEventListener('tbp:jarvis:guides-updated', renderGuideList);
        window.addEventListener('storage', function(e){
          if (e && e.key === 'jarvisGuides') renderGuideList();
        });

        init();
      })();
    </script>
  </body>
</html>
