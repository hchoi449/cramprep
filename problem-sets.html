<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Think Lab - ThinkBigPrep</title>
    <link rel="shortcut icon" href="assets/logo/thinkbigprep-icon.svg" type="image/svg+xml" />
    <link rel="stylesheet" href="css/index.css?v=1.1" />
    <link rel="stylesheet" href="css/timetable.css?v=1.0" />
    <link rel="stylesheet" href="css/login.css?v=1.0" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.11.3/font/bootstrap-icons.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.13.6/underscore-min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <!-- Perseus dependencies (Khan Academy open-source) -->
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" />
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Desmos Graphing Calculator API -->
    <script src="https://www.desmos.com/api/v1.6/calculator.js?apiKey=dcb31709b452b1cf9dc26972add0fda6"></script>
    <!-- Light-weight stand-in: we’ll use a simplified renderer approach that emulates Perseus style -->
    <style>
      .ps-container{display:grid;grid-template-columns:420px minmax(0,1fr);gap:32px;width:min(98vw, 1680px);max-width:1680px;margin:60px auto 40px;padding:0 24px}
      .ps-sidebar{position:sticky;top:96px;align-self:start;height:calc(100vh - 140px);overflow:auto;border:1px solid #e5e7eb;border-radius:12px;padding:12px;background:#fff}
      .ps-section-title{font-size:1.1rem;font-weight:800;color:#8B4513;margin:8px 0 6px}
      .ps-lesson{display:flex;align-items:center;justify-content:space-between;border:1px solid #eee;border-radius:10px;padding:8px 10px;margin:6px 0;background:#F5E6D3;color:#6b3410;cursor:pointer}
      .ps-lesson .status{font-size:.75rem;background:#fff;border:1px solid #e5e7eb;border-radius:9999px;padding:2px 8px}
      .ps-lock{color:#6b3410;opacity:.8;margin-right:6px}
      .ps-progress{height:6px;background:#f3f4f6;border-radius:9999px;overflow:hidden;margin:8px 0}
      .ps-progress>div{height:100%;background:#8B4513}
      .ps-content{border:1px solid #e5e7eb;border-radius:12px;padding:18px;background:#fff}
      .ps-breadcrumb{color:#6b7280;font-size:.9rem;margin-bottom:6px}
      .ps-title{font-size:1.6rem;font-weight:800;color:#1a1a1a;margin:6px 0 10px}
      .ps-actions{display:flex;gap:8px;margin-bottom:12px}
      .ps-actions .btn{padding:10px 14px;border-radius:10px}
      .ps-body{line-height:1.7;color:#1a1a1a}
      @media(max-width:1200px){.ps-container{grid-template-columns:360px minmax(0,1fr);gap:28px}}
      @media(max-width:900px){.ps-container{grid-template-columns:1fr;width:100%;padding:0 16px}.ps-sidebar{position:relative;top:auto;height:auto;overflow:visible}.ps-toggle{display:none}}
      /* Ensure hidden state always respected */
      #psApp[hidden]{display:none !important}
    </style>
  </head>
  <body class="problem-sets">
    <header class="header">
      <div class="header-container">
        <a href="index.html#home" class="logo" style="text-decoration:none;color:inherit;"><img src="./assets/logo/thinkbigprep-logo.svg" alt="ThinkBigPrep"/></a>
        <nav class="nav-desktop">
          <a href="index.html#home">Home</a>
          <a href="timetable.html">Timetable</a>
          <a href="index.html#courses">Plans</a>
          <a href="index.html#coaches">Available Tutors</a>
          <a href="about.html">About Us</a>
          <a href="ai-curriculum.html">AI Curriculum</a>
          <a href="problem-sets.html" class="active">Think Lab <span class="new-tag">NEW</span></a>
          <a href="login.html" class="student-login-link">Student Login</a>
        </nav>
        <button class="mobile-menu-btn" onclick="toggleMobileMenu()"><i class="bi bi-list"></i></button>
      </div>
    </header>

    <section class="timetable-hero">
      <div class="container">
        <h1 class="timetable-title">Think Lab</h1>
        <p class="timetable-subtitle">Customized problem sets powered by Perseus Exercise Renderer</p>
      </div>
    </section>

    <!-- Feature A: 3D Rotating Books Carousel (React + Framer Motion UMD) -->
    <div id="psShelf" aria-label="Subjects">
      <div class="ps-books-grid" id="psBooksGrid"></div>
    </div>

    <main class="ps-container" id="psApp" hidden>
      <aside class="ps-sidebar" id="psSidebar"><div id="psOutline"></div></aside>
      <section class="ps-content">
        <div class="ps-breadcrumb" id="psBreadcrumb">Algebra 1 / Lesson 1</div>
        <h2 class="ps-title" id="psTitle">Linear Equations — Basics</h2>
        <div class="ps-actions">
          <button class="btn btn-primary" id="psPracticeBtn">Practice</button>
          <button class="btn btn-secondary" id="psLiveBtn">Live Session</button>
        </div>
        <div class="ps-body" id="psBody"></div>
      </section>
    </main>

    <footer class="footer">
      <div class="container">
        <div class="footer-content">
          <div class="footer-section">
            <div class="footer-logo"><img src="./assets/logo/thinkbigprep-logo.svg" alt="ThinkBigPrep"/><span>ThinkBigPrep</span></div>
          </div>
          <div class="footer-section">
            <h4>SEE ALSO</h4>
            <ul>
              <li><a href="index.html#home">Home</a></li>
              <li><a href="timetable.html">Timetable</a></li>
              <li><a href="ai-curriculum.html">AI Curriculum</a></li>
              <li><a href="problem-sets.html">Think Lab</a></li>
            </ul>
          </div>
          <div class="footer-section"><h4>CONTACT US</h4><p>Phone: 201-665-0123</p><p>Email: info@thinkbigprep.com</p></div>
        </div>
        <div class="footer-bottom"><p>ThinkBigPrep © 2025</p></div>
      </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/framer-motion@10.18.0/dist/framer-motion.umd.js"></script>
    <script>
      // Subject → Subtopics → Lessons; each lesson has notes and MC questions
      const COURSES = [
        { id:'algebra-1', title:'Pre-Algebra', subtopics:[
          { id:'numbers-operations', title:'Numbers & Operations', lessons:[
            { slug:'place-value-rounding', title:'Place value; rounding & estimation', locked:false, notes:`Lesson outline.` },
            { slug:'integer-operations', title:'Integers: add/subtract/multiply/divide', locked:false, notes:`Lesson outline.` },
            { slug:'absolute-value-opposites', title:'Absolute value & opposites', locked:false, notes:`Lesson outline.` },
            { slug:'properties', title:'Properties: commutative, associative, distributive', locked:false, notes:`Lesson outline.` }
          ]},
          { id:'factors-multiples', title:'Factors & Multiples', lessons:[
            { slug:'divisibility-prime-composite', title:'Divisibility rules; prime vs composite', locked:false, notes:`Lesson outline.` },
            { slug:'prime-factorization', title:'Prime factorization', locked:false, notes:`Lesson outline.` },
            { slug:'gcf', title:'Greatest common factor (GCF)', locked:false, notes:`Lesson outline.` },
            { slug:'lcm', title:'Least common multiple (LCM)', locked:false, notes:`Lesson outline.` }
          ]},
          { id:'fractions', title:'Fractions', lessons:[
            { slug:'equivalent-simplifying', title:'Equivalent fractions; simplifying', locked:false, notes:`Lesson outline.` },
            { slug:'add-subtract-fractions', title:'Add/subtract fractions & mixed numbers', locked:false, notes:`Lesson outline.` },
            { slug:'multiply-divide-fractions', title:'Multiply/divide fractions & mixed numbers', locked:false, notes:`Lesson outline.` },
            { slug:'fraction-word-problems', title:'Fraction word problems', locked:false, notes:`Lesson outline.` }
          ]},
          { id:'decimals', title:'Decimals', lessons:[
            { slug:'place-value-rounding-decimals', title:'Place value; rounding', locked:false, notes:`Lesson outline.` },
            { slug:'decimal-operations', title:'Operations with decimals', locked:false, notes:`Lesson outline.` },
            { slug:'convert-frac-dec', title:'Convert fractions ↔ decimals', locked:false, notes:`Lesson outline.` }
          ]},
          { id:'percents', title:'Percents', lessons:[
            { slug:'convert-percent', title:'Convert percent ↔ decimal ↔ fraction', locked:false, notes:`Lesson outline.` },
            { slug:'percent-of-number', title:'Percent of a number', locked:false, notes:`Lesson outline.` },
            { slug:'discount-tax-tip-change', title:'Discount, tax, tip; percent change', locked:false, notes:`Lesson outline.` },
            { slug:'simple-interest-intro', title:'Simple interest (intro)', locked:false, notes:`Lesson outline.` }
          ]},
          { id:'ratios-rates-proportions', title:'Ratios, Rates & Proportions', lessons:[
            { slug:'ratios-unit-rate', title:'Ratios & unit rate', locked:false, notes:`Lesson outline.` },
            { slug:'proportional-relationships', title:'Proportional relationships & tables', locked:false, notes:`Lesson outline.` },
            { slug:'scale-drawings', title:'Scale drawings & maps', locked:false, notes:`Lesson outline.` },
            { slug:'constant-of-prop', title:'Constant of proportionality', locked:false, notes:`Lesson outline.` }
          ]},
          { id:'expressions', title:'Expressions & Properties', lessons:[
            { slug:'variables-evaluating', title:'Variables & evaluating expressions', locked:false, notes:`Lesson outline.` },
            { slug:'combining-like-terms', title:'Combining like terms', locked:false, notes:`Lesson outline.` },
            { slug:'distributive-property', title:'Distributive property', locked:false, notes:`Lesson outline.` },
            { slug:'writing-expressions', title:'Writing expressions from word phrases', locked:false, notes:`Lesson outline.` }
          ]},
          { id:'equations-inequalities', title:'Equations & Inequalities', lessons:[
            { slug:'one-step-equations', title:'One-step equations', locked:false, notes:`Lesson outline.` },
            { slug:'two-step-equations', title:'Two-step equations', locked:false, notes:`Lesson outline.` },
            { slug:'one-step-inequalities', title:'One-step inequalities; graph on a number line', locked:false, notes:`Lesson outline.` },
            { slug:'word-problems-to-eq', title:'Word problems → equations/inequalities', locked:false, notes:`Lesson outline.` }
          ]},
          { id:'order-exponents', title:'Order of Operations & Exponents (Intro)', lessons:[
            { slug:'pemdas', title:'PEMDAS with integers/fractions/decimals', locked:false, notes:`Lesson outline.` },
            { slug:'integer-exponents', title:'Integer exponents; squares & cubes', locked:false, notes:`Lesson outline.` },
            { slug:'roots-conceptual', title:'Square/cube roots (conceptual)', locked:false, notes:`Lesson outline.` },
            { slug:'scientific-notation-intro', title:'Scientific notation (intro)', locked:false, notes:`Lesson outline.` }
          ]},
          { id:'geometry-foundations', title:'Geometry Foundations', lessons:[
            { slug:'points-lines-angles', title:'Points, lines, angles; angle pairs (complementary, supplementary, vertical)', locked:false, notes:`Lesson outline.` },
            { slug:'triangles-quadrilaterals', title:'Triangles & quadrilaterals (classification, interior angles)', locked:false, notes:`Lesson outline.` },
            { slug:'perimeter-area', title:'Perimeter & area (rectangles, triangles, parallelograms, circles)', locked:false, notes:`Lesson outline.` },
            { slug:'surface-volume', title:'Surface area & volume (rectangular prisms; intro cylinders)', locked:false, notes:`Lesson outline.` },
            { slug:'pythagorean-intro', title:'Pythagorean Theorem (intro & simple applications)', locked:false, notes:`Lesson outline.` }
          ]},
          { id:'coordinate-plane', title:'Coordinate Plane & Patterns', lessons:[
            { slug:'plotting-points', title:'Plotting points in all quadrants', locked:false, notes:`Lesson outline.` },
            { slug:'tables-graphs', title:'Tables → graphs; pattern rules', locked:false, notes:`Lesson outline.` },
            { slug:'arithmetic-sequences-intro', title:'Arithmetic sequences (intro)', locked:false, notes:`Lesson outline.` }
          ]},
          { id:'statistics-probability', title:'Statistics & Probability', lessons:[
            { slug:'mmm-range', title:'Mean, median, mode, range', locked:false, notes:`Lesson outline.` },
            { slug:'plots-hist-box', title:'Dot plots, histograms, box plots (reading & making)', locked:false, notes:`Lesson outline.` },
            { slug:'theoretical-vs-experimental', title:'Theoretical vs experimental probability (single events)', locked:false, notes:`Lesson outline.` },
            { slug:'compound-probability', title:'Simple compound probability (independent events)', locked:false, notes:`Lesson outline.` }
          ]},
          { id:'measurement-conversions', title:'Measurement & Conversions', lessons:[
            { slug:'customary-metric', title:'Customary & metric units', locked:false, notes:`Lesson outline.` },
            { slug:'unit-conversions', title:'Unit conversions; dimensional analysis (intro)', locked:false, notes:`Lesson outline.` },
            { slug:'rates-per', title:'Rates as “per” (mph, $/lb, etc.)', locked:false, notes:`Lesson outline.` }
          ]},
        ]},
        { id:'geometry', title:'Geometry', subtopics:[
          { id:'triangles', title:'Triangles & Congruence', lessons:[
            { slug:'triangle-sum', title:'Triangle Angle Sum', locked:false,
              notes:`# Triangle Angle Sum\nInterior angles of a triangle sum to 180°.`,
              questions:[
                { id:'q1', stem:'If two angles are $50^\\circ$ and $60^\\circ$, the third is', options:['$70^\\circ$','$60^\\circ$','$90^\\circ$','$120^\\circ$'], correct:0, explanation:'$180^\\circ - (50^\\circ+60^\\circ) = 70^\\circ$.', tags:['triangles'] }
              ]
            }
          ]}
        ]},
        { id:'algebra', title:'Algebra', subtopics:[
          { id:'quadratics', title:'Quadratics & Complex', lessons:[
            { slug:'vertex-form', title:'Vertex Form Intro', locked:false,
              notes:`# Vertex Form\n$y = a(x-h)^2 + k$`,
              questions:[
                { id:'q1', stem:'Vertex of $y = (x-3)^2+2$ is', options:['$(3,2)$','$(-3,2)$','$(2,3)$','$(3,-2)$'], correct:0, explanation:'$h=3,\\ k=2$', tags:['quadratics'] }
              ]
            }
          ]}
        ]},
        { id:'algebra-2', title:'Algebra II', subtopics:[
          /* -------------------- QUADRATIC EQUATIONS -------------------- */
          { id:'quadratics', title:'Quadratic Equations', lessons:[
            { slug:'quadratic-factoring-sqrt', title:'Factoring & Square Root Property', locked:false,
              notes:`# Quadratic Equations — Factoring & Square Root
A quadratic has the form $ax^2+bx+c=0$ ($a\\ne0$). 
- **Factoring:** $(x-r_1)(x-r_2)=0\\Rightarrow x=r_1, r_2$.
- **Square root property:** If $x^2=k$ then $x=\\pm\\sqrt{k}$.
> Mastery tip: Try factoring first if $ac$ is small; else consider completing the square or the formula.`,
              graphs:[
                { type:'function', expr:'y=x^2-5x+6' },
                { type:'function', expr:'y=x^2-9' }
              ],
              questions:[
                { id:'q1', stem:'Solve $x^2-5x+6=0$.', options:['$x=2,3$','$x=6$','$x=5$','$x=-2,-3$'], correct:0, explanation:'Factor: $(x-2)(x-3)=0$.', tags:['quadratics','factoring'] },
                { id:'q2', stem:'Solve $x^2=49$.', options:['$x=7$','$x=-7$','$x=\\pm 7$','$x=0$'], correct:2, explanation:'Square root property gives $x=\\pm7$.', tags:['quadratics','square-root'] }
              ]
            },
            { slug:'completing-square', title:'Completing the Square', locked:false,
              notes:`# Completing the Square
Rewrite $ax^2+bx+c$ (assume $a=1$ here) as $(x+\\tfrac{b}{2})^2-\\big(\\tfrac{b}{2}\\big)^2+c$ to solve or to graph vertex form.`,
              graphs:[ { type:'function', expr:'y=x^2+6x+5' } ],
              questions:[
                { id:'q1', stem:'Complete the square: $x^2+6x+5 = (x+\\square)^2+\\square$.', options:['$3,-4$','$2,-1$','$3,-9$','$-3,14$'], correct:0, explanation:'Add/subtract $9$: $(x+3)^2-4$.', tags:['quadratics','completing-square'] },
                { id:'q2', stem:'Solve $x^2+6x+5=0$ by completing the square.', options:['$x=-1,-5$','$x=1,5$','$x=-3$','$x=3$'], correct:0, explanation:'$(x+3)^2=4\\Rightarrow x=-3\\pm2$.', tags:['quadratics'] }
              ]
            },
            { slug:'quadratic-formula-discriminant', title:'Quadratic Formula & Discriminant', locked:false,
              notes:`# Quadratic Formula
For $ax^2+bx+c=0$, $\\displaystyle x=\\frac{-b\\pm\\sqrt{b^2-4ac}}{2a}$.
- Discriminant $\\Delta=b^2-4ac$: $\\Delta>0$ two real roots, $\\Delta=0$ one real root, $\\Delta<0$ complex pair.`,
              graphs:[ { type:'function', expr:'y=2x^2+3x-2' } ],
              questions:[
                { id:'q1', stem:'Solve $2x^2+3x-2=0$.', options:['$x=-2,\\tfrac{1}{2}$','$x=2,-\\tfrac{1}{2}$','$x=1,-2$','$x=\\pm\\sqrt{2}$'], correct:0, explanation:'$\\Delta=25$, $x=(-3\\pm5)/4$.', tags:['quadratics','formula'] },
                { id:'q2', stem:'If $b^2-4ac<0$, the roots are…', options:['Real & distinct','Real & equal','Complex conjugates','Undefined'], correct:2, explanation:'Negative discriminant → nonreal complex pair.', tags:['discriminant'] }
              ]
            },
            { slug:'quadratic-applications', title:'Applications of Quadratics', locked:false,
              notes:`# Applications
Model height/area/optimization via $f(x)=ax^2+bx+c$. Vertex $(h,k)$ gives max/min if $a<0$/$a>0$.`,
              graphs:[ { type:'function', expr:'y=-16t^2+32t+5' } ],
              questions:[
                { id:'q1', stem:'For $h(t)=-16t^2+32t+5$, find the time of maximum height.', options:['$t=1$','$t=\\tfrac{32}{32}$','$t=\\tfrac{-b}{2a}=1$','$t=2$'], correct:2, explanation:'$t=-b/(2a)= -32/(2\\cdot -16)=1$.', tags:['applications','vertex'] },
                { id:'q2', stem:'State the axis of symmetry of $y=-2x^2+8x-1$.', options:['$x=2$','$y=2$','$x=-2$','$y=-2$'], correct:0, explanation:'Axis $x=-b/(2a)=2$.', tags:['vertex','axis'] }
              ]
            }
          ]},

          /* -------------------- INEQUALITIES & ABSOLUTE VALUE -------------------- */
          { id:'inequalities', title:'Inequalities & Absolute Value', lessons:[
            { slug:'linear-inequalities', title:'Linear Inequalities', locked:false,
              notes:`# Linear Inequalities
Solve like equations; **flip the sign** when multiplying/dividing by a negative. Use interval notation.`,
              graphs:[ { type:'numberline', expr:'x>3' }, { type:'numberline', expr:'-2<x\\le4' } ],
              questions:[
                { id:'q1', stem:'Solve $-3x+6\\le0$.', options:['$x\\ge2$','$x\\le2$','$x<2$','$x>2$'], correct:1, explanation:'Divide by −3 and flip.', tags:['inequalities'] },
                { id:'q2', stem:'Which interval matches $1<2x+3\\le7$?', options:['$(-1,2]$','$(-2,1]$','$(-3,2]$','$[ -1,2)$'], correct:0, explanation:'Subtract 3: $-2<2x\\le4\\Rightarrow -1<x\\le2$.', tags:['compound-inequality'] }
              ]
            },
            { slug:'poly-inequalities', title:'Polynomial & Rational Inequalities', locked:false,
              notes:`# Polynomial/Rational Inequalities
1) Move all to one side. 2) Factor. 3) Critical values (zeros, undefined). 4) Sign chart on intervals.`,
              graphs:[ { type:'function', expr:'y=(x-1)(x+2)' }, { type:'function', expr:'y=(x-3)/(x+1)' } ],
              questions:[
                { id:'q1', stem:'Solve $(x-1)(x+2)\\ge0$.', options:['$(-\\infty,-2]\\cup[1,\\infty)$','$(-2,1)$','$(-\\infty,-2)\\cup(1,\\infty)$','$[-2,1]$'], correct:0, explanation:'Nonnegative outside the roots.', tags:['polynomial-inequality'] },
                { id:'q2', stem:'Solve $\\dfrac{x-3}{x+1}<0$.', options:['$(-\\infty,-1)\\cup(3,\\infty)$','$(-1,3)$','$(-\\infty,-1)\\cup( -\\infty,3)$','$(-\\infty,-1)\\cup(0,3)$'], correct:1, explanation:'Negative between -1 and 3.', tags:['rational-inequality'] }
              ]
            },
            { slug:'abs-equations-inequalities', title:'Absolute Value Equations/Inequalities', locked:false,
              notes:`# Absolute Value
- Equation: $|x-a|=d\\Rightarrow x=a\\pm d$.
- Inequality: $|x-a|<d\\Rightarrow a-d<x<a+d$; $|x-a|>d\\Rightarrow x<a-d\\text{ or }x>a+d$.`,
              graphs:[ { type:'function', expr:'y=|x-2|' } ],
              questions:[
                { id:'q1', stem:'Solve $|2x-6|=10$.', options:['$x=8$','$x=-2$','$x=8,-2$','$x=2,6$'], correct:2, explanation:'$2x-6=\\pm10\\Rightarrow x=8,-2$.', tags:['absolute-value'] },
                { id:'q2', stem:'Solve $|x+1|<3$.', options:['$x<-2$','$-4<x<2$','$-2<x<4$','$x>2$'], correct:1, explanation:'Center -1, radius 3 → $-4<x<2$.', tags:['absolute-inequality'] }
              ]
            }
          ]},

          /* -------------------- FUNCTIONS & GRAPHING -------------------- */
          { id:'functions', title:'Functions & Graphing', lessons:[
            { slug:'function-basics', title:'Definition, Domain & Range', locked:false,
              notes:`# Functions
A function assigns **each** input exactly one output. Use notation $f(x)$; domain/range depend on algebraic restrictions.`,
              graphs:[ { type:'function', expr:'y=(x^2-1)/(x-1)' }, { type:'function', expr:'y=\\sqrt{x-2}' } ],
              questions:[
                { id:'q1', stem:'For $g(x)=\\dfrac{1}{x-3}$, which $x$ is not allowed?', options:['$x=3$','$x=0$','$x=-3$','$x=1$'], correct:0, explanation:'Denominator $\\ne0$.', tags:['domain'] },
                { id:'q2', stem:'Domain of $f(x)=\\sqrt{x-2}$ is …', options:['$x>2$','$x\\ge2$','all real $x$','$x\\ne2$'], correct:1, explanation:'Even root → radicand $\\ge0$.', tags:['domain','radicals'] }
              ]
            },
            { slug:'combining-composing', title:'Combine & Compose Functions', locked:false,
              notes:`# Combine/Compose
$(f\\circ g)(x)=f(g(x))$. Watch domains of $g$ **and** of $f$ at $g(x)$.`,
              graphs:[ { type:'function', expr:'y=(x+1)^2' } ],
              questions:[
                { id:'q1', stem:'If $f(x)=x^2$ and $g(x)=x+1$, then $(f\\circ g)(x)$ is …', options:['$x^2+1$','$(x+1)^2$','$x^2+x+1$','$x+1$'], correct:1, explanation:'Substitute $g$ into $f$.', tags:['composition'] },
                { id:'q2', stem:'If $f(x)=\\sqrt{x}$ and $g(x)=x-2$, domain of $f\\circ g$?', options:['$x\\in\\mathbb{R}$','$x\\ge0$','$x\\ge2$','$x>2$'], correct:2, explanation:'Need $x-2\\ge0$.', tags:['composition','domain'] }
              ]
            },
            { slug:'inverse-functions', title:'Inverse Functions', locked:false,
              notes:`# Inverses & One-to-One
$f^{-1}$ exists when $f$ is one-to-one (passes horizontal line test). Solve $y=f(x)$ for $x$, then swap.`,
              graphs:[ { type:'function', expr:'y=2x+1' }, { type:'function', expr:'y=(x-1)/2' } ],
              questions:[
                { id:'q1', stem:'Inverse of $f(x)=2x+1$ is …', options:['$2x-1$','$\\tfrac{x-1}{2}$','$\\tfrac{x+1}{2}$','$-2x+1$'], correct:1, explanation:'Solve $y=2x+1\\Rightarrow x=\\tfrac{y-1}{2}$.', tags:['inverse'] },
                { id:'q2', stem:'Which function is NOT one-to-one?', options:['$y=x^3$','$y=e^x$','$y=x^2$','$y=\\ln x$'], correct:2, explanation:'$x^2$ fails horizontal line test.', tags:['one-to-one'] }
              ]
            }
          ]},

          /* -------------------- POLYNOMIALS -------------------- */
          { id:'polynomials', title:'Polynomial Functions', lessons:[
            { slug:'division', title:'Polynomial Division (Long & Synthetic)', locked:false,
              notes:`# Dividing Polynomials
Long division always works; synthetic requires linear divisor $x-c$. **Remainder theorem:** $f(c)$ is the remainder dividing by $(x-c)$.`,
              graphs:[ { type:'function', expr:'y=x^3-6x^2+11x-6' } ],
              questions:[
                { id:'q1', stem:'The remainder of $f(x)$ upon division by $(x-2)$ equals …', options:['$f(2)$','$f(-2)$','$2f(1)$','$0$'], correct:0, explanation:'Remainder theorem.', tags:['division','remainder-theorem'] },
                { id:'q2', stem:'Divide $x^3-1$ by $x-1$. The quotient is …', options:['$x^2+x+1$','$x^2-x+1$','$x+1$','$x^2+1$'], correct:0, explanation:'Geometric sum or synthetic division.', tags:['division'] }
              ]
            },
            { slug:'zeros-graphing', title:'Zeros, Multiplicity & Graphing', locked:false,
              notes:`# Zeros & Graph Shape
Multiplicity odd → **cross**; even → **touch/bounce**. Leading coefficient test sets end behavior.`,
              graphs:[ { type:'function', expr:'y=(x-1)^2(x+2)' } ],
              questions:[
                { id:'q1', stem:'For $f(x)=(x-1)^2(x+2)$, behavior at $x=1$ is …', options:['crosses','touches/bounces','asymptote','hole'], correct:1, explanation:'Even multiplicity.', tags:['multiplicity'] },
                { id:'q2', stem:'End behavior of $y=-3x^5+\\cdots$?', options:['$\\nearrow\\nearrow$','$\\searrow\\searrow$','$\\nearrow\\searrow$','$\\searrow\\nearrow$'], correct:3, explanation:'Odd degree, negative leading → left up, right down.', tags:['end-behavior'] }
              ]
            },
            { slug:'rational-root-partial-frac', title:'Rational Root Test & Partial Fractions', locked:false,
              notes:`# Rational Root Theorem
Candidates: $\\pm\\frac{p}{q}$ where $p\\mid a_0$, $q\\mid a_n$. 
# Partial Fractions (proper rational)
Decompose into simpler rational terms (for distinct linear factors, $\\tfrac{A}{x-r}$, etc.).`,
              graphs:[ { type:'function', expr:'y=(2x+3)/(x^2-1)' } ],
              questions:[
                { id:'q1', stem:'Possible rational zeros of $2x^3-5x^2+x-3$ include …', options:['$\\pm1,\\pm3,\\pm\\tfrac{1}{2},\\pm\\tfrac{3}{2}$','$\\pm2,\\pm3$','$\\pm\\tfrac{1}{3}$','only $\\pm1$'], correct:0, explanation:'$p\\in\\{\\pm1,\\pm3\\}$, $q\\in\\{\\pm1,\\pm2\\}$.', tags:['rational-root'] },
                { id:'q2', stem:'Denominator factors to $(x-1)(x+1)$. A valid partial fraction form is …', options:['$\\dfrac{A}{x-1}+\\dfrac{B}{x+1}$','$\\dfrac{A}{x^2+1}$','$A(x-1)+B(x+1)$','$\\dfrac{A}{x-1}+B$'], correct:0, explanation:'Distinct linear factors → two simple terms.', tags:['partial-fractions'] }
              ]
            }
          ]},

          /* -------------------- EXPONENTIALS & LOGS -------------------- */
          { id:'exp-log', title:'Exponential & Logarithmic Functions', lessons:[
            { slug:'exponentials', title:'Exponential Functions', locked:false,
              notes:`# Exponentials
$f(x)=a\\,b^x$ with $b>0,b\\ne1$. Growth if $b>1$, decay if $0<b<1$. Special: $f(x)=e^x$.`,
              graphs:[ { type:'function', expr:'y=2^x' }, { type:'function', expr:'y=(1/2)^x' } ],
              questions:[
                { id:'q1', stem:'Which is exponential decay?', options:['$2^x$','$3^x$','$(1/2)^x$','$x^2$'], correct:2, explanation:'Base between 0 and 1.', tags:['exponential'] },
                { id:'q2', stem:'$e^x$ is the exponential with base …', options:['$2$','$10$','$e$','$\\ln$'], correct:2, explanation:'By definition.', tags:['exponential'] }
              ]
            },
            { slug:'logarithms', title:'Logarithms & Properties', locked:false,
              notes:`# Logarithms
$\\log_b a=x \\iff b^x=a$. Properties: $\\log_b(MN)=\\log_bM+\\log_bN$, $\\log_b(M^k)=k\\log_bM$, change of base: $\\log_b a=\\tfrac{\\log a}{\\log b}$.`,
              graphs:[ { type:'function', expr:'y=\\log_{10}(x)' }, { type:'function', expr:'y=\\ln x' } ],
              questions:[
                { id:'q1', stem:'$\\log_2(32)$ equals …', options:['$4$','$5$','$3$','$2$'], correct:1, explanation:'$2^5=32$.', tags:['log'] },
                { id:'q2', stem:'$\\log_b a=\\dfrac{\\ln a}{\\ln b}$ is called …', options:['product rule','change of base','power rule','quotient rule'], correct:1, explanation:'Standard change of base.', tags:['log'] }
              ]
            },
            { slug:'solve-exp-log', title:'Solving Exponential/Log Equations', locked:false,
              notes:`# Solving
- Exponential: isolate base$^{\\text{(stuff)}}$ and use logs if needed.
- Logarithmic: combine logs, convert to exponential; check **domain**.`,
              graphs:[ { type:'function', expr:'y=3\\cdot 2^x' } ],
              questions:[
                { id:'q1', stem:'Solve $2^x=20$ (exact).', options:['$x=\\log_2 20$','$x=\\ln20$','$x=20\\ln2$','$x=20$'], correct:0, explanation:'Take $\\log_2$ (or ln): $x=\\ln20/\\ln2$.', tags:['solve-exponential'] },
                { id:'q2', stem:'Solve $\\ln(x-1)=3$.', options:['$x=20$','$x=e^3+1$','$x=e^3-1$','$x=3$'], correct:1, explanation:'Exponentiate: $x-1=e^3\\Rightarrow x=e^3+1$.', tags:['solve-log'] }
              ]
            },
            { slug:'applications-exp', title:'Applications: Growth, Decay, Interest', locked:false,
              notes:`# Applications
- Continuous growth/decay: $A(t)=A_0e^{kt}$.
- Compound interest: $A=P\\big(1+\\tfrac{r}{n}\\big)^{nt}$; continuous: $A=Pe^{rt}$.`,
              graphs:[ { type:'function', expr:'y=e^{0.3x}' }, { type:'function', expr:'y=e^{-0.4x}' } ],
              questions:[
                { id:'q1', stem:'$A=Pe^{rt}$ with $P=1000,r=0.06,t=5$. Exact $A$ is …', options:['$1000e^{0.3}$','$1000\\cdot 1.06^5$','$1000e^{0.06/5}$','$1000e^{5/0.06}$'], correct:0, explanation:'Continuous compounding.', tags:['applications','interest'] },
                { id:'q2', stem:'In $A=A_0e^{kt}$, $k<0$ indicates …', options:['growth','decay','periodic','constant'], correct:1, explanation:'Negative rate → decay.', tags:['growth-decay'] }
              ]
            }
          ]},

          /* -------------------- SYSTEMS -------------------- */
          { id:'systems', title:'Systems of Equations', lessons:[
            { slug:'linear-systems-2', title:'Two-Variable Linear Systems', locked:false,
              notes:`# Substitution & Elimination
Solve $\\begin{cases}a_1x+b_1y=c_1\\\\a_2x+b_2y=c_2\\end{cases}$ by substitution or elimination. Check for inconsistent or dependent systems.`,
              graphs:[ { type:'function', expr:'y=2x+1' }, { type:'function', expr:'y=-x+7' } ],
              questions:[
                { id:'q1', stem:'Solve $\\{\\,y=2x+1,\\;x+y=7\\,\\}$.', options:['$(2,5)$','$(3,7)$','$(4,9)$','$(1,6)$'], correct:0, explanation:'Substitute: $x+2x+1=7\\Rightarrow x=2,y=5$.', tags:['systems','substitution'] },
                { id:'q2', stem:'Type of system if lines have equal slopes but different intercepts?', options:['Dependent','Inconsistent','Unique solution','Nonlinear'], correct:1, explanation:'Parallel distinct lines → no solution.', tags:['systems'] }
              ]
            },
            { slug:'matrix-method', title:'Augmented Matrix (Gauss-Jordan)', locked:false,
              notes:`# Matrices
Use row operations to reach RREF and read solutions; detect inconsistent (row $[0\\ 0\\ |\\ k]$) or dependent (free variables).`,
              graphs:[],
              questions:[
                { id:'q1', stem:'Row $[0\\ 0\\ |\\ 5]$ in RREF implies …', options:['unique solution','infinitely many','no solution','need more steps'], correct:2, explanation:'Contradiction → inconsistent.', tags:['matrices'] },
                { id:'q2', stem:'A free variable appears when …', options:['a pivot in every column','no pivot in a variable column','two pivots per row','RREF reached'], correct:1, explanation:'No pivot → parameter, infinite solutions.', tags:['matrices'] }
              ]
            },
            { slug:'nonlinear-systems', title:'Nonlinear Systems', locked:false,
              notes:`# Nonlinear
Solve intersections such as line–circle, parabola–line, by substitution or elimination; check extraneous roots.`,
              graphs:[ { type:'function', expr:'y=x+1' }, { type:'function', expr:'(x-2)^2+(y-3)^2=25' } ],
              questions:[
                { id:'q1', stem:'Line $y=x+1$ with circle $(x-2)^2+(y-3)^2=25$: the system has …', options:['0 pts','1 pt','2 pts','infinitely many'], correct:2, explanation:'A secant typically intersects a circle twice (unless tangent or disjoint).', tags:['nonlinear'] },
                { id:'q2', stem:'Best first step for parabola–line system?', options:['Factor denominators','Use Gauss-Jordan','Substitute the linear into the quadratic','Take logs'], correct:2, explanation:'Substitution reduces to a quadratic.', tags:['strategy'] }
              ]
            }
          ]}
        ]},
        { id:'precalculus', title:'Pre-Calculus', subtopics:[
          { id:'functions', title:'Functions & Graphs', lessons:[
            { slug:'domain-range', title:'Domain & Range Basics', locked:false,
              notes:`# Domain & Range\nConsider restrictions like division by zero, even roots.`,
              questions:[
                { id:'q1', stem:'Domain of $f(x)=\\dfrac{1}{x-2}$', options:['$x\\ne2$','$x\\ge2$','$x\\le2$','all real $x$'], correct:0, explanation:'Denominator cannot be zero.', tags:['functions'] }
              ]
            }
          ]}
        ]},
        { id:'calculus', title:'Calculus', subtopics:[
          { id:'limits', title:'Limits & Continuity', lessons:[
            { slug:'limit-basics', title:'Limit Basics', locked:false,
              notes:`# Limits\n$\\lim_{x\\to a} f(x)$ describes approaching behavior.`,
              questions:[
                { id:'q1', stem:'$\\lim_{x\\to 0} (2x) =\ ?$', options:['$0$','$1$','$2$','DNE'], correct:0, explanation:'$2x \\to 0$ as $x\\to0$.', tags:['limits'] }
              ]
            }
          ]}
        ]}
      ];

      function saveProgress(key, value){ try { localStorage.setItem(key, JSON.stringify(value)); } catch{} }
      function getProgress(key, fallback){ try { const v = localStorage.getItem(key); return v ? JSON.parse(v) : fallback; } catch{ return fallback; } }

      function renderSidebar(){
        const root = document.getElementById('psOutline');
        root.innerHTML = '';
        // Course selector
        const selectWrap = document.createElement('div'); selectWrap.style.margin='4px 0 10px';
        const select = document.createElement('select'); select.style.width='100%'; select.style.padding='8px'; select.style.borderRadius='8px'; select.style.border='1px solid #e5e7eb';
        COURSES.forEach(c=>{ const opt=document.createElement('option'); opt.value=c.id; opt.textContent=c.title; if (c.id===currentCourseId) opt.selected=true; select.appendChild(opt); });
        selectWrap.appendChild(select); root.appendChild(selectWrap);

        const course = COURSES.find(c=>c.id===currentCourseId) || COURSES[0];
        const h = document.createElement('div'); h.className='ps-section-title'; h.textContent = course.title; root.appendChild(h);
        const progKey = `ps-progress-${course.id}`;
        const progVal = getProgress(progKey, 0);
        const bar = document.createElement('div'); bar.className='ps-progress'; bar.innerHTML = `<div style="width:${Math.round(progVal*100)}%"></div>`; root.appendChild(bar);

        (course.subtopics||[]).forEach(st => {
          const stHdr = document.createElement('div');
          stHdr.className = 'ps-lesson';
          stHdr.style.fontWeight='700'; stHdr.style.background='#fff';
          stHdr.innerHTML = `<span>${st.title}</span><i class="bi bi-caret-down-fill"></i>`;
          root.appendChild(stHdr);
          const ul = document.createElement('div'); ul.style.margin='6px 0 10px'; ul.style.paddingLeft='8px'; root.appendChild(ul);
          let expanded = true;
          function toggle(){ expanded = !expanded; ul.style.display = expanded ? '' : 'none'; stHdr.querySelector('i').className = expanded ? 'bi bi-caret-down-fill' : 'bi bi-caret-right-fill'; }
          stHdr.addEventListener('click', toggle);

          (st.lessons||[]).forEach(lesson => {
            const row = document.createElement('div'); row.className='ps-lesson'; row.dataset.slug = `${course.id}/${st.id}/${lesson.slug}`;
            const left = document.createElement('div');
            left.style.display='inline-flex'; left.style.alignItems='center';
            if (lesson.locked) { const i=document.createElement('i'); i.className='bi bi-lock ps-lock'; left.appendChild(i); }
            const t=document.createElement('span'); t.textContent=lesson.title; left.appendChild(t);
            const right = document.createElement('div'); right.className='status';
            const score = getProgress(`ps-best-${course.id}-${st.id}-${lesson.slug}`, 0);
            right.innerHTML = lesson.locked? 'Locked' : (score>0? `<span class="ps-badge"><i class="bi bi-check-circle"></i>${Math.round(score*100)}%</span>`:'Start');
            row.appendChild(left); row.appendChild(right);
            row.addEventListener('click', ()=> loadLesson(course.id, st.id, lesson.slug));
            ul.appendChild(row);
          });
        });

        select.addEventListener('change', ()=>{
          currentCourseId = select.value;
          renderSidebar();
          const c = COURSES.find(x=>x.id===currentCourseId);
          if (c && c.subtopics && c.subtopics[0] && c.subtopics[0].lessons && c.subtopics[0].lessons[0]){
            loadLesson(c.id, c.subtopics[0].id, c.subtopics[0].lessons[0].slug);
          }
        });
      }

      function mdToHtml(md){
        return md
          .replace(/^# (.*)$/gm, '<h3>$1</h3>')
          .replace(/^## (.*)$/gm, '<h4>$1</h4>')
          .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
          .replace(/\n/g, '<br/>');
      }

      function loadLesson(courseId, subtopicId, lessonSlug){
        const course = COURSES.find(c=>c.id===courseId); if (!course) return;
        const subtopic = (course.subtopics||[]).find(s=>s.id===subtopicId) || (course.subtopics||[])[0]; if (!subtopic) return;
        const lesson = (subtopic.lessons||[]).find(l=>l.slug===lessonSlug) || subtopic.lessons[0]; if (!lesson || lesson.locked) return;

        document.getElementById('psBreadcrumb').textContent = `${course.title} / ${subtopic.title} / ${lesson.title}`;
        document.getElementById('psTitle').textContent = lesson.title;
        renderLessonContent(course, subtopic, lesson);

        // compute overall course progress as average of best lesson scores across subtopics
        const allLessons = course.subtopics.flatMap(st=> st.lessons || []);
        const avg = allLessons.length ? allLessons.reduce((s,l)=> s + getProgress(`ps-best-${course.id}-${subtopic.id === (course.subtopics[0]||{}).id ? subtopic.id : (course.subtopics.find(st=> st.lessons.includes(l))||{}).id}-${l.slug}`, 0), 0) / allLessons.length : 0;
        saveProgress(`ps-progress-${courseId}`, avg);
        renderSidebar();
        history.replaceState(null, '', `problem-sets.html#/${courseId}/${subtopic.id}/${lesson.slug}`);
      }

      async function renderLessonContent(course, subtopic, lesson){
        const body = document.getElementById('psBody');
        body.innerHTML = '';
        // Overview block for the lesson (short intro)
        const notes = document.createElement('div');
        const intro = (lesson.notes && lesson.notes.trim()) ? lesson.notes.trim() : 'Quick overview will be generated for this lesson.';
        notes.innerHTML = mdToHtml(intro);
        body.appendChild(notes);
        try { if (window.renderMathInElement) { renderMathInElement(notes, { delimiters:[{left:"$$", right:"$$", display:true},{left:"$", right:"$", display:false}] }); } } catch{}

        // Generate initial 1-2 problems immediately, then fetch the rest in the background
        const initialProblems = fallbackProblems(lesson, 2);
        let problems = initialProblems.slice();
        const groups = { easy:[], medium:[], hard:[] };
        let globalId = 0; const used = new Set();
        function classify(p, index){
          const d = String((p.difficulty||'').toLowerCase());
          if (d==='easy'||d==='medium'||d==='hard') return d;
          if (typeof index === 'number') return index < 10? 'easy' : (index < 20? 'medium' : 'hard');
          return 'medium';
        }
        function addProblems(list){
          list.forEach((p, i)=>{
            const id = globalId++;
            const diff = classify(p, i);
            groups[diff].push({ p, id });
            problems.push({ p, id, diff });
          });
        }
        // seed groups with initial
        problems = []; addProblems(initialProblems);
        // background generation for more variety and depth
        (async()=>{
          try {
            const more = await generateProblemsForLesson(course, subtopic, lesson, 40);
            addProblems(more);
          } catch {
            addProblems(fallbackProblems(lesson, 40));
          }
        })();

        if (problems.length){
          // Remove any existing quiz container for this lesson to avoid duplicates
          const existingQuiz = document.getElementById(`ps-quiz-${course.id}-${subtopic.id}-${lesson.slug}`);
          if (existingQuiz && existingQuiz.parentNode) existingQuiz.parentNode.removeChild(existingQuiz);
          const quiz = document.createElement('div'); quiz.style.marginTop='16px';
          quiz.className = 'ps-quiz-root';
          quiz.id = `ps-quiz-${course.id}-${subtopic.id}-${lesson.slug}`;
          const h = document.createElement('h4'); h.textContent = 'Adaptive Problem Set (10)'; quiz.appendChild(h);
          const nav = document.createElement('div'); nav.style.display='flex'; nav.style.gap='8px'; nav.style.margin='8px 0';
          const idxLabel = document.createElement('div'); idxLabel.textContent = '1 / ' + problems.length; nav.appendChild(idxLabel);
          quiz.appendChild(nav);

          const stage = document.createElement('div'); stage.className='ps-q-stage'; stage.innerHTML=''; quiz.appendChild(stage);
          const results = document.createElement('div'); results.style.margin='8px 0'; quiz.appendChild(results);

          let scoreBest = getProgress(`ps-best-${course.id}-${subtopic.id}-${lesson.slug}`, 0);
          let step = 0; let correctCount = 0;
          // groups and used already prepared above
          let currentDifficulty = 'easy';

          function pickNextProblem(){
            const order = currentDifficulty==='easy' ? ['easy','medium','hard'] : (currentDifficulty==='medium' ? ['medium','easy','hard'] : ['hard','medium','easy']);
            for (const g of order){
              const pool = groups[g].filter(x=> !used.has(x.id));
              if (pool.length){
                const choice = pool[Math.floor(Math.random()*pool.length)];
                used.add(choice.id);
                return { q: choice.p, id: choice.id, g };
              }
            }
            return null;
          }

          function renderOne(){
            // ensure single-question rendering
            stage.innerHTML = '';
            const picked = pickNextProblem();
            if (!picked){
              const pct = correctCount / Math.max(1, step); results.innerHTML = `Score: ${Math.round(pct*100)}%`;
              if (pct > scoreBest){ scoreBest = pct; saveProgress(`ps-best-${course.id}-${subtopic.id}-${lesson.slug}`, scoreBest); renderSidebar(); }
              return;
            }
            const q = picked.q;
            const card = document.createElement('div'); card.className='ps-q-card'; stage.appendChild(card);
            const stem = document.createElement('div'); stem.className='ps-stem'; stem.textContent = `${step+1}. ${q.stem}`; card.appendChild(stem);
            try { if (window.renderMathInElement) { renderMathInElement(stem, { delimiters:[{left:"$$", right:"$$", display:true},{left:"$", right:"$", display:false}] }); } } catch{}

            // Desmos container if graph is requested
            if (q.graph){
              const graphDiv = document.createElement('div'); graphDiv.style.height='280px'; graphDiv.style.border='1px solid #eee'; graphDiv.style.borderRadius='10px'; graphDiv.style.margin='10px 0'; card.appendChild(graphDiv);
              try { const calc = Desmos.GraphingCalculator(graphDiv, { expressions:false }); (q.graph.expressions||[]).forEach(expr=> calc.setExpression(expr)); } catch{}
            }

            const opts = document.createElement('div'); opts.className='ps-opts'; card.appendChild(opts);
            const order = _.shuffle(q.options.map((opt, idx)=> ({opt, idx})));
            order.forEach(pair=>{
              const btn = document.createElement('button'); btn.type='button'; btn.className='ps-opt'; btn.textContent = pair.opt; btn.setAttribute('aria-pressed','false');
              btn.addEventListener('click', ()=>{
                if (btn.dataset.locked==='1') return;
                [...opts.children].forEach(ch=>{ ch.classList.remove('sel'); ch.setAttribute('aria-pressed','false'); });
                btn.classList.add('sel'); btn.setAttribute('aria-pressed','true');
                btn.dataset.chosen = pair.idx;
              });
              opts.appendChild(btn);
            });
            try { if (window.renderMathInElement) { renderMathInElement(opts, { delimiters:[{left:"$$", right:"$$", display:true},{left:"$", right:"$", display:false}] }); } } catch{}
            const submit = document.createElement('button'); submit.className='btn btn-primary'; submit.textContent='Submit';
            const next = document.createElement('button'); next.className='btn btn-secondary'; next.textContent='Next'; next.disabled = true; next.style.marginLeft='8px';
            const explain = document.createElement('div'); explain.className='ps-explain';
            submit.addEventListener('click', ()=>{
              const chosenBtn = [...opts.children].find(ch=> ch.classList.contains('sel'));
              if (!chosenBtn){ results.textContent='Please select an answer before submitting.'; results.style.color='#8B4513'; return; }
              const chosen = Number(chosenBtn.dataset.chosen);
              const correct = chosen === q.correct; if (correct) { correctCount++; }
              [...opts.children].forEach(ch=>{ ch.dataset.locked='1'; ch.disabled=true; ch.classList.add('locked'); });
              submit.disabled = true; next.disabled = false;
              explain.innerHTML = correct ? `<span style="color:#155e2b"><i class='bi bi-check-circle'></i> Correct.</span> ${q.explanation||''}` : `<span style=\"color:#991b1b\"><i class='bi bi-x-circle'></i> Incorrect.</span> ${q.explanation||''}`;
              // adapt difficulty
              if (correct){
                currentDifficulty = currentDifficulty==='easy' ? 'medium' : (currentDifficulty==='medium' ? 'hard' : 'hard');
              } else {
                currentDifficulty = currentDifficulty==='hard' ? 'medium' : (currentDifficulty==='medium' ? 'easy' : 'easy');
              }
            });
            next.addEventListener('click', ()=>{
              if (!next.disabled){
                step++;
                if (step < 10){ idxLabel.textContent = `${step+1} / 10`; renderOne(); }
                else {
                  const pct = correctCount / 10; results.innerHTML = `Score: ${Math.round(pct*100)}%`;
                  if (pct > scoreBest){ scoreBest = pct; saveProgress(`ps-best-${course.id}-${subtopic.id}-${lesson.slug}`, scoreBest); renderSidebar(); }
                }
              }
            });
            card.appendChild(submit); card.appendChild(next); card.appendChild(explain);
          }
          idxLabel.textContent = `1 / 10`;
          renderOne();
          body.appendChild(quiz);
        }
      }

      // Generate problems via Gemini when API key is available; otherwise throw
      async function generateProblemsForLesson(course, subtopic, lesson, count){
        const apiKey = getGeminiKey();
        if (!apiKey) throw new Error('No Gemini key');
        const endpoint = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;
        const topic = `${course.title} → ${subtopic.title} → ${lesson.title}`;
        const sys = `You are a math problem generator for middle/high school math. Output STRICT JSON only.`;
        const nonce = `${Date.now()}-${Math.floor(Math.random()*1e6)}`;
        const guidance = lessonGuidance(course, subtopic, lesson);
        const kws = [...buildKeywords(course, subtopic, lesson), ...lessonKeywords(course, subtopic, lesson)];
        const kw = kws.join(', ');
[-]        const user = `Seed: ${nonce}\nLessonTitle: "${lesson.title}"\nCreate ${count} multiple‑choice questions for this specific lesson: ${topic}.\nSTRICT SCOPE (must align; do NOT drift): ${guidance}.\nMUST INCORPORATE THESE KEYWORDS/CONCEPTS: ${kw}.\nRequirements:\n- Tag each problem with 'difficulty' ∈ {easy, medium, hard}; evenly distribute across difficulties.\n- Strong variation across forms: numeric computation, concise word problems, expression evaluation, equation solving, and (when applicable) graph interpretation/creation.\n- Vary constants/structures; avoid repeated templates; ensure each problem is clearly tied to the scope/keywords and LessonTitle.\n- Use LaTeX in stems/options/explanations where appropriate.\n- Provide 4 options; 'correct' is the index (0-3).\n- If graphing is relevant, include graph: { expressions: [{ id: 'g1', latex: 'y=x+1' }, ...] } (Desmos LaTeX).\nReturn STRICT JSON exactly: { "problems": [ { "stem": string, "options": [string,string,string,string], "correct": number, "explanation": string, "difficulty": "easy"|"medium"|"hard", "graph"?: { "expressions": [{"id": string, "latex": string}] } } ] } with NO prose.`;
        const body = { contents:[ { role:'user', parts:[ { text: sys + "\n\n" + user } ] } ] };
        const res = await fetch(endpoint, { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(body) });
        const j = await res.json();
        let txt = (((j||{}).candidates||[])[0]||{}).content; txt = (txt && txt.parts && txt.parts[0] && txt.parts[0].text) || '';
        const parsed = parseJsonFromText(txt);
        let probs = (parsed && Array.isArray(parsed.problems)) ? parsed.problems : [];
        // Hard filter to ensure association with the actual lesson keywords
        const hardKws = lessonKeywords(course, subtopic, lesson).map(s=> String(s).toLowerCase());
        if (hardKws.length){
          const filtered = probs.filter(p=> containsAnyKeyword(p, hardKws));
          if (filtered.length >= Math.min(count, 5)) probs = filtered; // keep if enough survive
        }
        // If still too few, try a second stricter attempt echoing the exact lesson title multiple times
        if (probs.length < Math.min(count, 5)){
          const strictUser = `Seed: ${nonce}-strict\nLessonTitle (repeat 3x): "${lesson.title}" — "${lesson.title}" — "${lesson.title}"\nGenerate ${count} MC questions ONLY about: ${lesson.title}. DO NOT include unrelated skills.\nScope: ${guidance}. Required keywords: ${kw}.\nReturn STRICT JSON { "problems": [ { "stem": string, "options": [string,string,string,string], "correct": number, "explanation": string, "difficulty": "easy"|"medium"|"hard" } ] } with NO prose.`;
          const strictBody = { contents:[ { role:'user', parts:[ { text: sys + "\n\n" + strictUser } ] } ] };
          const res2 = await fetch(endpoint, { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(strictBody) });
          const j2 = await res2.json();
          let txt2 = (((j2||{}).candidates||[])[0]||{}).content; txt2 = (txt2 && txt2.parts && txt2.parts[0] && txt2.parts[0].text) || '';
          const parsed2 = parseJsonFromText(txt2);
          const probs2 = (parsed2 && Array.isArray(parsed2.problems)) ? parsed2.problems : [];
          if (probs2.length) probs = probs2;
        }
        if (!probs.length) throw new Error('Bad Gemini response');
        // sanitize
        return probs.slice(0, count).map(p=>({ stem: String(p.stem||''), options: (p.options||[]).slice(0,4).map(String), correct: Number(p.correct||0), explanation: String(p.explanation||''), graph: p.graph && p.graph.expressions ? { expressions: p.graph.expressions } : undefined }));
      }

      

      function getGeminiKey(){
        try { if (window.TBP_GEMINI_API_KEY) return window.TBP_GEMINI_API_KEY; } catch{}
        try { const k = localStorage.getItem('tbp_gemini_key'); if (k) return k; } catch{}
        try { if (window.__TBP_GEMINI_API_KEY) return window.__TBP_GEMINI_API_KEY; } catch{}
        return '';
      }

      function lessonGuidance(course, subtopic, lesson){
        const t = `${(course&&course.title)||''} ${(subtopic&&subtopic.title)||''} ${(lesson&&lesson.title)||''}`.toLowerCase();
        if (t.includes('place value') || t.includes('rounding')) return 'Place value to millions and thousandths; rounding to given place; estimation sums/differences/products.';
        if (t.includes('integers')) return 'Integer addition, subtraction, multiplication, division; sign rules; order of operations with integers.';
        if (t.includes('absolute value')) return 'Absolute value as distance; compare integers/opposites; simple equations with |x|.';
        if (t.includes('properties')) return 'Commutative, associative, distributive properties; simplify expressions using properties.';
        if (t.includes('divisibility') || t.includes('prime')) return 'Divisibility tests (2,3,4,5,6,9,10); prime vs composite; prime factorization; factor trees.';
        if (t.includes('gcf')) return 'Find greatest common factor by prime factors or divisors; apply to simplify expressions and fractions.';
        if (t.includes('lcm')) return 'Least common multiple by listing or prime powers; common denominators; applications.';
        if (t.includes('equivalent fractions') || t.includes('simplifying')) return 'Equivalent fractions; reduce to simplest form; generate equivalents; compare fractions.';
        if (t.includes('add/subtract fractions')) return 'Add/subtract proper/improper and mixed numbers; common denominators; simplify results.';
        if (t.includes('multiply/divide fractions')) return 'Multiply/divide fractions and mixed numbers; reciprocals; cancel common factors; applications.';
        if (t.includes('word problems') && t.includes('fraction')) return 'Fraction word problems; part‑whole; multi‑step with mixed numbers; units.';
        if (t.includes('operations with decimals')) return 'Decimal addition/subtraction/multiplication/division; place value alignment; estimation.';
        if (t.includes('convert fractions') || t.includes('decimals')) return 'Convert fractions↔decimals via division/termination/repeating; compare and order.';
        if (t.includes('percent of a number')) return 'Percent of a number; find part/whole/percent; multi‑step contexts.';
        if (t.includes('discount') || t.includes('percent change')) return 'Markup/markdown, tax, tip; percent increase/decrease; multi‑step.';
        if (t.includes('simple interest')) return 'Simple interest I=Prt; compute interest and total; units and time conversion.';
        if (t.includes('unit rate') || t.includes('ratios')) return 'Ratios, rates, unit rate; equivalent ratios; word problems; scaling.';
        if (t.includes('proportional') || t.includes('proportions')) return 'Proportional relationships; tables; constant of proportionality; solve proportions.';
        if (t.includes('scale drawings') || t.includes('maps')) return 'Scale factors; map distances; convert between actual and scaled measurements.';
        if (t.includes('variables') || t.includes('evaluating expressions')) return 'Substitute values; evaluate expressions; use order of operations.';
        if (t.includes('combining like terms')) return 'Combine like terms; coefficients; simplify multi‑term expressions; distribute then combine.';
        if (t.includes('distributive')) return 'Apply a(b+c)=ab+ac; factor simple expressions; mental math with distributive property.';
        if (t.includes('writing expressions')) return 'Translate phrases to algebraic expressions; identify operation words; structure.';
        if (t.includes('one-step equations')) return 'Solve one‑step linear equations with integers/fractions/decimals; check solutions.';
        if (t.includes('two-step equations')) return 'Solve two‑step linear equations; inverse operations; check solutions.';
        if (t.includes('inequalities')) return 'Solve one‑step inequalities; graph on number line; open/closed circles; test points.';
        if (t.includes('pemdas')) return 'Order of operations with integers/fractions/decimals; nested parentheses.';
        if (t.includes('integer exponents')) return 'Squares, cubes; exponent rules (intro); evaluate simple powers.';
        if (t.includes('roots')) return 'Square/cube roots conceptually; perfect squares/cubes; estimate roots.';
        if (t.includes('scientific notation')) return 'Write/interpret scientific notation; convert standard↔scientific; operations (intro).';
        if (t.includes('points, lines, angles')) return 'Angle types and measures; complementary/supplementary/vertical; compute unknowns.';
        if (t.includes('triangles') || t.includes('quadrilaterals')) return 'Classify triangles/quadrilaterals; interior angle sums; missing angles.';
        if (t.includes('perimeter & area') || t.includes('area') || t.includes('perimeter')) return 'Perimeter and area of rectangles, triangles, parallelograms, circles; composite figures.';
        if (t.includes('surface') || t.includes('volume')) return 'Surface area and volume of rectangular prisms and intro cylinders; nets.';
        if (t.includes('pythagorean')) return 'Pythagorean theorem; find missing side; simple applications on grid.';
        if (t.includes('plotting points')) return 'Plot in all quadrants; identify coordinates; reflect across axes.';
        if (t.includes('tables → graphs') || t.includes('pattern')) return 'From tables to graphs; identify linear patterns; describe rules.';
        if (t.includes('arithmetic sequences')) return 'Arithmetic sequences; common difference; nth term (intro).';
        if (t.includes('mean, median, mode')) return 'Compute mean/median/mode/range; interpret; outliers effect.';
        if (t.includes('dot plots') || t.includes('histograms') || t.includes('box plots')) return 'Create/read dot plots, histograms, box plots; compare distributions.';
        if (t.includes('theoretical') || t.includes('experimental probability')) return 'Compute simple probabilities; fractions/percents; run experiments vs theory.';
        if (t.includes('compound probability')) return 'Independent events; product rule; simple tree diagrams.';
        if (t.includes('customary') || t.includes('metric')) return 'Unit identification and conversions within systems; relative sizes.';
        if (t.includes('unit conversions') || t.includes('dimensional')) return 'Unit conversions via dimensional analysis; set up conversion factors.';
        if (t.includes('rates as “per”') || t.includes('rates as "per"')) return 'Interpret per units (mph, $/lb, etc.); compute totals and rates.';
        return 'Create varied problems matching this lesson topic with appropriate coverage.';
      }

      function buildKeywords(course, subtopic, lesson){
        const parts = [];
        try { if (course && course.title) parts.push(course.title); } catch{}
        try { if (subtopic && subtopic.title) parts.push(subtopic.title); } catch{}
        try { if (lesson && lesson.title) parts.push(lesson.title); } catch{}
        try { if (lesson && lesson.slug) parts.push(String(lesson.slug).replace(/[-_]/g,' ')); } catch{}
        return parts.map(s=> String(s).toLowerCase());
      }

      function lessonKeywords(course, subtopic, lesson){
        const title = ((lesson&&lesson.title)||'').toLowerCase();
        const st = ((subtopic&&subtopic.title)||'').toLowerCase();
        const out = [];
        if (title.includes('properties') || st.includes('expressions')){
          out.push('commutative','associative','distributive','rearrange','grouping','a(b+c)=ab+ac','ab+ac','factor','like terms','a+b=b+a','(a+b)+c=a+(b+c)');
        }
        if (title.includes('gcf') || st.includes('gcf') || title.includes('greatest common factor')){
          out.push('gcf','greatest common factor','common factor','prime factorization','gcd');
        }
        if (title.includes('lcm') || st.includes('lcm') || title.includes('least common multiple')){
          out.push('lcm','least common multiple','multiples','common multiple','prime powers');
        }
        if (title.includes('divisibility') || st.includes('divisibility') || title.includes('prime')){
          out.push('divisible by','divisibility','prime','composite','factor');
        }
        if (title.includes('unit rate') || st.includes('ratios')){
          out.push('ratio','unit rate','proportion','constant of proportionality');
        }
        if (title.includes('plot') || title.includes('coordinate')){
          out.push('quadrants','ordered pair','(x,y)','graph');
        }
        return out;
      }

      function containsAnyKeyword(problem, kws){
        const blob = `${problem.stem||''} ${(problem.explanation||'')} ${((problem.options||[]).join(' '))}`.toLowerCase();
        return kws.some(k=> blob.includes(k));
      }

      function parseJsonFromText(t){
        if (!t) return null;
        // try fenced block
        const m = t.match(/```json\s*([\s\S]*?)```/i) || t.match(/\{[\s\S]*\}$/);
        let raw = m ? (m[1] || m[0]) : t;
        try { return JSON.parse(raw); } catch { return null; }
      }

      function fallbackProblems(lesson, count){
        const out = [];
        const slug = (lesson && lesson.slug || '').toLowerCase();
        function rand(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }
        function choice(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
        function shuffle(arr){ return arr.map(v=>({v, r:Math.random()})).sort((a,b)=>a.r-b.r).map(x=>x.v); }
        function gcd(x,y){ x=Math.abs(x); y=Math.abs(y); while(y){ const t=x%y; x=y; y=t; } return x; }
        function lcm(x,y){ return Math.abs(x*y)/gcd(x,y); }
        function isPrime(n){ if (n<2) return false; for (let p=2;p*p<=n;p++){ if(n%p===0) return false; } return true; }
        function primeFactors(n){ const f=[]; let d=2; let m=n; while(d*d<=m){ while(m%d===0){ f.push(d); m/=d; } d++; } if(m>1) f.push(m); return f; }

        // Registry of lesson-specific generators
        const gen = {
          'properties': (k)=>{ // commutative/associative/distributive
            const arr=[]; for(let i=0;i<k;i++){
              const type = i<k/3? 'comm' : i< 2*k/3? 'assoc':'dist';
              if (type==='comm'){
                const a=rand(2,9), b=rand(2,9);
                const opts = shuffle([`$${a}+${b}=${b}+${a}$`,`$${a}+( ${b}+1 )=${a}+${b}+1$`,`$${a}( ${b}+1 )=${a}b+${a}$`,`$(${a}+${b})+1=${a}+( ${b}+1 )$`]);
                arr.push({ stem:`Which equation shows the commutative property of addition?`, options:opts, correct: opts.indexOf(`$${a}+${b}=${b}+${a}$`), explanation:`Commutative: order changes, value same: $a+b=b+a$.`, difficulty: i<k/3?'easy': i<2*k/3?'medium':'hard' });
              } else if (type==='assoc'){
                const a=rand(2,9), b=rand(2,9), c=rand(2,9);
                const opts = shuffle([`$(${a}+${b})+${c}=${a}+(${b}+${c})$`,`$${a}+${b}=${b}+${a}$`,`$${a}( ${b}+${c} )=${a}b+${a}c$`,`$(${a}\cdot${b})\cdot${c}=${a}\cdot(${b}\cdot${c})$`]);
                const corr = opts.findIndex(t=> t.includes(`(${a}+${b})+${c}`)|| t.includes(`${a}\cdot(${b}\cdot${c})`));
                arr.push({ stem:`Which shows the associative property?`, options:opts, correct:corr, explanation:`Associative: grouping changes, order same.`, difficulty: i<k/3?'easy': i<2*k/3?'medium':'hard' });
              } else {
                const a=rand(2,7), b=rand(2,7), c=rand(2,7);
                const opts = shuffle([`$${a}( ${b}+${c} )=${a*b}+${a*c}$`,`$(${a}+${b})+${c}=${a}+(${b}+${c})$`,`$${a}+${b}=${b}+${a}$`,`$${a}( ${b}+${c} )=${a}+${b}+${c}$`]);
                arr.push({ stem:`Apply the distributive property to $${a}(${b}+${c})$.`, options:opts, correct: opts.indexOf(`$${a}( ${b}+${c} )=${a*b}+${a*c}$`), explanation:`Distributive: $a(b+c)=ab+ac$.`, difficulty: i<k/3?'easy': i<2*k/3?'medium':'hard' });
              }
            } return arr; },

          'prime-factorization': (k)=>{ const arr=[]; for(let i=0;i<k;i++){ const n=rand(20,150); const pf=primeFactors(n); const stem=`Prime factorization of $${n}$ is`; const corr = `$${pf.map(p=>p).join('\n\cdot ')}$`.replace(/\n/g,''); const opts = shuffle([corr,`$${n}$`,`$${pf.join('+')}$`,`$${pf.join('-')}$`]); arr.push({ stem, options:opts, correct: opts.indexOf(corr), explanation:`Factor until primes: $${corr}$.`, difficulty: i<k/3?'easy': i<2*k/3?'medium':'hard' }); } return arr; },

          'gcf': (k)=>{ const arr=[]; for(let i=0;i<k;i++){ const a=rand(10,80), b=rand(10,80); const ans=gcd(a,b); const opts = shuffle([ans, ans+rand(1,4), Math.max(ans-rand(1,4),1), rand(2,9)]).map(v=>`$${v}$`); arr.push({ stem:`Find $\\operatorname{GCF}(${a},${b})$.`, options:opts, correct: opts.indexOf(`$${ans}$`), explanation:`$\\gcd(${a},${b})=${ans}$.`, difficulty: i<k/3?'easy': i<2*k/3?'medium':'hard' }); } return arr; },

          'lcm': (k)=>{ const arr=[]; for(let i=0;i<k;i++){ const a=rand(2,15), b=rand(2,15); const ans=lcm(a,b); const opts = shuffle([ans, ans+rand(1,5), Math.max(ans-rand(1,5),1), ans*2]).map(v=>`$${v}$`); arr.push({ stem:`Find $\\operatorname{LCM}(${a},${b})$.`, options:opts, correct: opts.indexOf(`$${ans}$`), explanation:`$\\mathrm{lcm}(a,b)=\\dfrac{ab}{\\gcd(a,b)}=${ans}$.`, difficulty: i<k/3?'easy': i<2*k/3?'medium':'hard' }); } return arr; },

          'equivalent-simplifying': (k)=>{ const arr=[]; for(let i=0;i<k;i++){ const a=rand(2,12), b=a*rand(2,10); const g=gcd(b,a); const num=b/g, den=a/g; const opts=shuffle([`$\\dfrac{${num}}{${den}}$`,`$\\dfrac{${num+1}}{${den}}$`,`$\\dfrac{${num}}{${den+1}}$`,`$\\dfrac{${num-1}}{${den-1}}$`]); arr.push({ stem:`Simplify $\\dfrac{${b}}{${a}}$.`, options:opts, correct: opts.indexOf(`$\\dfrac{${num}}{${den}}$`), explanation:`Divide numerator and denominator by GCF.`, difficulty: i<k/3?'easy': i<2*k/3?'medium':'hard' }); } return arr; },

          'add-subtract-fractions': (k)=>{ const arr=[]; for(let i=0;i<k;i++){ const a=rand(1,9), b=rand(2,9), c=rand(1,9), d=rand(2,9); const stem = i%2===0? `$\\dfrac{${a}}{${b}}+\\dfrac{${c}}{${d}}$`:`$\\dfrac{${a}}{${b}}-\\dfrac{${c}}{${d}}$`; const num = i%2===0? a*d + c*b : a*d - c*b; const den=b*d; const g=gcd(Math.abs(num),den); const snum=num/g, sden=den/g; const corr = `$\\dfrac{${snum}}{${sden}}$`; const opts=shuffle([corr,`$\\dfrac{${snum+1}}{${sden}}$`,`$\\dfrac{${snum}}{${sden+1}}$`,`$\\dfrac{${snum-1}}{${sden-1}}$`]); arr.push({ stem:`Compute ${stem}.`, options:opts, correct: opts.indexOf(corr), explanation:`Common denominator $${den}$; simplify.`, difficulty: i<k/3?'easy': i<2*k/3?'medium':'hard' }); } return arr; },

          'multiply-divide-fractions': (k)=>{ const arr=[]; for(let i=0;i<k;i++){ const a=rand(1,9), b=rand(2,9), c=rand(1,9), d=rand(2,9); const mult = i%2===0; const stem = mult? `$\\dfrac{${a}}{${b}}\\cdot\\dfrac{${c}}{${d}}$`:`$\\dfrac{${a}}{${b}}\\div\\dfrac{${c}}{${d}}$`; const num = mult? a*c : a*d; const den = mult? b*d : b*c; const g=gcd(num,den); const corr=`$\\dfrac{${num/g}}{${den/g}}$`; const opts = shuffle([corr,`$\\dfrac{${num/g+1}}{${den/g}}$`,`$\\dfrac{${num/g}}{${den/g+1}}$`,`$\\dfrac{${num/g-1}}{${den/g-1}}$`]); arr.push({ stem:`Compute ${stem}.`, options:opts, correct: opts.indexOf(corr), explanation:`Multiply (or invert & multiply), then simplify.`, difficulty: i<k/3?'easy': i<2*k/3?'medium':'hard' }); } return arr; },

          'convert-percent': (k)=>{ const arr=[]; for(let i=0;i<k;i++){ const p=rand(5,95); const corr = `$${(p/100).toFixed(2)}$`; const opts=shuffle([corr,`$${p}$`,`$${p*100}$`,`$${(100/p).toFixed(2)}$`]); arr.push({ stem:`Convert $${p}\\%$ to a decimal.`, options:opts, correct: opts.indexOf(corr), explanation:`Divide by $100$.`, difficulty: i<k/3?'easy': i<2*k/3?'medium':'hard' }); } return arr; },
          'percent-of-number': (k)=>{ const arr=[]; for(let i=0;i<k;i++){ const p=rand(5,80), n=rand(20,200); const ans = Math.round(n*p)/100; const corr=`$${ans}$`; const opts=shuffle([corr,`$${(ans+5)}$`,`$${(ans-5)}$`,`$${(ans*2)}$`]); arr.push({ stem:`Find $${p}\\%$ of $${n}$.`, options:opts, correct: opts.indexOf(corr), explanation:`$${p}\\%=\\dfrac{${p}}{100}$; multiply by ${n}.`, difficulty: i<k/3?'easy': i<2*k/3?'medium':'hard' }); } return arr; },
          'discount-tax-tip-change': (k)=>{ const arr=[]; for(let i=0;i<k;i++){ const price=rand(20,200); const rate=[5,8,10,12,15,20][rand(0,5)]; const type=choice(['discount','tax','tip','percent change']); let stem, ans; if (type==='discount'){ stem=`A $${price}$ item has a ${rate}\\% discount. Find the sale price.`; ans = +(price*(1-rate/100)).toFixed(2);} else if (type==='tax'){ stem=`A $${price}$ item has ${rate}\\% sales tax. Find the total price.`; ans = +(price*(1+rate/100)).toFixed(2);} else if (type==='tip'){ stem=`A bill of $${price}$ with a ${rate}\\% tip. Find the total.`; ans = +(price*(1+rate/100)).toFixed(2);} else { const newP=rand(10,300); stem=`From $${price}$ to $${newP}$: percent change?`; ans = +((newP-price)/price*100).toFixed(1);} const corr=`$${ans}$`; const opts=shuffle([corr,`$${(ans+5)}$`,`$${(ans-5)}$`,`$${(ans*2)}$`]); arr.push({ stem, options:opts, correct: opts.indexOf(corr), explanation:`Apply percent formula.`, difficulty: i<k/3?'easy': i<2*k/3?'medium':'hard' }); } return arr; },

          'simple-interest-intro': (k)=>{ const arr=[]; for(let i=0;i<k;i++){ const P=rand(100,1000), r=[0.03,0.04,0.05][rand(0,2)], t=rand(1,5); const I=+(P*r*t).toFixed(2); const A=+(P+I).toFixed(2); const kind=i%2===0; const corr= kind? `$${I}$`:`$${A}$`; const opts=shuffle([corr,`$${(I+10).toFixed(2)}$`,`$${(A+10).toFixed(2)}$`,`$${(P).toFixed(2)}$`]); arr.push({ stem: kind? `Find simple interest $I$ for $P=${P}$, $r=${(r*100)}\\%$, $t=${t}$ yrs.`:`Find amount $A$ after $t=${t}$ yrs at $${(r*100)}\\%$ on $P=${P}$.`, options:opts, correct: opts.indexOf(corr), explanation:`$I=Prt$, $A=P+I$.`, difficulty: i<k/3?'easy': i<2*k/3?'medium':'hard' }); } return arr; },

          'ratios-unit-rate': (k)=>{ const arr=[]; for(let i=0;i<k;i++){ const a=rand(2,20), b=rand(2,10); const unit=(a/b).toFixed(2); const corr=`$${unit}$`; const opts=shuffle([corr,`$${(a/(b+1)).toFixed(2)}$`,`$${(a/(b-1)).toFixed(2)}$`,`$${(a*b).toFixed(2)}$`]); arr.push({ stem:`Unit rate of $${a}$ for $${b}$ units?`, options:opts, correct: opts.indexOf(corr), explanation:`Divide: $a/b$.`, difficulty: i<k/3?'easy': i<2*k/3?'medium':'hard' }); } return arr; },
          'proportional-relationships': (k)=>{ const arr=[]; for(let i=0;i<k;i++){ const k0=rand(2,9); const x=rand(2,12); const y=k0*x; const corr=`$${k0}$`; const opts=shuffle([corr,`$${k0+1}$`,`$${k0-1}$`,`$${k0+2}$`]); arr.push({ stem:`If $y=kx$ and $(x,y)=(${x},${y})$, find $k$.`, options:opts, correct: opts.indexOf(corr), explanation:`$k=y/x=${y}/${x}=${k0}$.`, difficulty: i<k/3?'easy': i<2*k/3?'medium':'hard' }); } return arr; },
          'scale-drawings': (k)=>{ const arr=[]; for(let i=0;i<k;i++){ const scale=`1:${choice([2,3,4,5,10])}`; const d=rand(3,20); const s=parseInt(scale.split(':')[1]); const ans=d*s; const corr=`$${ans}$`; const opts=shuffle([corr,`$${ans+s}$`,`$${ans-s}$`,`$${d}$`]); arr.push({ stem:`Scale ${scale}. If drawing length is $${d}$ cm, actual length?`, options:opts, correct: opts.indexOf(corr), explanation:`Multiply by scale factor ${s}.`, difficulty: i<k/3?'easy': i<2*k/3?'medium':'hard' }); } return arr; },
          'constant-of-prop': (k)=>{ const arr=[]; for(let i=0;i<k;i++){ const k0=rand(2,9); const x=rand(2,12); const y=k0*x; const corr=`$y= ${k0}x$`; const opts=shuffle([corr,`$y=${k0+x}$`,`$y=${k0}x+1$`,`$y=\\dfrac{x}{${k0}}$`]); arr.push({ stem:`Find the constant of proportionality and equation through $(0,0)$ and $(${x},${y})$.`, options:opts, correct: opts.indexOf(corr), explanation:`$k=y/x=${k0}$ so $y=kx$.`, difficulty: i<k/3?'easy': i<2*k/3?'medium':'hard' }); } return arr; },

          'variables-evaluating': (k)=>{ const arr=[]; for(let i=0;i<k;i++){ const a=rand(1,6), b=rand(1,6), x=rand(1,6); const expr = i%2? `${a}x+${b}`:`${a}x-${b}`; const ans = i%2? a*x+b : a*x-b; const corr=`$${ans}$`; const opts=shuffle([corr,`$${ans+1}$`,`$${ans-1}$`,`$${ans+2}$`]); arr.push({ stem:`Evaluate $${expr}$ for $x=${x}$.`, options:opts, correct: opts.indexOf(corr), explanation:`Substitute $x$ then compute.`, difficulty: i<k/3?'easy': i<2*k/3?'medium':'hard' }); } return arr; },
          'combining-like-terms': (k)=>{ const arr=[]; for(let i=0;i<k;i++){ const a=rand(1,6), b=rand(1,6), c=rand(1,6), d=rand(1,6); const ans=(a+c)+'x+'+(b+d); const corr=`$${ans}$`; const opts=shuffle([corr,`$${a}x+${b}$`,`$${c}x+${d}$`,`$${a+c}x+${b+d+1}$`]); arr.push({ stem:`Simplify $${a}x+${b}+${c}x+${d}$.`, options:opts, correct: opts.indexOf(corr), explanation:`Combine $x$ terms and constants.`, difficulty: i<k/3?'easy': i<2*k/3?'medium':'hard' }); } return arr; },
          'distributive-property': (k)=> gen['properties'](k),

          'one-step-equations': (k)=>{ const arr=[]; for(let i=0;i<k;i++){ const a=rand(2,12), x=rand(-10,10), b=a*x; const forms=[`${a}x=${b}`,`x+${a}=${a+x}`,`x-${a}=${x-a}`]; const form=choice(forms); const corr=`$${x}$`; const opts=shuffle([corr,`$${x+1}$`,`$${x-1}$`,`$${x+2}$`]); arr.push({ stem:`Solve $${form}$.`, options:opts, correct: opts.indexOf(corr), explanation:`Inverse operations.`, difficulty: i<k/3?'easy': i<2*k/3?'medium':'hard' }); } return arr; },
          'two-step-equations': (k)=>{ const arr=[]; for(let i=0;i<k;i++){ const m=rand(2,6), x=rand(-10,10), b=rand(1,10); const y=m*x+b; const corr=`$${x}$`; const forms=[`${m}x+${b}=${y}`,`${m}x-${b}=${y-2*b}`]; const form=choice(forms); const opts=shuffle([corr,`$${x+1}$`,`$${x-1}$`,`$${x+2}$`]); arr.push({ stem:`Solve $${form}$.`, options:opts, correct: opts.indexOf(corr), explanation:`Undo add/sub then divide.`, difficulty: i<k/3?'easy': i<2*k/3?'medium':'hard' }); } return arr; },
          'one-step-inequalities': (k)=>{ const arr=[]; for(let i=0;i<k;i++){ const a=rand(2,12), x=rand(-8,8); const b=a*x; const form = i%2? `x+${a}\\le ${a+x}`:`${a}x> ${b}`; const corr=`$x${i%2? '\\le '+x:'> '+x}$`; const opts=shuffle([corr,`$x<${x}$`,`$x\\ge ${x+1}$`,`$x\\le ${x-1}$`]); arr.push({ stem:`Solve ${form}$.`, options:opts, correct: opts.indexOf(corr), explanation:`Treat like equations; flip when dividing by negative.`, difficulty: i<k/3?'easy': i<2*k/3?'medium':'hard' }); } return arr; },

          'integer-exponents': (k)=>{ const arr=[]; for(let i=0;i<k;i++){ const a=rand(2,6), b=rand(2,6); const type=i%3; if(type===0){ const corr=`$${a**b}$`; const opts=shuffle([corr,`$${a**(b-1)}$`,`$${(a+1)**b}$`,`$${a**(b+1)}$`]); arr.push({ stem:`Evaluate $${a}^{${b}}$.`, options:opts, correct: opts.indexOf(corr), explanation:`Power definition.`, difficulty: i<k/3?'easy': i<2*k/3?'medium':'hard' }); } else if (type===1){ const m=rand(2,5), n=rand(2,5); const corr=`$a^{${m+n}}$`; const opts=shuffle([corr,`$a^{${m\*n}}$`,`$a^{${m-n}}$`,`$a^{${m}}$`]); arr.push({ stem:`Simplify $a^{${m}}\cdot a^{${n}}$.`, options:opts, correct: opts.indexOf(corr), explanation:`Add exponents with same base.`, difficulty: i<k/3?'easy': i<2*k/3?'medium':'hard' }); } else { const m=rand(2,5), n=rand(2,5); const corr=`$a^{${m*n}}$`; const opts=shuffle([corr,`$a^{${m+n}}$`,`$a^{${m-n}}$`,`$a^{${m}}$`]); arr.push({ stem:`Simplify $(a^{${m}})^{${n}}$.`, options:opts, correct: opts.indexOf(corr), explanation:`Multiply exponents.`, difficulty: i<k/3?'easy': i<2*k/3?'medium':'hard' }); } } return arr; },
          'scientific-notation-intro': (k)=>{ const arr=[]; for(let i=0;i<k;i++){ const m=+(rand(10,99)/10).toFixed(1), e=rand(1,6); const N=m*10**e; const corr=`$${m}\\times 10^{${e}}$`; const opts=shuffle([corr,`$${(m/10).toFixed(1)}\\times 10^{${e+1}}$`,`$${(m*10).toFixed(1)}\\times 10^{${e-1}}$`,`$${N}$`]); arr.push({ stem:`Write $${N}$ in scientific notation.`, options:opts, correct: opts.indexOf(corr), explanation:`Move decimal to $[1,10)$ and adjust power.`, difficulty: i<k/3?'easy': i<2*k/3?'medium':'hard' }); } return arr; },

          'plotting-points': (k)=>{ const arr=[]; for(let i=0;i<k;i++){ const x=rand(-5,5), y=rand(-5,5); const corr=`$(${x},${y})$`; const opts=shuffle([corr,`$(${y},${x})$`,`$(${x},${-y})$`,`$(${y},${-x})$`]); arr.push({ stem:`Which point is shown?`, options:opts, correct: opts.indexOf(corr), explanation:`(x,y).`, difficulty: i<k/3?'easy': i<2*k/3?'medium':'hard', graph:{ expressions:[{ id:'p', latex:`(x-${x})^2+(y-${y})^2=0` }] } }); } return arr; },
          'tables-graphs': (k)=>{ const arr=[]; for(let i=0;i<k;i++){ const m=rand(1,4), b=rand(-3,3); const x=rand(0,5); const y=m*x+b; const corr=`$y=${m}x${b>=0?'+':''}${b}$`; const opts=shuffle([corr,`$y=${m+1}x${b>=0?'+':''}${b}$`,`$y=${m}x${b+1>=0?'+':''}${b+1}$`,`$y=x$`]); arr.push({ stem:`A table follows $y=${m}x${b>=0?'+':''}${b}$. Which equation matches the graph?`, options:opts, correct: opts.indexOf(corr), explanation:`Identify slope/intercept.`, difficulty: i<k/3?'easy': i<2*k/3?'medium':'hard' }); } return arr; },
          'arithmetic-sequences-intro': (k)=>{ const arr=[]; for(let i=0;i<k;i++){ const a1=rand(1,9), d=rand(1,5), n=rand(4,10); const an=a1+(n-1)*d; const corr=`$${an}$`; const opts=shuffle([corr,`$${an+d}$`,`$${an-d}$`,`$${a1+n}$`]); arr.push({ stem:`For $a_1=${a1}$, $d=${d}$, find $a_${n}$.`, options:opts, correct: opts.indexOf(corr), explanation:`$a_n=a_1+(n-1)d$.`, difficulty: i<k/3?'easy': i<2*k/3?'medium':'hard' }); } return arr; },
          'mmm-range': (k)=>{ const arr=[]; for(let i=0;i<k;i++){ const data=shuffle([rand(1,20),rand(1,20),rand(1,20),rand(1,20),rand(1,20)]); const sorted=[...data].sort((a,b)=>a-b); const mean=(data.reduce((s,x)=>s+x,0)/data.length).toFixed(1); const med=sorted[2]; const mode=choice(data); const range=sorted[4]-sorted[0]; const ask=choice(['mean','median','mode','range']); let corr; if (ask==='mean') corr=`$${mean}$`; else if (ask==='median') corr=`$${med}$`; else if (ask==='mode') corr=`$${mode}$`; else corr=`$${range}$`; const opts=shuffle([corr,`$${Number(mean)+1}$`,`$${med+1}$`,`$${range+1}$`]); arr.push({ stem:`For data ${data.join(', ')}, find the ${ask}.`, options:opts, correct: opts.indexOf(corr), explanation:`Compute requested statistic.`, difficulty: i<k/3?'easy': i<2*k/3?'medium':'hard' }); } return arr; },
          'theoretical-vs-experimental': (k)=>{ const arr=[]; for(let i=0;i<k;i++){ const faces=6; const trials=rand(20,60); const exp=rand(5,15); const theo=1/6; const ask=choice(['theoretical','experimental']); const corr = ask==='theoretical'? `$${theo.toFixed(2)}$`:`$${(exp/trials).toFixed(2)}$`; const opts=shuffle([corr,`$${(1/4).toFixed(2)}$`,`$${(1/3).toFixed(2)}$`,`$${(1/2).toFixed(2)}$`]); arr.push({ stem:`A die is rolled ${trials} times and a "3" occurs ${exp} times. What is the ${ask} probability of a 3?`, options:opts, correct: opts.indexOf(corr), explanation:`Theoretical: $1/6$; Experimental: successes/trials.`, difficulty: i<k/3?'easy': i<2*k/3?'medium':'hard' }); } return arr; },
          'compound-probability': (k)=>{ const arr=[]; for(let i=0;i<k;i++){ const p1=rand(1,5)/6, p2=rand(1,5)/6; const corr = `$${(p1*p2).toFixed(2)}$`; const opts=shuffle([corr,`$${(p1+p2).toFixed(2)}$`,`$${Math.max(p1,p2).toFixed(2)}$`,`$${(p1*p2*2).toFixed(2)}$`]); arr.push({ stem:`Two independent events with $P(A)=${p1.toFixed(2)}$, $P(B)=${p2.toFixed(2)}$. Find $P(A\\cap B)$.`, options:opts, correct: opts.indexOf(corr), explanation:`Independent: multiply.`, difficulty: i<k/3?'easy': i<2*k/3?'medium':'hard' }); } return arr; },
          'unit-conversions': (k)=>{ const arr=[]; const conv=[['in','ft',12],['ft','yd',3],['cm','m',100],['g','kg',1000]]; for(let i=0;i<k;i++){ const [u1,u2,f]=choice(conv); const a=rand(2,50); const ans = u1==='in'&&u2==='ft'? +(a/12).toFixed(2) : u1==='ft'&&u2==='yd'? +(a/3).toFixed(2) : u1==='cm'&&u2==='m'? +(a/100).toFixed(2) : +(a/1000).toFixed(2); const corr=`$${ans}$`; const opts=shuffle([corr,`$${(ans+1)}$`,`$${(ans-1)}$`,`$${(ans*2)}$`]); arr.push({ stem:`Convert $${a}\\ ${u1}$ to ${u2}.`, options:opts, correct: opts.indexOf(corr), explanation:`Use conversion factor ${f}.`, difficulty: i<k/3?'easy': i<2*k/3?'medium':'hard' }); } return arr; },
          'rates-per': (k)=>{ const arr=[]; for(let i=0;i<k;i++){ const miles=rand(30,300), hours=rand(1,6); const mph=+(miles/hours).toFixed(1); const corr=`$${mph}$`; const opts=shuffle([corr,`$${mph+1}$`,`$${mph-1}$`,`$${mph+5}$`]); arr.push({ stem:`A car travels ${miles} miles in ${hours} hours. What is the speed (mph)?`, options:opts, correct: opts.indexOf(corr), explanation:`Rate = distance/time.`, difficulty: i<k/3?'easy': i<2*k/3?'medium':'hard' }); } return arr; }
        };

        // If a dedicated generator exists for the lesson slug, use it
        if (gen[slug]) return gen[slug](count);
        for (let i=0;i<count;i++){
          if (slug.includes('lcm')){
            const a = rand(2,15), b = rand(2,15);
            const ans = lcm(a,b);
            const opts = _.shuffle([ans, ans+rand(1,5), Math.max(ans-rand(1,5),1), ans*2]).map(v=> `$${v}$`);
            out.push({ stem:`Find $\\operatorname{LCM}(${a},${b})$.`, options: opts, correct: opts.indexOf(`$${ans}$`), explanation:`Prime powers or $\\mathrm{lcm}(a,b)=\\dfrac{ab}{\\gcd(a,b)}=\\dfrac{${a}\\cdot${b}}{${gcd(a,b)}}=${ans}$.`, difficulty: i< count/3?'easy': i< 2*count/3?'medium':'hard' });
            continue;
          }
          if (slug.includes('gcf')){
            const a = rand(10,60), b = rand(10,60);
            const ans = gcd(a,b);
            const opts = _.shuffle([ans, ans+rand(1,4), Math.max(ans-rand(1,4),1), rand(2,9)]).map(v=> `$${v}$`);
            out.push({ stem:`Find $\\operatorname{GCF}(${a},${b})$.`, options: opts, correct: opts.indexOf(`$${ans}$`), explanation:`Common factors; $\\gcd(${a},${b})=${ans}$.`, difficulty: i< count/3?'easy': i< 2*count/3?'medium':'hard' });
            continue;
          }
          if (slug.includes('divisibility-prime-composite')){
            const n = rand(10,150);
            const qtype = rand(0,1);
            if (qtype===0){
              const d = [2,3,4,5,6,9,10][rand(0,6)];
              const isDiv = n%d===0;
              const opts = isDiv ? ['Yes','No','Only if even','Only if odd'] : ['No','Yes','Only if even','Only if odd'];
              out.push({ stem:`Is $${n}$ divisible by $${d}$?`, options: opts, correct: isDiv?0:1, explanation:`Check divisibility rule for ${d}.`, difficulty: i< count/3?'easy': i< 2*count/3?'medium':'hard' });
            } else {
              // prime vs composite (simple heuristic)
              function isPrime(k){ if (k<2) return false; for (let p=2;p*p<=k;p++){ if (k%p===0) return false; } return true; }
              const prime = isPrime(n);
              const opts = ['Prime','Composite','Even','Odd'];
              out.push({ stem:`Is $${n}$ prime or composite?`, options: opts, correct: prime?0:1, explanation:`${n} is ${prime?'prime (no factors besides 1 and itself)':'composite (has other factors)'} .`, difficulty: i< count/3?'easy': i< 2*count/3?'medium':'hard' });
            }
            continue;
          }
          if (slug.includes('place-value')){
            const n = rand(1000,999999);
            const place = ['nearest ten','nearest hundred','nearest thousand'][rand(0,2)];
            const rounded = place==='nearest ten'? Math.round(n/10)*10 : place==='nearest hundred'? Math.round(n/100)*100 : Math.round(n/1000)*1000;
            out.push({ stem:`Round $${n}$ to the ${place}.`, options:[`$${rounded}$`,`$${rounded+ (place==='nearest ten'?10:place==='nearest hundred'?100:1000)}$`,`$${rounded-(place==='nearest ten'?10:place==='nearest hundred'?100:1000)}$`,`$${rounded + (place==='nearest ten'?5:place==='nearest hundred'?50:500)}$`], correct:0, explanation:`Rounding to the ${place} gives $${rounded}$.`, difficulty: i< count/3?'easy': i< 2*count/3?'medium':'hard' });
          } else if (slug.includes('integer-operations')){
            const a = rand(-20,20), b = rand(-20,20); const op = ['+','-','×','÷'][rand(0,3)];
            let ans; if (op==='+') ans=a+b; else if (op==='-') ans=a-b; else if (op==='×') ans=a*b; else { const bb = b||1; ans = Math.trunc(a/bb); }
            const opts = [ans, ans+1, ans-1, ans+2].map(v=> `$${v}$`);
            out.push({ stem:`Compute $${a} ${op} ${b}$.`, options: _.shuffle(opts), correct:0, explanation:`$= ${ans}$`, difficulty: i< count/3?'easy': i< 2*count/3?'medium':'hard' });
          } else if (slug.includes('absolute-value')){
            const a = rand(-15,15); const ans = Math.abs(a);
            out.push({ stem:`Evaluate $|${a}|$.`, options:[`$${ans}$`,`$${-ans}$`,`$${ans+1}$`,`$${ans-1}$`], correct:0, explanation:`Distance from 0 is $${ans}$.`, difficulty: i< count/3?'easy': i< 2*count/3?'medium':'hard' });
          } else if (slug.includes('equivalent-simplifying')){
            const a = rand(2,12), b = a*rand(2,10); const c = rand(2,12), d = c*rand(2,10);
            const g = (x,y)=> y? g(y, x%y): x; const num = b/g(b,a), den = a/g(b,a);
            out.push({ stem:`Simplify $\frac{${b}}{${a}}$.`, options:[`$\\dfrac{${num}}{${den}}$`,`$\\dfrac{${num+1}}{${den}}$`,`$\\dfrac{${num}}{${den+1}}$`,`$\\dfrac{${num-1}}{${den-1}}$`], correct:0, explanation:`Divide numerator and denominator by GCF.`, difficulty: i< count/3?'easy': i< 2*count/3?'medium':'hard' });
          } else if (slug.includes('decimal-operations')){
            const a = (rand(10,999)/10).toFixed(1), b = (rand(10,999)/10).toFixed(1);
            const op = ['+','-','×'][rand(0,2)];
            let ans = op==='+'? (Number(a)+Number(b)) : op==='-'? (Number(a)-Number(b)) : (Number(a)*Number(b));
            ans = Number(ans.toFixed(2));
            const opts = [ans, Number((ans+0.1).toFixed(2)), Number((ans-0.1).toFixed(2)), Number((ans+1).toFixed(2))].map(v=> `$${v}$`);
            out.push({ stem:`Compute $${a} ${op} ${b}$.`, options: _.shuffle(opts), correct:0, explanation:`$= ${ans}$.`, difficulty: i< count/3?'easy': i< 2*count/3?'medium':'hard' });
          } else if (slug.includes('convert-percent')){
            const p = rand(5,95);
            out.push({ stem:`Convert $${p}\%$ to a decimal.`, options:[`$${(p/100).toFixed(2)}$`,`$${p}$`,`$${(p*100)}$`,`$${(100/p).toFixed(2)}$`], correct:0, explanation:`Divide by $100$: $${(p/100).toFixed(2)}$.`, difficulty: i< count/3?'easy': i< 2*count/3?'medium':'hard' });
          } else if (slug.includes('one-step-equations')){
            const a = rand(2,12), x = rand(-10,10), b = a*x; const form = rand(0,1)? `${a}x=${b}` : `x+${a}=${a+x}`;
            const ans = x;
            out.push({ stem:`Solve $${form}$.`, options:[`$${ans}$`,`$${ans+1}$`,`$${ans-1}$`,`$${ans+2}$`], correct:0, explanation:`Inverse operations give $x=${ans}$.`, difficulty: i< count/3?'easy': i< 2*count/3?'medium':'hard' });
          } else if (slug.includes('pemdas')){
            const a = rand(1,9), b = rand(1,9), c = rand(1,9);
            const stem = `$${a}+(${b}\times ${c})$`;
            const ans = a + b*c;
            out.push({ stem:`Evaluate ${stem}.`, options:[`$${ans}$`,`$${a*b+c}$`,`$${a+b+c}$`,`$${(a+b)*c}$`], correct:0, explanation:`Multiply first: ${b}×${c}=${b*c}, then add ${a}.`, difficulty: i< count/3?'easy': i< 2*count/3?'medium':'hard' });
          } else if (slug.includes('plotting-points') || slug.includes('coordinate')){
            const x = rand(-5,5), y = rand(-5,5);
            const graph = { expressions:[ { id:'p1', latex:`(x-${x})^2+(y-${y})^2=0` } ] };
            out.push({ stem:`Which point is shown?`, options:[`$(${x},${y})$`,`$(${y},${x})$`,`$(${x},${-y})$`,`$(${y},${-x})$`], correct:0, explanation:`Coordinates read (x,y).`, difficulty: i< count/3?'easy': i< 2*count/3?'medium':'hard', graph });
          } else {
            // generic linear solve
            const n = rand(1,10);
            const stem = `Solve $x+${n}=${n*2}$.`;
            const ans = n; const opts = [ans, ans+1, ans-1, ans+2].map(v=> `$${v}$`);
            out.push({ stem, options: _.shuffle(opts), correct:0, explanation:`$x=${ans}$`, difficulty: i< count/3?'easy': i< 2*count/3?'medium':'hard' });
          }
        }
        return out;
      }

      function averageProgress(arr){
        if (!arr.length) return 0;
        return arr.reduce((s,l)=> s + (l.progress||0), 0) / arr.length;
      }

      // ===== 3D Carousel with keyboard/click/double-click =====
      const shelf = document.getElementById('psShelf');
      const openBtn = document.getElementById('psOpenBtn');
      const grid = document.getElementById('psBooksGrid');
      const BOOKS = [
        { id:'algebra-1', label:'Pre‑Algebra' },
        { id:'geometry', label:'Geometry' },
        { id:'algebra', label:'Algebra' },
        { id:'algebra-2', label:'Algebra II' },
        { id:'precalculus', label:'Pre‑Calculus' },
        { id:'calculus', label:'Calculus' },
      ];
      function renderGrid(){
        grid.innerHTML = '';
        BOOKS.forEach(b => {
          const tile = document.createElement('div'); tile.className='ps-book-tile';
          const cover = document.createElement('div'); cover.className='ps-book-cover'; cover.textContent=b.label; tile.appendChild(cover);
          tile.addEventListener('click', ()=> enterSubject(b.id));
          grid.appendChild(tile);
        });
      }
      renderGrid();

      // Ensure shelf shows on initial load (no deep link)
      (function(){
        try {
          const hash = (location.hash||'').replace('#','');
          const parts = hash ? hash.replace(/^\/?/, '').split('/') : [];
          if (!(parts.length >= 4)){
            const app = document.getElementById('psApp');
            const shelfEl = document.getElementById('psShelf');
            if (app) app.hidden = true;
            if (shelfEl) shelfEl.style.display = '';
          }
        } catch{}
      })();

      let currentCourseId = null;
      function enterSubject(subjectId){
        // show app and render sidebar; default lesson of that subject
        document.getElementById('psApp').hidden = false;
        currentCourseId = subjectId; renderSidebar();
        const c = COURSES.find(c=>c.id===subjectId) || COURSES[0];
        if (c) loadLesson(c.id, c.subtopics[0].id, c.subtopics[0].lessons[0].slug);
        // hide shelf grid after selection
        shelf.style.display='none';
        history.replaceState(null, '', `problem-sets.html#/${subjectId}/${c.subtopics[0].id}/${c.subtopics[0].lessons[0].slug}`);
      }

      // deep-link (hash)
      try {
        const hash = (location.hash||'').replace('#','');
        if (hash){
          const parts = hash.replace(/^\/?/, '').split('/');
          if (parts.length >= 4){
            document.getElementById('psApp').hidden = false; currentCourseId = parts[1]; renderSidebar();
            loadLesson(parts[1], parts[2], parts[3]);
            document.getElementById('psShelf').style.display='none';
          }
        }
      } catch{}
    </script>
    <script>window.TBP_AUTH_BASE='https://cramprep.onrender.com';</script>
    <script>
      window.TBP_GEMINI_API_KEY = 'AIzaSyDA_Rkb7-nIU25gGhuRs6yLmMFHmccpR8c';
      try { localStorage.setItem('tbp_gemini_key', window.TBP_GEMINI_API_KEY); } catch{}
    </script>
    <script src="index.js"></script>
    <script src="login.js?v=1.0"></script>
    <!-- deploy: force rebuild at ${Date.now()} -->
  </body>
  </html>


