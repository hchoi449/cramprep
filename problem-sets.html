<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Problem Sets - ThinkBigPrep</title>
    <link rel="stylesheet" href="css/index.css?v=1.1" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.11.3/font/bootstrap-icons.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.13.6/underscore-min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <!-- Perseus dependencies (Khan Academy open-source) -->
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Light-weight stand-in: we’ll use a simplified renderer approach that emulates Perseus style -->
    <style>
      .ps-container{display:grid;grid-template-columns:280px 1fr;gap:24px;max-width:1200px;margin:140px auto 80px;padding:0 20px}
      .ps-sidebar{position:sticky;top:96px;height:calc(100vh - 140px);overflow:auto;border:1px solid #e5e7eb;border-radius:12px;padding:12px;background:#fff}
      .ps-section-title{font-size:1.1rem;font-weight:800;color:#8B4513;margin:8px 0 6px}
      .ps-lesson{display:flex;align-items:center;justify-content:space-between;border:1px solid #eee;border-radius:10px;padding:8px 10px;margin:6px 0;background:#F5E6D3;color:#6b3410;cursor:pointer}
      .ps-lesson .status{font-size:.75rem;background:#fff;border:1px solid #e5e7eb;border-radius:9999px;padding:2px 8px}
      .ps-lock{color:#6b3410;opacity:.8;margin-right:6px}
      .ps-progress{height:6px;background:#f3f4f6;border-radius:9999px;overflow:hidden;margin:8px 0}
      .ps-progress>div{height:100%;background:#8B4513}
      .ps-content{border:1px solid #e5e7eb;border-radius:12px;padding:18px;background:#fff}
      .ps-breadcrumb{color:#6b7280;font-size:.9rem;margin-bottom:6px}
      .ps-title{font-size:1.6rem;font-weight:800;color:#1a1a1a;margin:6px 0 10px}
      .ps-actions{display:flex;gap:8px;margin-bottom:12px}
      .ps-actions .btn{padding:10px 14px;border-radius:10px}
      .ps-body{line-height:1.7;color:#1a1a1a}
      @media(max-width:900px){.ps-container{grid-template-columns:1fr}.ps-sidebar{position:fixed;left:0;top:0;bottom:0;width:78%;max-width:360px;transform:translateX(-105%);transition:transform .3s ease;z-index:1200}.ps-sidebar.active{transform:translateX(0)}.ps-toggle{position:fixed;top:96px;left:10px;z-index:1300;background:#F5E6D3;color:#6b3410;border:none;border-radius:8px;padding:10px 12px;box-shadow:0 8px 20px rgba(0,0,0,.15)}}
      /* Ensure hidden state always respected */
      #psApp[hidden]{display:none !important}
    </style>
  </head>
  <body class="problem-sets">
    <header class="header">
      <div class="header-container">
        <a href="index.html#home" class="logo" style="text-decoration:none;color:inherit;"><img src="./assets/logo/thinkbigprep-logo.svg" alt="ThinkBigPrep"/></a>
        <nav class="nav-desktop">
          <a href="index.html#home">Home</a>
          <a href="timetable.html">Timetable</a>
          <a href="index.html#courses">Plans</a>
          <a href="problem-sets.html" class="active">Problem Sets</a>
          <a href="ai-curriculum.html" class="ai-curriculum-link">AI Curriculum <span class="new-tag">NEW</span></a>
          <a href="login.html" class="student-login-link">Student Login</a>
        </nav>
        <button class="mobile-menu-btn" onclick="toggleMobileMenu()"><i class="bi bi-list"></i></button>
      </div>
    </header>

    <section class="timetable-hero" style="padding:140px 0 20px;">
      <div class="container">
        <h1 class="timetable-title">Problem Sets</h1>
        <p class="timetable-subtitle">Interactive exercises powered by a Perseus-style renderer</p>
      </div>
    </section>

    <!-- Feature A: 3D Rotating Books Carousel (React + Framer Motion UMD) -->
    <div class="ps-carousel" id="psShelf" aria-label="Subjects">
      <div class="ps-carousel-stage" id="psCarouselStage"></div>
      <div class="ps-open-overlay"><button class="ps-open-btn" id="psOpenBtn" aria-label="Open subject">Open</button></div>
    </div>

    <main class="ps-container" id="psApp" hidden>
      <button class="ps-toggle" aria-label="Toggle lessons" onclick="document.querySelector('.ps-sidebar').classList.toggle('active')"><i class="bi bi-list"></i> Lessons</button>
      <aside class="ps-sidebar" id="psSidebar"></aside>
      <section class="ps-content">
        <div class="ps-breadcrumb" id="psBreadcrumb">Algebra 1 / Lesson 1</div>
        <h2 class="ps-title" id="psTitle">Linear Equations — Basics</h2>
        <div class="ps-actions">
          <button class="btn btn-primary" id="psPracticeBtn">Practice</button>
          <button class="btn btn-secondary" id="psLiveBtn">Live Session</button>
        </div>
        <div class="ps-body" id="psBody"></div>
      </section>
    </main>

    <footer class="footer">
      <div class="container">
        <div class="footer-content">
          <div class="footer-section">
            <div class="footer-logo"><img src="./assets/logo/thinkbigprep-logo.svg" alt="ThinkBigPrep"/><span>ThinkBigPrep</span></div>
          </div>
          <div class="footer-section">
            <h4>SEE ALSO</h4>
            <ul>
              <li><a href="index.html#home">Home</a></li>
              <li><a href="timetable.html">Timetable</a></li>
              <li><a href="ai-curriculum.html">AI Curriculum</a></li>
              <li><a href="problem-sets.html">Problem Sets</a></li>
            </ul>
          </div>
          <div class="footer-section"><h4>CONTACT US</h4><p>Phone: 201-665-0123</p><p>Email: info@thinkbigprep.com</p></div>
        </div>
        <div class="footer-bottom"><p>ThinkBigPrep © 2025</p></div>
      </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/framer-motion@10.18.0/dist/framer-motion.umd.js"></script>
    <script>
      // Subject → Subtopics → Lessons; each lesson has notes and MC questions
      const COURSES = [
        { id:'algebra-1', title:'Algebra I', subtopics:[
          { id:'preliminaries', title:'Preliminaries', lessons:[
            { slug:'integer-exponents-basics', title:'Integer Exponents — Basics', locked:false,
              notes:`# Integer Exponents — Basics\nRules: a^m · a^n = a^{m+n}, (a^m)^n = a^{mn}, a^{-n}=1/a^n.`,
              questions:[
                { id:'q1', stem:'Simplify: a^3 · a^4', options:['a^7','a^{12}','a','7a'], correct:0, explanation:'Add exponents when multiplying same base: 3+4=7.', tags:['exponents','algebra1'] },
                { id:'q2', stem:'Simplify: (x^2)^3', options:['x^5','x^6','x^9','6x^2'], correct:1, explanation:'Power to a power: multiply exponents 2·3=6.', tags:['exponents'] },
                { id:'q3', stem:'Simplify: y^{-2}', options:['-y^2','1/y^2','y^2','-1/y^2'], correct:1, explanation:'Negative exponent means reciprocal: 1/y^2.', tags:['exponents'] }
              ]
            },
            { slug:'rational-exponents-intro', title:'Rational Exponents — Intro', locked:false,
              notes:`# Rational Exponents\nDefinition: a^{m/n} = n√(a^m) = (n√a)^m.`,
              questions:[
                { id:'q1', stem:'Rewrite x^{1/2}', options:['x^2','2x','√x','1/x^2'], correct:2, explanation:'x^{1/2} is square root of x.', tags:['rational exponents'] },
                { id:'q2', stem:'Simplify: (27)^{2/3}', options:['9','6','3','27^{1/3}'], correct:0, explanation:'Cube root of 27 is 3; 3^2=9.', tags:['rational exponents'] }
              ]
            }
          ]},
          { id:'polynomials', title:'Polynomials', lessons:[
            { slug:'adding-like-terms', title:'Adding Like Terms', locked:false,
              notes:`# Adding Like Terms\nCombine coefficients of same variable powers.`,
              questions:[
                { id:'q1', stem:'Simplify: 3x + 5x', options:['8','8x','x^8','2x'], correct:1, explanation:'3x + 5x = (3+5)x = 8x.', tags:['polynomials'] },
                { id:'q2', stem:'Simplify: 2x^2 + 7x^2', options:['9x','9x^2','x^4','14x^2'], correct:1, explanation:'Add coefficients: 2+7=9, keep x^2.', tags:['polynomials'] }
              ]
            }
          ]}
        ]},
        { id:'geometry', title:'Geometry', subtopics:[
          { id:'triangles', title:'Triangles & Congruence', lessons:[
            { slug:'triangle-sum', title:'Triangle Angle Sum', locked:false,
              notes:`# Triangle Angle Sum\nInterior angles of a triangle sum to 180°.`,
              questions:[
                { id:'q1', stem:'If two angles are 50° and 60°, the third is', options:['70°','60°','90°','120°'], correct:0, explanation:'180 - (50+60) = 70°.', tags:['triangles'] }
              ]
            }
          ]}
        ]},
        { id:'algebra-2', title:'Algebra II', subtopics:[
          { id:'quadratics', title:'Quadratics & Complex', lessons:[
            { slug:'vertex-form', title:'Vertex Form Intro', locked:false,
              notes:`# Vertex Form\ny = a(x-h)^2 + k`,
              questions:[
                { id:'q1', stem:'Vertex of y = (x-3)^2+2 is', options:['(3,2)','(-3,2)','(2,3)','(3,-2)'], correct:0, explanation:'h=3, k=2', tags:['quadratics'] }
              ]
            }
          ]}
        ]},
        { id:'precalculus', title:'Pre-Calculus', subtopics:[
          { id:'functions', title:'Functions & Graphs', lessons:[
            { slug:'domain-range', title:'Domain & Range Basics', locked:false,
              notes:`# Domain & Range\nConsider restrictions like division by zero, even roots.`,
              questions:[
                { id:'q1', stem:'Domain of f(x)=1/(x-2)', options:['x≠2','x≥2','x≤2','all real x'], correct:0, explanation:'Denominator cannot be zero.', tags:['functions'] }
              ]
            }
          ]}
        ]},
        { id:'calculus', title:'Calculus', subtopics:[
          { id:'limits', title:'Limits & Continuity', lessons:[
            { slug:'limit-basics', title:'Limit Basics', locked:false,
              notes:`# Limits\nlim_{x→a} f(x) describes approaching behavior.`,
              questions:[
                { id:'q1', stem:'lim_{x→0} (2x) = ?', options:['0','1','2','DNE'], correct:0, explanation:'2x → 0 as x→0.', tags:['limits'] }
              ]
            }
          ]}
        ]}
      ];

      function saveProgress(key, value){ try { localStorage.setItem(key, JSON.stringify(value)); } catch{} }
      function getProgress(key, fallback){ try { const v = localStorage.getItem(key); return v ? JSON.parse(v) : fallback; } catch{ return fallback; } }

      function renderSidebar(){
        const root = document.getElementById('psSidebar');
        root.innerHTML = '';
        COURSES.forEach(course => {
          const h = document.createElement('div'); h.className='ps-section-title'; h.textContent = course.title; root.appendChild(h);
          const progKey = `ps-progress-${course.id}`;
          const progVal = getProgress(progKey, 0);
          const bar = document.createElement('div'); bar.className='ps-progress'; bar.innerHTML = `<div style="width:${Math.round(progVal*100)}%"></div>`; root.appendChild(bar);

          (course.subtopics||[]).forEach(st => {
            const stHdr = document.createElement('div');
            stHdr.className = 'ps-lesson';
            stHdr.style.fontWeight='700'; stHdr.style.background='#fff';
            stHdr.innerHTML = `<span>${st.title}</span><i class="bi bi-caret-down-fill"></i>`;
            root.appendChild(stHdr);
            const ul = document.createElement('div'); ul.style.margin='6px 0 10px'; ul.style.paddingLeft='8px'; root.appendChild(ul);
            let expanded = true;
            function toggle(){ expanded = !expanded; ul.style.display = expanded ? '' : 'none'; stHdr.querySelector('i').className = expanded ? 'bi bi-caret-down-fill' : 'bi bi-caret-right-fill'; }
            stHdr.addEventListener('click', toggle);

            (st.lessons||[]).forEach(lesson => {
              const row = document.createElement('div'); row.className='ps-lesson'; row.dataset.slug = `${course.id}/${st.id}/${lesson.slug}`;
              const left = document.createElement('div');
              left.style.display='inline-flex'; left.style.alignItems='center';
              if (lesson.locked) { const i=document.createElement('i'); i.className='bi bi-lock ps-lock'; left.appendChild(i); }
              const t=document.createElement('span'); t.textContent=lesson.title; left.appendChild(t);
              const right = document.createElement('div'); right.className='status';
              const score = getProgress(`ps-best-${course.id}-${st.id}-${lesson.slug}`, 0);
              right.innerHTML = lesson.locked? 'Locked' : (score>0? `<span class="ps-badge"><i class="bi bi-check-circle"></i>${Math.round(score*100)}%</span>`:'Start');
              row.appendChild(left); row.appendChild(right);
              row.addEventListener('click', ()=> loadLesson(course.id, st.id, lesson.slug));
              ul.appendChild(row);
            });
          });
        });
      }

      function mdToHtml(md){
        return md
          .replace(/^# (.*)$/gm, '<h3>$1</h3>')
          .replace(/^## (.*)$/gm, '<h4>$1</h4>')
          .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
          .replace(/\n/g, '<br/>');
      }

      function loadLesson(courseId, subtopicId, lessonSlug){
        const course = COURSES.find(c=>c.id===courseId); if (!course) return;
        const subtopic = (course.subtopics||[]).find(s=>s.id===subtopicId) || (course.subtopics||[])[0]; if (!subtopic) return;
        const lesson = (subtopic.lessons||[]).find(l=>l.slug===lessonSlug) || subtopic.lessons[0]; if (!lesson || lesson.locked) return;

        document.getElementById('psBreadcrumb').textContent = `${course.title} / ${subtopic.title} / ${lesson.title}`;
        document.getElementById('psTitle').textContent = lesson.title;
        renderLessonContent(course, subtopic, lesson);

        // compute overall course progress as average of best lesson scores across subtopics
        const allLessons = course.subtopics.flatMap(st=> st.lessons || []);
        const avg = allLessons.length ? allLessons.reduce((s,l)=> s + getProgress(`ps-best-${course.id}-${subtopic.id === (course.subtopics[0]||{}).id ? subtopic.id : (course.subtopics.find(st=> st.lessons.includes(l))||{}).id}-${l.slug}`, 0), 0) / allLessons.length : 0;
        saveProgress(`ps-progress-${courseId}`, avg);
        renderSidebar();
        history.replaceState(null, '', `problem-sets.html#/${courseId}/${subtopic.id}/${lesson.slug}`);
      }

      function renderLessonContent(course, subtopic, lesson){
        const body = document.getElementById('psBody');
        body.innerHTML = '';
        const notes = document.createElement('div');
        notes.innerHTML = mdToHtml(lesson.notes||'');
        body.appendChild(notes);

        if ((lesson.questions||[]).length){
          const quiz = document.createElement('div'); quiz.style.marginTop='16px';
          const h = document.createElement('h4'); h.textContent = 'Problem Set'; quiz.appendChild(h);
          const results = document.createElement('div'); results.style.margin='8px 0'; quiz.appendChild(results);

          let scoreBest = getProgress(`ps-best-${course.id}-${subtopic.id}-${lesson.slug}`, 0);
          function renderQuiz(){
            const qWrap = document.createElement('div'); qWrap.className='ps-quiz';
            let correctCount = 0; let answered = 0; results.textContent='';
            (lesson.questions).forEach((q, qi)=>{
              const card = document.createElement('div'); card.className='ps-q-card';
              const stem = document.createElement('div'); stem.className='ps-stem'; stem.textContent = `${qi+1}. ${q.stem}`; card.appendChild(stem);
              const opts = document.createElement('div'); opts.className='ps-opts';
              const order = _.shuffle(q.options.map((opt, idx)=> ({opt, idx})));
              order.forEach((pair, oi)=>{
                const btn = document.createElement('button'); btn.type='button'; btn.className='ps-opt'; btn.textContent = pair.opt; btn.setAttribute('aria-pressed','false');
                btn.addEventListener('click', ()=>{
                  if (btn.dataset.locked==='1') return;
                  [...opts.children].forEach(ch=>{ ch.classList.remove('sel'); ch.setAttribute('aria-pressed','false'); });
                  btn.classList.add('sel'); btn.setAttribute('aria-pressed','true');
                  btn.dataset.chosen = pair.idx;
                });
                opts.appendChild(btn);
              });
              card.appendChild(opts);
              const submit = document.createElement('button'); submit.className='btn btn-primary'; submit.textContent='Submit';
              const explain = document.createElement('div'); explain.className='ps-explain';
              submit.addEventListener('click', ()=>{
                const chosenBtn = [...opts.children].find(ch=> ch.classList.contains('sel'));
                if (!chosenBtn){ results.textContent='Please select an answer before submitting.'; results.style.color='#8B4513'; return; }
                const chosen = Number(chosenBtn.dataset.chosen);
                answered++; const correct = chosen === q.correct; if (correct) correctCount++;
                [...opts.children].forEach((ch,i)=>{ ch.dataset.locked='1'; ch.disabled=true; ch.classList.add('locked'); });
                submit.disabled = true;
                explain.innerHTML = correct ? `<span style="color:#155e2b"><i class='bi bi-check-circle'></i> Correct.</span> ${q.explanation}` : `<span style="color:#991b1b"><i class='bi bi-x-circle'></i> Incorrect.</span> ${q.explanation}`;
                if (answered === lesson.questions.length){
                  const pct = correctCount / lesson.questions.length; results.innerHTML = `Score: ${Math.round(pct*100)}%`;
                  if (pct > scoreBest){ scoreBest = pct; saveProgress(`ps-best-${course.id}-${subtopic.id}-${lesson.slug}`, scoreBest); renderSidebar(); }
                  const retry = document.createElement('button'); retry.className='btn btn-secondary'; retry.style.marginLeft='8px'; retry.textContent='Retry';
                  retry.addEventListener('click', ()=>{ body.scrollIntoView({behavior:'smooth',block:'start'}); quiz.innerHTML=''; quiz.appendChild(h); quiz.appendChild(results); renderQuiz(); });
                  results.appendChild(retry);
                }
              });
              card.appendChild(submit);
              card.appendChild(explain);
              qWrap.appendChild(card);
            });
            quiz.appendChild(qWrap);
          }
          renderQuiz();
          body.appendChild(quiz);
        }
      }

      function averageProgress(arr){
        if (!arr.length) return 0;
        return arr.reduce((s,l)=> s + (l.progress||0), 0) / arr.length;
      }

      // ===== 3D Carousel with keyboard/click/double-click =====
      const shelf = document.getElementById('psShelf');
      const openBtn = document.getElementById('psOpenBtn');
      const stage = document.getElementById('psCarouselStage');
      const BOOKS = [
        { id:'algebra-1', label:'Algebra I' },
        { id:'geometry', label:'Geometry' },
        { id:'algebra-2', label:'Algebra II' },
        { id:'precalculus', label:'Pre‑Calculus' },
        { id:'calculus', label:'Calculus' },
      ];
      let index = 0; let lastClickTs = 0;
      function renderCarousel(){
        const radius = 420; const cardW = 180; const cardH = 240;
        const angleStep = (2*Math.PI)/BOOKS.length;
        stage.innerHTML = '';
        stage.style.transform = `translate(-50%, -50%) rotateY(${(-index*angleStep)}rad)`;
        BOOKS.forEach((b,i)=>{
          const angle = i*angleStep;
          const x = Math.sin(angle)*radius;
          const z = Math.cos(angle)*radius;
          const y = 0;
          const div = document.createElement('div');
          div.className='ps-book-card';
          div.dataset.subject=b.id;
          div.style.transform = `translate3d(${x}px, ${y}px, ${z}px) rotateY(${angle}rad)`;
          const focused = i===index; div.dataset.focus = focused ? 'true':'false';
          div.style.zIndex = String(1000 + Math.round(z));
          div.style.transform += focused? ' scale(1.12)': '';
          const label = document.createElement('div'); label.className='ps-book-label'; label.textContent=b.label; div.appendChild(label);
          div.tabIndex = 0;
          div.addEventListener('click', ()=>{
            const now = Date.now();
            if (i===index && now - lastClickTs < 250){ enterSubject(b.id); return; }
            lastClickTs = now; index = i; renderCarousel();
          });
          div.addEventListener('dblclick', ()=>{ if (i===index) enterSubject(b.id); });
          div.addEventListener('keydown', (e)=>{
            if (e.key==='Enter' || e.key===' '){ e.preventDefault(); if (i===index){ enterSubject(b.id); } else { index=i; renderCarousel(); } }
            if (e.key==='ArrowRight'){ e.preventDefault(); index=(index+1)%BOOKS.length; renderCarousel(); }
            if (e.key==='ArrowLeft'){ e.preventDefault(); index=(index-1+BOOKS.length)%BOOKS.length; renderCarousel(); }
          });
          stage.appendChild(div);
        });
      }
      renderCarousel();
      shelf.addEventListener('keydown', (e)=>{
        if (e.key==='ArrowRight'){ index=(index+1)%BOOKS.length; renderCarousel(); }
        if (e.key==='ArrowLeft'){ index=(index-1+BOOKS.length)%BOOKS.length; renderCarousel(); }
      });
      openBtn.addEventListener('click', ()=>{ const b=BOOKS[index]; enterSubject(b.id); });

      function enterSubject(subjectId){
        // show app and render sidebar; default lesson of that subject
        document.getElementById('psApp').hidden = false;
        renderSidebar();
        const c = COURSES.find(c=>c.id===subjectId) || COURSES[0];
        if (c) loadLesson(c.id, c.subtopics[0].id, c.subtopics[0].lessons[0].slug);
        // reduced-motion friendly: simple fade out shelf
        shelf.style.display='none';
        document.querySelector('.ps-carousel-controls').style.display='none';
        history.replaceState(null, '', `problem-sets.html#/${subjectId}/${c.subtopics[0].id}/${c.subtopics[0].lessons[0].slug}`);
      }

      // deep-link (hash)
      try {
        const hash = (location.hash||'').replace('#','');
        if (hash){
          const parts = hash.replace(/^\/?/, '').split('/');
          if (parts.length >= 4){
            document.getElementById('psApp').hidden = false; renderSidebar();
            loadLesson(parts[1], parts[2], parts[3]);
            document.getElementById('psShelf').style.display='none';
            document.querySelector('.ps-carousel-controls').style.display='none';
          }
        }
      } catch{}
    </script>
    <script src="index.js"></script>
  </body>
  </html>


