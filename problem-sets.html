<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Think Lab - ThinkBigPrep</title>
    <link rel="shortcut icon" href="assets/logo/thinkbigprep-icon.svg" type="image/svg+xml" />
    <link rel="stylesheet" href="css/index.css?v=1.1" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.11.3/font/bootstrap-icons.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.13.6/underscore-min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <!-- Perseus dependencies (Khan Academy open-source) -->
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" />
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Light-weight stand-in: we’ll use a simplified renderer approach that emulates Perseus style -->
    <style>
      .ps-container{display:grid;grid-template-columns:420px minmax(0,1fr);gap:32px;width:min(98vw, 1680px);max-width:1680px;margin:140px auto 80px;padding:0 24px}
      .ps-sidebar{position:sticky;top:96px;align-self:start;height:calc(100vh - 140px);overflow:auto;border:1px solid #e5e7eb;border-radius:12px;padding:12px;background:#fff}
      .ps-section-title{font-size:1.1rem;font-weight:800;color:#8B4513;margin:8px 0 6px}
      .ps-lesson{display:flex;align-items:center;justify-content:space-between;border:1px solid #eee;border-radius:10px;padding:8px 10px;margin:6px 0;background:#F5E6D3;color:#6b3410;cursor:pointer}
      .ps-lesson .status{font-size:.75rem;background:#fff;border:1px solid #e5e7eb;border-radius:9999px;padding:2px 8px}
      .ps-lock{color:#6b3410;opacity:.8;margin-right:6px}
      .ps-progress{height:6px;background:#f3f4f6;border-radius:9999px;overflow:hidden;margin:8px 0}
      .ps-progress>div{height:100%;background:#8B4513}
      .ps-content{border:1px solid #e5e7eb;border-radius:12px;padding:18px;background:#fff}
      .ps-breadcrumb{color:#6b7280;font-size:.9rem;margin-bottom:6px}
      .ps-title{font-size:1.6rem;font-weight:800;color:#1a1a1a;margin:6px 0 10px}
      .ps-actions{display:flex;gap:8px;margin-bottom:12px}
      .ps-actions .btn{padding:10px 14px;border-radius:10px}
      .ps-body{line-height:1.7;color:#1a1a1a}
      @media(max-width:1200px){.ps-container{grid-template-columns:360px minmax(0,1fr);gap:28px}}
      @media(max-width:900px){.ps-container{grid-template-columns:1fr;width:100%;padding:0 16px}.ps-sidebar{position:relative;top:auto;height:auto;overflow:visible}.ps-toggle{display:none}}
      /* Ensure hidden state always respected */
      #psApp[hidden]{display:none !important}
    </style>
  </head>
  <body class="problem-sets">
    <header class="header">
      <div class="header-container">
        <a href="index.html#home" class="logo" style="text-decoration:none;color:inherit;"><img src="./assets/logo/thinkbigprep-logo.svg" alt="ThinkBigPrep"/></a>
        <nav class="nav-desktop">
          <a href="index.html#home">Home</a>
          <a href="timetable.html">Timetable</a>
          <a href="index.html#courses">Plans</a>
          <a href="problem-sets.html" class="active">Think Lab</a>
          <a href="ai-curriculum.html" class="ai-curriculum-link">AI Curriculum <span class="new-tag">NEW</span></a>
          <a href="login.html" class="student-login-link">Student Login</a>
        </nav>
        <button class="mobile-menu-btn" onclick="toggleMobileMenu()"><i class="bi bi-list"></i></button>
      </div>
    </header>

    <section class="timetable-hero" style="padding:140px 0 20px;">
      <div class="container">
        <h1 class="timetable-title">Think Lab</h1>
        <p class="timetable-subtitle">Interactive practice with notes and problem sets</p>
      </div>
    </section>

    <!-- Feature A: 3D Rotating Books Carousel (React + Framer Motion UMD) -->
    <div id="psShelf" aria-label="Subjects">
      <div class="ps-books-grid" id="psBooksGrid"></div>
    </div>

    <main class="ps-container" id="psApp" hidden>
      <aside class="ps-sidebar" id="psSidebar"><div id="psOutline"></div></aside>
      <section class="ps-content">
        <div class="ps-breadcrumb" id="psBreadcrumb">Algebra 1 / Lesson 1</div>
        <h2 class="ps-title" id="psTitle">Linear Equations — Basics</h2>
        <div class="ps-actions">
          <button class="btn btn-primary" id="psPracticeBtn">Practice</button>
          <button class="btn btn-secondary" id="psLiveBtn">Live Session</button>
        </div>
        <div class="ps-body" id="psBody"></div>
      </section>
    </main>

    <footer class="footer">
      <div class="container">
        <div class="footer-content">
          <div class="footer-section">
            <div class="footer-logo"><img src="./assets/logo/thinkbigprep-logo.svg" alt="ThinkBigPrep"/><span>ThinkBigPrep</span></div>
          </div>
          <div class="footer-section">
            <h4>SEE ALSO</h4>
            <ul>
              <li><a href="index.html#home">Home</a></li>
              <li><a href="timetable.html">Timetable</a></li>
              <li><a href="ai-curriculum.html">AI Curriculum</a></li>
              <li><a href="problem-sets.html">Think Lab</a></li>
            </ul>
          </div>
          <div class="footer-section"><h4>CONTACT US</h4><p>Phone: 201-665-0123</p><p>Email: info@thinkbigprep.com</p></div>
        </div>
        <div class="footer-bottom"><p>ThinkBigPrep © 2025</p></div>
      </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/framer-motion@10.18.0/dist/framer-motion.umd.js"></script>
    <script>
      // Subject → Subtopics → Lessons; each lesson has notes and MC questions
      const COURSES = [
        { id:'algebra-1', title:'Algebra I', subtopics:[
          { id:'preliminaries', title:'Preliminaries', lessons:[
            { slug:'integer-exponents-basics', title:'Integer Exponents — Basics', locked:false,
              notes:`# Integer Exponents — Basics\nRules: $a^m\\cdot a^n = a^{m+n}$, $(a^m)^n = a^{mn}$, $a^{-n}=\\dfrac{1}{a^n}$.`,
              questions:[
                { id:'q1', stem:'Simplify: $a^3 \\cdot a^4$', options:['$a^7$','$a^{12}$','$a$','$7a$'], correct:0, explanation:'Add exponents when multiplying same base: $3+4=7$.', tags:['exponents','algebra1'] },
                { id:'q2', stem:'Simplify: $(x^2)^3$', options:['$x^5$','$x^6$','$x^9$','$6x^2$'], correct:1, explanation:'Power to a power: multiply exponents $2\\cdot3=6$.', tags:['exponents'] },
                { id:'q3', stem:'Simplify: $y^{-2}$', options:['$-y^2$','$1/y^2$','$y^2$','$-1/y^2$'], correct:1, explanation:'Negative exponent means reciprocal: $\\dfrac{1}{y^2}$.', tags:['exponents'] }
              ]
            },
            { slug:'rational-exponents-intro', title:'Rational Exponents — Intro', locked:false,
              notes:`# Rational Exponents\nDefinition: $a^{m/n} = \\sqrt[n]{a^m} = (\\sqrt[n]{a})^m$.`,
              questions:[
                { id:'q1', stem:'Rewrite $x^{1/2}$', options:['$x^2$','$2x$','$\\sqrt{x}$','$1/x^2$'], correct:2, explanation:'$x^{1/2}$ is the square root of $x$.', tags:['rational exponents'] },
                { id:'q2', stem:'Simplify: $(27)^{2/3}$', options:['$9$','$6$','$3$','$27^{1/3}$'], correct:0, explanation:'Cube root of $27$ is $3$; $3^2=9$.', tags:['rational exponents'] }
              ]
            }
          ]},
          { id:'polynomials', title:'Polynomials', lessons:[
            { slug:'adding-like-terms', title:'Adding Like Terms', locked:false,
              notes:`# Adding Like Terms\nCombine coefficients of same variable powers.`,
              questions:[
                { id:'q1', stem:'Simplify: $3x + 5x$', options:['$8$','$8x$','$x^8$','$2x$'], correct:1, explanation:'$3x + 5x = (3+5)x = 8x$.', tags:['polynomials'] },
                { id:'q2', stem:'Simplify: $2x^2 + 7x^2$', options:['$9x$','$9x^2$','$x^4$','$14x^2$'], correct:1, explanation:'Add coefficients: $2+7=9$, keep $x^2$.', tags:['polynomials'] }
              ]
            }
          ]}
        ]},
        { id:'geometry', title:'Geometry', subtopics:[
          { id:'triangles', title:'Triangles & Congruence', lessons:[
            { slug:'triangle-sum', title:'Triangle Angle Sum', locked:false,
              notes:`# Triangle Angle Sum\nInterior angles of a triangle sum to 180°.`,
              questions:[
                { id:'q1', stem:'If two angles are $50^\\circ$ and $60^\\circ$, the third is', options:['$70^\\circ$','$60^\\circ$','$90^\\circ$','$120^\\circ$'], correct:0, explanation:'$180^\\circ - (50^\\circ+60^\\circ) = 70^\\circ$.', tags:['triangles'] }
              ]
            }
          ]}
        ]},
        { id:'algebra-2', title:'Algebra II', subtopics:[
          { id:'quadratics', title:'Quadratics & Complex', lessons:[
            { slug:'vertex-form', title:'Vertex Form Intro', locked:false,
              notes:`# Vertex Form\n$y = a(x-h)^2 + k$`,
              questions:[
                { id:'q1', stem:'Vertex of $y = (x-3)^2+2$ is', options:['$(3,2)$','$(-3,2)$','$(2,3)$','$(3,-2)$'], correct:0, explanation:'$h=3,\\ k=2$', tags:['quadratics'] }
              ]
            }
          ]}
        ]},
        { id:'precalculus', title:'Pre-Calculus', subtopics:[
          { id:'functions', title:'Functions & Graphs', lessons:[
            { slug:'domain-range', title:'Domain & Range Basics', locked:false,
              notes:`# Domain & Range\nConsider restrictions like division by zero, even roots.`,
              questions:[
                { id:'q1', stem:'Domain of $f(x)=\\dfrac{1}{x-2}$', options:['$x\\ne2$','$x\\ge2$','$x\\le2$','all real $x$'], correct:0, explanation:'Denominator cannot be zero.', tags:['functions'] }
              ]
            }
          ]}
        ]},
        { id:'calculus', title:'Calculus', subtopics:[
          { id:'limits', title:'Limits & Continuity', lessons:[
            { slug:'limit-basics', title:'Limit Basics', locked:false,
              notes:`# Limits\n$\\lim_{x\\to a} f(x)$ describes approaching behavior.`,
              questions:[
                { id:'q1', stem:'$\\lim_{x\\to 0} (2x) =\ ?$', options:['$0$','$1$','$2$','DNE'], correct:0, explanation:'$2x \\to 0$ as $x\\to0$.', tags:['limits'] }
              ]
            }
          ]}
        ]}
      ];

      function saveProgress(key, value){ try { localStorage.setItem(key, JSON.stringify(value)); } catch{} }
      function getProgress(key, fallback){ try { const v = localStorage.getItem(key); return v ? JSON.parse(v) : fallback; } catch{ return fallback; } }

      function renderSidebar(){
        const root = document.getElementById('psOutline');
        root.innerHTML = '';
        // Course selector
        const selectWrap = document.createElement('div'); selectWrap.style.margin='4px 0 10px';
        const select = document.createElement('select'); select.style.width='100%'; select.style.padding='8px'; select.style.borderRadius='8px'; select.style.border='1px solid #e5e7eb';
        COURSES.forEach(c=>{ const opt=document.createElement('option'); opt.value=c.id; opt.textContent=c.title; if (c.id===currentCourseId) opt.selected=true; select.appendChild(opt); });
        selectWrap.appendChild(select); root.appendChild(selectWrap);

        const course = COURSES.find(c=>c.id===currentCourseId) || COURSES[0];
        const h = document.createElement('div'); h.className='ps-section-title'; h.textContent = course.title; root.appendChild(h);
        const progKey = `ps-progress-${course.id}`;
        const progVal = getProgress(progKey, 0);
        const bar = document.createElement('div'); bar.className='ps-progress'; bar.innerHTML = `<div style="width:${Math.round(progVal*100)}%"></div>`; root.appendChild(bar);

        (course.subtopics||[]).forEach(st => {
          const stHdr = document.createElement('div');
          stHdr.className = 'ps-lesson';
          stHdr.style.fontWeight='700'; stHdr.style.background='#fff';
          stHdr.innerHTML = `<span>${st.title}</span><i class="bi bi-caret-down-fill"></i>`;
          root.appendChild(stHdr);
          const ul = document.createElement('div'); ul.style.margin='6px 0 10px'; ul.style.paddingLeft='8px'; root.appendChild(ul);
          let expanded = true;
          function toggle(){ expanded = !expanded; ul.style.display = expanded ? '' : 'none'; stHdr.querySelector('i').className = expanded ? 'bi bi-caret-down-fill' : 'bi bi-caret-right-fill'; }
          stHdr.addEventListener('click', toggle);

          (st.lessons||[]).forEach(lesson => {
            const row = document.createElement('div'); row.className='ps-lesson'; row.dataset.slug = `${course.id}/${st.id}/${lesson.slug}`;
            const left = document.createElement('div');
            left.style.display='inline-flex'; left.style.alignItems='center';
            if (lesson.locked) { const i=document.createElement('i'); i.className='bi bi-lock ps-lock'; left.appendChild(i); }
            const t=document.createElement('span'); t.textContent=lesson.title; left.appendChild(t);
            const right = document.createElement('div'); right.className='status';
            const score = getProgress(`ps-best-${course.id}-${st.id}-${lesson.slug}`, 0);
            right.innerHTML = lesson.locked? 'Locked' : (score>0? `<span class="ps-badge"><i class="bi bi-check-circle"></i>${Math.round(score*100)}%</span>`:'Start');
            row.appendChild(left); row.appendChild(right);
            row.addEventListener('click', ()=> loadLesson(course.id, st.id, lesson.slug));
            ul.appendChild(row);
          });
        });

        select.addEventListener('change', ()=>{
          currentCourseId = select.value;
          renderSidebar();
          const c = COURSES.find(x=>x.id===currentCourseId);
          if (c && c.subtopics && c.subtopics[0] && c.subtopics[0].lessons && c.subtopics[0].lessons[0]){
            loadLesson(c.id, c.subtopics[0].id, c.subtopics[0].lessons[0].slug);
          }
        });
      }

      function mdToHtml(md){
        return md
          .replace(/^# (.*)$/gm, '<h3>$1</h3>')
          .replace(/^## (.*)$/gm, '<h4>$1</h4>')
          .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
          .replace(/\n/g, '<br/>');
      }

      function loadLesson(courseId, subtopicId, lessonSlug){
        const course = COURSES.find(c=>c.id===courseId); if (!course) return;
        const subtopic = (course.subtopics||[]).find(s=>s.id===subtopicId) || (course.subtopics||[])[0]; if (!subtopic) return;
        const lesson = (subtopic.lessons||[]).find(l=>l.slug===lessonSlug) || subtopic.lessons[0]; if (!lesson || lesson.locked) return;

        document.getElementById('psBreadcrumb').textContent = `${course.title} / ${subtopic.title} / ${lesson.title}`;
        document.getElementById('psTitle').textContent = lesson.title;
        renderLessonContent(course, subtopic, lesson);

        // compute overall course progress as average of best lesson scores across subtopics
        const allLessons = course.subtopics.flatMap(st=> st.lessons || []);
        const avg = allLessons.length ? allLessons.reduce((s,l)=> s + getProgress(`ps-best-${course.id}-${subtopic.id === (course.subtopics[0]||{}).id ? subtopic.id : (course.subtopics.find(st=> st.lessons.includes(l))||{}).id}-${l.slug}`, 0), 0) / allLessons.length : 0;
        saveProgress(`ps-progress-${courseId}`, avg);
        renderSidebar();
        history.replaceState(null, '', `problem-sets.html#/${courseId}/${subtopic.id}/${lesson.slug}`);
      }

      function renderLessonContent(course, subtopic, lesson){
        const body = document.getElementById('psBody');
        body.innerHTML = '';
        const notes = document.createElement('div');
        notes.innerHTML = mdToHtml(lesson.notes||'');
        body.appendChild(notes);
        try { if (window.renderMathInElement) { renderMathInElement(notes, { delimiters:[{left:"$$", right:"$$", display:true},{left:"$", right:"$", display:false}] }); } } catch{}

        if ((lesson.questions||[]).length){
          const quiz = document.createElement('div'); quiz.style.marginTop='16px';
          const h = document.createElement('h4'); h.textContent = 'Problem Set'; quiz.appendChild(h);
          const results = document.createElement('div'); results.style.margin='8px 0'; quiz.appendChild(results);

          let scoreBest = getProgress(`ps-best-${course.id}-${subtopic.id}-${lesson.slug}`, 0);
          function renderQuiz(){
            const qWrap = document.createElement('div'); qWrap.className='ps-quiz';
            let correctCount = 0; let answered = 0; results.textContent='';
            (lesson.questions).forEach((q, qi)=>{
              const card = document.createElement('div'); card.className='ps-q-card';
              const stem = document.createElement('div'); stem.className='ps-stem'; stem.textContent = `${qi+1}. ${q.stem}`; card.appendChild(stem);
              try { if (window.renderMathInElement) { renderMathInElement(stem, { delimiters:[{left:"$$", right:"$$", display:true},{left:"$", right:"$", display:false}] }); } } catch{}
              const opts = document.createElement('div'); opts.className='ps-opts';
              const order = _.shuffle(q.options.map((opt, idx)=> ({opt, idx})));
              order.forEach((pair, oi)=>{
                const btn = document.createElement('button'); btn.type='button'; btn.className='ps-opt'; btn.textContent = pair.opt; btn.setAttribute('aria-pressed','false');
                btn.addEventListener('click', ()=>{
                  if (btn.dataset.locked==='1') return;
                  [...opts.children].forEach(ch=>{ ch.classList.remove('sel'); ch.setAttribute('aria-pressed','false'); });
                  btn.classList.add('sel'); btn.setAttribute('aria-pressed','true');
                  btn.dataset.chosen = pair.idx;
                });
                opts.appendChild(btn);
              });
              card.appendChild(opts);
              try { if (window.renderMathInElement) { renderMathInElement(opts, { delimiters:[{left:"$$", right:"$$", display:true},{left:"$", right:"$", display:false}] }); } } catch{}
              const submit = document.createElement('button'); submit.className='btn btn-primary'; submit.textContent='Submit';
              const explain = document.createElement('div'); explain.className='ps-explain';
              submit.addEventListener('click', ()=>{
                const chosenBtn = [...opts.children].find(ch=> ch.classList.contains('sel'));
                if (!chosenBtn){ results.textContent='Please select an answer before submitting.'; results.style.color='#8B4513'; return; }
                const chosen = Number(chosenBtn.dataset.chosen);
                answered++; const correct = chosen === q.correct; if (correct) correctCount++;
                [...opts.children].forEach((ch,i)=>{ ch.dataset.locked='1'; ch.disabled=true; ch.classList.add('locked'); });
                submit.disabled = true;
                explain.innerHTML = correct ? `<span style="color:#155e2b"><i class='bi bi-check-circle'></i> Correct.</span> ${q.explanation}` : `<span style="color:#991b1b"><i class='bi bi-x-circle'></i> Incorrect.</span> ${q.explanation}`;
                if (answered === lesson.questions.length){
                  const pct = correctCount / lesson.questions.length; results.innerHTML = `Score: ${Math.round(pct*100)}%`;
                  if (pct > scoreBest){ scoreBest = pct; saveProgress(`ps-best-${course.id}-${subtopic.id}-${lesson.slug}`, scoreBest); renderSidebar(); }
                  const retry = document.createElement('button'); retry.className='btn btn-secondary'; retry.style.marginLeft='8px'; retry.textContent='Retry';
                  retry.addEventListener('click', ()=>{ body.scrollIntoView({behavior:'smooth',block:'start'}); quiz.innerHTML=''; quiz.appendChild(h); quiz.appendChild(results); renderQuiz(); });
                  results.appendChild(retry);
                }
              });
              card.appendChild(submit);
              card.appendChild(explain);
              qWrap.appendChild(card);
            });
            quiz.appendChild(qWrap);
          }
          renderQuiz();
          body.appendChild(quiz);
        }
      }

      function averageProgress(arr){
        if (!arr.length) return 0;
        return arr.reduce((s,l)=> s + (l.progress||0), 0) / arr.length;
      }

      // ===== 3D Carousel with keyboard/click/double-click =====
      const shelf = document.getElementById('psShelf');
      const openBtn = document.getElementById('psOpenBtn');
      const grid = document.getElementById('psBooksGrid');
      const BOOKS = [
        { id:'algebra-1', label:'Algebra I' },
        { id:'geometry', label:'Geometry' },
        { id:'algebra-2', label:'Algebra II' },
        { id:'precalculus', label:'Pre‑Calculus' },
        { id:'calculus', label:'Calculus' },
      ];
      function renderGrid(){
        grid.innerHTML = '';
        BOOKS.forEach(b => {
          const tile = document.createElement('div'); tile.className='ps-book-tile';
          const cover = document.createElement('div'); cover.className='ps-book-cover'; cover.textContent=b.label; tile.appendChild(cover);
          const actions = document.createElement('div'); actions.className='ps-book-actions';
          const btn = document.createElement('button'); btn.className='ps-open-btn'; btn.textContent='Open'; btn.addEventListener('click', ()=> enterSubject(b.id)); actions.appendChild(btn);
          tile.appendChild(actions);
          grid.appendChild(tile);
        });
      }
      renderGrid();

      let currentCourseId = null;
      function enterSubject(subjectId){
        // show app and render sidebar; default lesson of that subject
        document.getElementById('psApp').hidden = false;
        currentCourseId = subjectId; renderSidebar();
        const c = COURSES.find(c=>c.id===subjectId) || COURSES[0];
        if (c) loadLesson(c.id, c.subtopics[0].id, c.subtopics[0].lessons[0].slug);
        // hide shelf grid after selection
        shelf.style.display='none';
        history.replaceState(null, '', `problem-sets.html#/${subjectId}/${c.subtopics[0].id}/${c.subtopics[0].lessons[0].slug}`);
      }

      // deep-link (hash)
      try {
        const hash = (location.hash||'').replace('#','');
        if (hash){
          const parts = hash.replace(/^\/?/, '').split('/');
          if (parts.length >= 4){
            document.getElementById('psApp').hidden = false; currentCourseId = parts[1]; renderSidebar();
            loadLesson(parts[1], parts[2], parts[3]);
            document.getElementById('psShelf').style.display='none';
          }
        }
      } catch{}
    </script>
    <script src="index.js"></script>
  </body>
  </html>


