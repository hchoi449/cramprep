<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Jarvis Upload - ThinkBigPrep</title>
    <meta name="description" content="Upload worksheets to build a custom study guide in Jarvis." />
    <link rel="shortcut icon" href="assets/logo/thinkbigprep-icon.svg" type="image/svg+xml" />
    <link rel="stylesheet" href="css/index.css?v=1.1" />
    <link rel="stylesheet" href="css/login.css?v=1.0" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.11.3/font/bootstrap-icons.min.css" />
  </head>
  <body>
    <header class="header">
      <div class="header-container">
        <a href="index.html#home" class="logo" aria-label="ThinkBigPrep Logo" style="text-decoration:none;color:inherit;">
          <img src="./assets/logo/thinkbigprep-logo.svg" alt="ThinkBigPrep" style="height:48px;width:auto;" />
        </a>
        <nav class="nav-desktop">
          <a href="index.html#home">Home</a>
          <a href="timetable.html">Timetable</a>
          <a href="index.html#courses">Plans</a>
          <a href="index.html#coaches">Available Tutors</a>
          <a href="about.html">About Us</a>
          <a href="jarvis.html">Jarvis</a>
          <a href="ai-curriculum.html">AI Curriculum</a>
          <a href="problem-sets.html">Think Lab <span class="new-tag">NEW</span></a>
          <a href="login.html" class="student-login-link">Student Login</a>
        </nav>
        <button class="mobile-menu-btn" onclick="toggleMobileMenu()"><i class="bi bi-list"></i></button>
      </div>
      <nav class="nav-mobile" id="mobile-menu">
        <a href="index.html#home">Home</a>
        <a href="timetable.html">Timetable</a>
        <a href="index.html#courses">Plans</a>
        <a href="index.html#coaches">Available Tutors</a>
        <a href="about.html">About Us</a>
        <a href="jarvis.html">Jarvis</a>
        <a href="ai-curriculum.html">AI Curriculum</a>
        <a href="problem-sets.html">Think Lab <span class="new-tag">NEW</span></a>
      </nav>
    </header>

    <main class="settings-wrap" style="min-height:calc(100vh - 220px);">
      <section id="jarvisAuthWarning" class="settings-card" aria-live="polite" style="max-width:900px; margin:120px auto 0;" hidden>
        <div class="settings-head">
          <h1 class="settings-title">Login Required</h1>
          <p class="settings-sub">Please sign in to your ThinkBigPrep account to access Jarvis uploads.</p>
        </div>
        <div style="display:flex; gap:12px; flex-wrap:wrap;">
          <a href="login.html" class="btn btn-primary student-login-link">Log In</a>
          <a href="index.html#home" class="btn btn-secondary">Back to Home</a>
        </div>
      </section>

      <div id="jarvisApp">
        <section class="settings-card" aria-labelledby="uploadTitle" style="max-width:900px; margin:120px auto 80px;">
          <div class="settings-head">
            <h2 id="uploadTitle" class="settings-title">Upload Worksheets</h2>
            <p class="settings-sub">Drag & drop PDFs or images, or browse to upload. Progress is shown per file.</p>
          </div>
          <div style="padding:16px; display:grid; gap:12px;">
            <div style="display:grid; gap:10px; grid-template-columns:1fr 1fr;">
              <div>
                <label class="setting-label" for="schoolInput">School</label>
                <div style="position:relative">
                  <input id="schoolInput" type="text" placeholder="Search school..." autocomplete="off" style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:8px" />
                  <div id="schoolSuggest" style="position:absolute;left:0;right:0;top:46px;background:#fff;border:1px solid #e5e7eb;border-radius:8px;box-shadow:0 10px 20px rgba(0,0,0,.08);display:none;max-height:220px;overflow:auto;z-index:20"></div>
                </div>
              </div>
              <div>
                <label class="setting-label" for="courseSelect">Course</label>
                <select id="courseSelect" style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:8px;background:#fff">
                  <option value="">Select course</option>
                  <option>Pre-Algebra</option>
                  <option>Geometry</option>
                  <option>Algebra I</option>
                  <option>Algebra II</option>
                  <option>Pre-Calculus</option>
                  <option>Calculus AB</option>
                  <option>Calculus BC</option>
                </select>
              </div>
              <div>
                <label class="setting-label" for="teacherInput">Teacher</label>
                <input id="teacherInput" type="text" placeholder="ex. Mrs. Smith" autocomplete="off" style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:8px" />
              </div>
              <div>
                <label class="setting-label" for="examSelect">Exams / Quizzes</label>
                <select id="examSelect" style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:8px;background:#fff">
                  <option value="" disabled selected>Loading examsâ€¦</option>
                </select>
                <div style="margin-top:8px; display:flex; gap:8px; align-items:center;">
                  <input id="examCustomInput" type="text" placeholder="Add custom exam title" style="flex:1;padding:10px;border:1px solid #e5e7eb;border-radius:8px" />
                  <button type="button" id="examAddBtn" class="btn btn-secondary" style="flex:0 0 auto;white-space:nowrap;">Add</button>
                </div>
              </div>
            </div>
            <div>
              <label class="setting-label" for="lessonSlugInput">Lesson Slug</label>
              <input id="lessonSlugInput" type="text" placeholder="e.g., algebra-ii" style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:8px" />
            </div>
            <div id="tbp-uploader" class="rounded-2xl border border-slate-200 bg-white p-4" style="box-shadow:0 10px 30px rgba(0,0,0,.08);">
              <div id="tbp-dropzone" class="rounded-2xl border border-dashed border-slate-300" style="padding:24px; text-align:center; background:#f8fafb; cursor:pointer;">
                <div style="display:inline-flex; align-items:center; justify-content:center; height:64px; width:64px; border-radius:9999px; background:#fff; color:#6b7280; box-shadow:0 1px 4px rgba(0,0,0,.08); margin-bottom:8px;">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden style="height:28px; width:28px;">
                    <path d="M19.35 10.04a7.49 7.49 0 0 0-14-2.09A5.5 5.5 0 0 0 6.5 21H18a4.5 4.5 0 0 0 1.35-10.96ZM12 13a1 1 0 0 1 1 1v3.586l.293-.293a1 1 0 1 1 1.414 1.414l-2.707 2.707a1 1 0 0 1-1.414 0L7.879 18.707a1 1 0 0 1 1.414-1.414L9.586 17V14a1 1 0 0 1 1-1h1.414Z"/>
                  </svg>
                </div>
                <h3 style="margin:4px 0 0; font-size:18px; font-weight:700; color:#1f2937;">Upload files</h3>
                <p style="margin:2px 0 0; color:#6b7280;">JPEG, PNG, PDF up to 50MB each</p>
                <div class="rounded-2xl border border-dashed border-slate-300" style="padding:16px; margin-top:12px;">
                  <p style="font-weight:600; color:#1f2937;">Choose a file or drag & drop it here</p>
                  <p style="margin-top:4px; color:#6b7280; font-size:14px;">Click to browse or drop multiple files</p>
                  <div style="margin-top:10px;">
                    <button id="tbp-browse" type="button" class="btn btn-primary">Browse File</button>
                  </div>
                  <input id="tbp-file-input" type="file" multiple accept="image/jpeg,image/png,application/pdf" style="display:none" />
                </div>
              </div>

              <div id="tbp-file-list" style="margin-top:16px; display:none;" class="rounded-2xl bg-slate-50 p-4">
                <div style="display:flex; align-items:center; justify-content:space-between;">
                  <p id="tbp-file-count" style="font-weight:600; color:#334155; font-size:14px;">0 files selected</p>
                  <div style="display:flex; gap:8px;">
                    <button id="tbp-clear" type="button" class="btn">Clear</button>
                    <button id="tbp-upload" type="button" class="btn btn-secondary" disabled>Upload</button>
                  </div>
                </div>
                <div id="tbp-rows" style="margin-top:8px;"></div>
              </div>
            </div>
          </div>
        </section>
      </div>
    </main>

    <div id="jarvisLoading" style="display:none;position:fixed;inset:0;background:rgba(255,255,255,0.92);backdrop-filter:saturate(140%) blur(2px);z-index:50;align-items:center;justify-content:center;">
      <div style="text-align:center;">
        <div class="tbp-star-spinner" aria-label="Loading" style="margin:0 auto 12px;"></div>
        <div style="font-size:20px;font-weight:800;color:#6b3410;">Custom made Study Guide loading....</div>
        <div id="jarvisEta" style="margin-top:6px;color:#6b7280;font-weight:600;">Estimated wait ~ 00:00</div>
      </div>
    </div>

    <footer class="footer">
      <div class="container">
        <div class="footer-content">
          <div class="footer-section">
            <div class="footer-logo"><img src="./assets/logo/thinkbigprep-logo.svg" alt="ThinkBigPrep" /><span>ThinkBigPrep</span></div>
          </div>
          <div class="footer-section">
            <h4>SEE ALSO</h4>
            <ul>
              <li><a href="index.html#home">Home</a></li>
              <li><a href="timetable.html">Timetable</a></li>
              <li><a href="ai-curriculum.html">AI Curriculum</a></li>
              <li><a href="problem-sets.html">Think Lab</a></li>
            </ul>
          </div>
          <div class="footer-section"><h4>CONTACT US</h4><p>Phone: 201-665-0123</p><p>Email: info@thinkbigprep.com</p></div>
        </div>
        <div class="footer-bottom"><p>ThinkBigPrep Â© 2025</p></div>
      </div>
    </footer>

    <script>window.TBP_AUTH_BASE='https://cramprep.onrender.com';</script>
    <script src="index.js"></script>
    <script src="login.js?v=1.0"></script>
    <script>
      (function(){
        const jarvisApp = document.getElementById('jarvisApp');
        const warning = document.getElementById('jarvisAuthWarning');
        if (!jarvisApp || !warning) return;

        let lastAuthState = null;

        function setState(authenticated) {
          jarvisApp.hidden = !authenticated;
          warning.hidden = authenticated;
          if (authenticated) jarvisApp.removeAttribute('aria-hidden');
          else jarvisApp.setAttribute('aria-hidden', 'true');
          if (authenticated && lastAuthState !== true) {
            try { window.dispatchEvent(new CustomEvent('tbp:jarvis:authenticated')); } catch {}
          }
          if (!authenticated && lastAuthState === true) {
            try { window.dispatchEvent(new CustomEvent('tbp:jarvis:unauthenticated')); } catch {}
          }
          lastAuthState = authenticated;
        }

        async function verifyAuth() {
          let token = null;
          try { token = localStorage.getItem('tbp_token'); } catch {}
          if (!token) {
            setState(false);
            return;
          }
          const base = (window.TBP_AUTH_BASE || '').replace(/\/$/, '');
          const url = base ? `${base}/auth/me` : '/auth/me';
          try {
            const res = await fetch(url, { headers: { 'Authorization': `Bearer ${token}` } });
            const data = await res.json().catch(() => ({}));
            if (res.ok && data && data.authenticated) {
              setState(true);
              return;
            }
            if (res.status === 401 || res.status === 403) {
              try {
                localStorage.removeItem('tbp_token');
                localStorage.removeItem('tbp_user');
              } catch {}
            }
          } catch (err) {
            console.warn('Jarvis auth verification failed', err);
          }
          setState(false);
        }

        function init() {
          jarvisApp.hidden = true;
          warning.hidden = true;
          verifyAuth();
        }

        init();
        window.addEventListener('tbp:auth:login', verifyAuth);
        window.addEventListener('storage', function(e){
          if (!e) return;
          if (e.key === 'tbp_token' || e.key === 'tbp_user') {
            verifyAuth();
          }
        });
      })();
    </script>
    <script>
      (function(){
        const examSelect = document.getElementById('examSelect');
        const customInput = document.getElementById('examCustomInput');
        const addBtn = document.getElementById('examAddBtn');
        if (!examSelect) return;

        let loaded = false;
        let loading = false;

        function notify(message, type) {
          if (typeof showNotification === 'function') {
            showNotification(message, type || 'info', type === 'success' ? 3800 : 2600);
          } else {
            if (type === 'error') console.error(message);
            else console.log(message);
          }
        }

        function setPlaceholder(message, opts) {
          opts = opts || {};
          examSelect.innerHTML = '';
          const placeholder = new Option(message, '');
          placeholder.disabled = true;
          placeholder.selected = true;
          examSelect.appendChild(placeholder);
          if (typeof opts.disabled !== 'undefined') {
            examSelect.disabled = !!opts.disabled;
          }
        }

        function ensureDefaultOption() {
          if (examSelect.options.length === 0 || examSelect.options[0].value !== '') {
            const opt = new Option('Select exam or quiz', '');
            opt.disabled = true;
            opt.selected = true;
            examSelect.insertBefore(opt, examSelect.firstChild);
          }
        }

        function handleCustomAdd() {
          if (!customInput) return;
          const text = customInput.value.trim();
          if (!text) {
            notify('Please enter a title before adding.', 'error');
            return;
          }
          const existing = Array.from(examSelect.options).find(opt => !opt.disabled && opt.value === text);
          let target = existing;
          if (!existing) {
            const option = new Option(text, text, true, true);
            option.dataset.examDate = '';
            examSelect.appendChild(option);
            target = option;
          } else {
            existing.selected = true;
          }
          examSelect.disabled = false;
          if (target) target.selected = true;
          examSelect.dispatchEvent(new Event('change', { bubbles: true }));
          customInput.value = '';
          notify('Custom exam added to the list.', 'success');
        }

        if (addBtn) addBtn.addEventListener('click', handleCustomAdd);
        if (customInput) {
          customInput.addEventListener('keydown', function(e){
            if (e.key === 'Enter') {
              e.preventDefault();
              handleCustomAdd();
            }
          });
        }

        function decodeIcsText(text) {
          return String(text || '').replace(/\\n/g, '\n').replace(/\\,/g, ',').replace(/\\;/g, ';');
        }

        function icsToDate(raw) {
          if (!raw) return null;
          if (/^\d{8}$/.test(raw)) {
            const y = Number(raw.slice(0, 4));
            const m = Number(raw.slice(4, 6));
            const d = Number(raw.slice(6, 8));
            return new Date(Date.UTC(y, m - 1, d, 12, 0, 0));
          }
          if (/^\d{8}T\d{6}Z$/.test(raw)) {
            const y = Number(raw.slice(0, 4));
            const m = Number(raw.slice(4, 6));
            const d = Number(raw.slice(6, 8));
            const hh = Number(raw.slice(9, 11));
            const mm = Number(raw.slice(11, 13));
            const ss = Number(raw.slice(13, 15));
            return new Date(Date.UTC(y, m - 1, d, hh, mm, ss));
          }
          const dt = new Date(raw);
          return isNaN(dt.getTime()) ? null : dt;
        }

        function parseIcs(text) {
          const events = [];
          if (!text) return events;
          const lines = text.split(/\r?\n/);
          const unfolded = [];
          for (let i = 0; i < lines.length; i++) {
            const line = lines[i];
            if (/^\s/.test(line) && unfolded.length) {
              unfolded[unfolded.length - 1] += line.trim();
            } else {
              unfolded.push(line);
            }
          }
          let current = null;
          for (const raw of unfolded) {
            const line = raw.trim();
            if (line === 'BEGIN:VEVENT') {
              current = {};
              continue;
            }
            if (line === 'END:VEVENT') {
              if (current) {
                events.push(current);
                current = null;
              }
              continue;
            }
            if (!current) continue;
            const idx = line.indexOf(':');
            if (idx < 0) continue;
            const keyPart = line.slice(0, idx);
            const val = line.slice(idx + 1);
            const key = keyPart.split(';')[0];
            if (key === 'DTSTART' || key.startsWith('DTSTART')) current.DTSTART = val;
            else if (key === 'DTEND' || key.startsWith('DTEND')) current.DTEND = val;
            else if (key === 'SUMMARY') current.SUMMARY = decodeIcsText(val);
            else if (key === 'DESCRIPTION') current.DESCRIPTION = decodeIcsText(val);
          }
          return events.map(ev => ({
            title: ev.SUMMARY || 'Assessment',
            description: ev.DESCRIPTION || '',
            start: icsToDate(ev.DTSTART),
            end: icsToDate(ev.DTEND || ev.DTSTART)
          })).filter(ev => !!ev.start);
        }

        function isAssessmentEvent(ev) {
          const text = `${ev.title || ''}\n${ev.description || ''}`.toLowerCase();
          return /\b(exam|test|assessment|quiz)\b/.test(text);
        }

        function dedupeEvents(events) {
          const map = new Map();
          events.forEach(ev => {
            const key = `${(ev.title || '').trim().toLowerCase()}|${ev.start ? ev.start.toISOString().slice(0, 10) : ''}`;
            if (!map.has(key)) map.set(key, ev);
          });
          return Array.from(map.values()).sort((a, b) => {
            const aTime = a.start ? a.start.getTime() : 0;
            const bTime = b.start ? b.start.getTime() : 0;
            return aTime - bTime;
          });
        }

        function formatExamLabel(ev) {
          const title = ev.title || 'Assessment';
          if (!ev.start) return title;
          const formatter = new Intl.DateTimeFormat(undefined, { weekday:'long', month:'short', day:'numeric' });
          return `${formatter.format(ev.start)} â€” ${title}`;
        }

        async function loadExamOptions() {
          if (loading || loaded) return;
          loading = true;
          setPlaceholder('Loading examsâ€¦', { disabled: true });
          try {
            let token = null;
            try { token = localStorage.getItem('tbp_token'); } catch {}
            if (!token) {
              setPlaceholder('Please log in to access exams.', { disabled: true });
              return;
            }
            const base = (window.TBP_AUTH_BASE || '').replace(/\/$/, '');
            const profileRes = await fetch(`${base}/auth/profile`, { headers: { 'Authorization': `Bearer ${token}` } });
            const profileJson = await profileRes.json().catch(() => ({}));
            const profile = profileRes.ok && profileJson && profileJson.profile ? profileJson.profile : null;
            const icsUrl = profile && profile.icsUrl ? String(profile.icsUrl).trim() : '';
            if (!icsUrl) {
              setPlaceholder('Please fill out the iCal (ics) URL in settings.', { disabled: false });
              examSelect.disabled = false;
              loaded = true;
              return;
            }
            const icsRes = await fetch(`${base}/auth/ics?url=${encodeURIComponent(icsUrl)}`, { headers: { 'Authorization': `Bearer ${token}` } });
            if (!icsRes.ok) throw new Error('ics_fetch_failed');
            const icsText = await icsRes.text();
            const allAssessments = parseIcs(icsText).filter(isAssessmentEvent);
            const today = new Date(); today.setHours(0, 0, 0, 0);
            const upcoming = allAssessments.filter(ev => ev.start && ev.start >= today);
            const events = dedupeEvents(upcoming);
            if (!events.length) {
              setPlaceholder('No upcoming exams found. Add your own below.', { disabled: false });
              examSelect.disabled = false;
              loaded = true;
              return;
            }
            examSelect.innerHTML = '';
            ensureDefaultOption();
            events.forEach(ev => {
              const value = (ev.title || '').trim() || formatExamLabel(ev);
              const option = new Option(formatExamLabel(ev), value);
              option.dataset.examDate = ev.start ? ev.start.toISOString() : '';
              examSelect.appendChild(option);
            });
            examSelect.disabled = false;
            loaded = true;
          } catch (err) {
            console.warn('Failed to load exam options', err);
            setPlaceholder('Unable to load exams. Add your own below.', { disabled: false });
            examSelect.disabled = false;
            loaded = true;
          } finally {
            loading = false;
          }
        }

        window.addEventListener('tbp:jarvis:authenticated', loadExamOptions);
        window.addEventListener('tbp:jarvis:unauthenticated', function(){
          loaded = false;
          setPlaceholder('Please log in to access exams.', { disabled: true });
        });

        loadExamOptions();
      })();
    </script>
    <script>
      (function(){
        const ACCEPT = ['image/jpeg','image/png','application/pdf'];
        const MAX_MB = 50; const MAX_BYTES = MAX_MB * 1024 * 1024;
        const MAX_FILES = 5;
        const els = {
          drop: document.getElementById('tbp-dropzone'),
          browse: document.getElementById('tbp-browse'),
          input: document.getElementById('tbp-file-input'),
          list: document.getElementById('tbp-file-list'),
          count: document.getElementById('tbp-file-count'),
          clear: document.getElementById('tbp-clear'),
          upload: document.getElementById('tbp-upload'),
          rows: document.getElementById('tbp-rows'),
          slug: document.getElementById('lessonSlugInput')
        };
        const overlay = document.getElementById('jarvisLoading');
        const overlayEta = document.getElementById('jarvisEta');
        let items = [];

        function fmtBytes(bytes){ if (bytes===0) return '0 B'; const k=1024; const sizes=['B','KB','MB','GB']; const i=Math.floor(Math.log(bytes)/Math.log(k)); return `${(bytes/Math.pow(k,i)).toFixed(i===0?0:2)} ${sizes[i]}`; }
        function setDragging(on){ els.drop.style.background = on ? '#eff6ff' : '#f8fafb'; }
        function dedupeKey(f){ return f.name + '|' + f.size; }

        function render(){
          els.list.style.display = items.length ? 'block' : 'none';
          els.count.textContent = `${items.length} file${items.length>1?'s':''} selected`;
          els.upload.disabled = !items.some(x => x.status==='ready');
          els.rows.innerHTML = items.map(it => {
            const badge = it.file.type.includes('pdf')? 'PDF' : (it.file.type.includes('png')?'PNG':'JPG');
            const barColor = it.status==='error'? '#ef4444' : '#0ea5e9';
            const showBar = it.status !== 'ready';
            return `
              <div class=\"flex items-start justify-between gap-4 py-3\" style=\"display:flex;align-items:flex-start;justify-content:space-between;gap:16px;padding:12px 0;border-top:1px solid #e5e7eb;\">
                <div class=\"min-w-0 flex-1\" style=\"min-width:0;flex:1;\">
                  <div class=\"flex items-center gap-2\" style=\"display:flex;align-items:center;gap:8px;\">
                    <span class=\"inline-flex h-8 w-8 items-center justify-content-center rounded-xl bg-slate-100 text-slate-600\" style=\"display:inline-flex;height:32px;width:32px;border-radius:12px;background:#f1f5f9;color:#475569;align-items:center;justify-content:center;\">${badge}</span>
                    <div class=\"min-w-0\" style=\"min-width:0;\">
                      <p class=\"truncate text-sm font-medium text-slate-900\" style=\"margin:0;font-weight:600;color:#111827;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;\">${it.file.name}</p>
                      <p class=\"text-xs text-slate-500\" style=\"margin:2px 0 0;color:#6b7280;font-size:12px;\">${fmtBytes(it.file.size)}</p>
                    </div>
                  </div>
                  ${showBar?`
                    <div class=\"mt-2\" style=\"margin-top:8px;\">
                      <div class=\"h-2 w-full overflow-hidden rounded-full bg-slate-100\" style=\"height:8px;border-radius:9999px;background:#f1f5f9;\">
                        <div style=\"height:8px;border-radius:9999px;background:${barColor};width:${it.progress||0}%;\"></div>
                      </div>
                      <p class=\"mt-1 text-xs text-slate-500\" style=\"margin-top:4px;color:#64748b;font-size:12px;\">
                        ${it.status==='uploading'?`Uploadingâ€¦ ${Math.round(it.progress||0)}%`: it.status==='done'?'Uploaded': it.status==='error'?(it.error||'Upload failed') : 'Ready'}
                      </p>
                    </div>
                  `:''}
                </div>
                <button type=\"button\" data-id=\"${it.id}\" class=\"btn\" style=\"border:1px solid #e5e7eb;border-radius:12px;padding:6px 12px;font-size:12px;\" aria-label=\"Remove ${it.file.name}\">Remove</button>
              </div>
            `; }).join('');

          els.rows.querySelectorAll('button[data-id]').forEach(btn => {
            btn.addEventListener('click', function(){
              const id = this.getAttribute('data-id');
              items = items.filter(x => x.id !== id);
              render();
            });
          });
        }

        function addFiles(fileList){
          if (!fileList) return;
          if (items.length >= MAX_FILES){ alert(`You can upload up to ${MAX_FILES} files.`); return; }
          Array.from(fileList).forEach(file => {
            if (!ACCEPT.includes(file.type) && !/\.pdf$/i.test(file.name) && !/\.png$/i.test(file.name) && !/\.jpe?g$/i.test(file.name)) {
              return;
            }
            if (file.size > MAX_BYTES) {
              alert(`${file.name} is larger than ${MAX_MB}MB.`);
              return;
            }
            const key = dedupeKey(file);
            if (items.some(it => it.key === key)) return;
            items.push({
              id: `${Date.now()}-${Math.random().toString(36).slice(2)}`,
              key,
              file,
              progress: 0,
              status: 'ready'
            });
          });
          render();
        }

        if (els.drop){
          els.drop.addEventListener('dragover', function(e){ e.preventDefault(); setDragging(true); });
          els.drop.addEventListener('dragleave', function(e){ e.preventDefault(); setDragging(false); });
          els.drop.addEventListener('drop', function(e){ e.preventDefault(); setDragging(false); addFiles(e.dataTransfer.files); });
          els.drop.addEventListener('click', function(){ els.input?.click(); });
        }
        if (els.browse) els.browse.addEventListener('click', () => els.input?.click());
        if (els.input) els.input.addEventListener('change', function(){ addFiles(this.files); this.value = ''; });
        if (els.clear) els.clear.addEventListener('click', function(){ items = []; render(); });

        function loadStoredGuides(){
          try {
            const raw = localStorage.getItem('jarvisGuides');
            const arr = raw ? JSON.parse(raw) : [];
            return Array.isArray(arr) ? arr.filter(g => g && g.slug) : [];
          } catch {
            return [];
          }
        }

        function storeGuideMetadata(guide){
          const guides = loadStoredGuides().filter(g => g.slug !== guide.slug);
          guides.unshift(guide);
          localStorage.setItem('jarvisGuides', JSON.stringify(guides.slice(0, 50)));
          localStorage.setItem('jarvisLatestGuide', guide.slug);
          try { window.dispatchEvent(new CustomEvent('tbp:jarvis:guides-updated')); } catch {}
        }

        function ensureSlug(){
          if (!els.slug) return;
          let current = (els.slug.value || '').trim();
          if (!current) {
            current = `jarvis-${Date.now()}`;
            els.slug.value = current;
          }
          return current;
        }

        ensureSlug();

        els.upload.addEventListener('click', async function(){
          if (!items.length){
            alert('Please add at least one file before uploading.');
            return;
          }
          const slug = ensureSlug();
          const school = (document.getElementById('schoolInput').value||'').trim();
          const course = (document.getElementById('courseSelect').value||'').trim();
          const teacher = (document.getElementById('teacherInput').value||'').trim();
          try { overlay.style.display='flex'; } catch{}
          const totalToProcess = items.filter(it => it.status==='ready').length || items.length || 1;
          const PER_FILE_SEC = 20;
          const t0 = Date.now();
          function fmt(s){ s=Math.max(0,Math.ceil(s)); const m=Math.floor(s/60); const r=s%60; return `${String(m).padStart(2,'0')}:${String(r).padStart(2,'0')}`; }
          let timer = null;
          const tick = ()=>{
            const done = items.filter(it => it.status==='done').length;
            const remaining = Math.max(0, totalToProcess - done);
            const target = Math.max(5, remaining * PER_FILE_SEC);
            try { overlayEta.textContent = `Estimated wait ~ ${fmt(target)}`; } catch{}
          };
          try { tick(); timer = setInterval(tick, 1000); } catch{}
          items = items.map(it => it.status==='ready'? { ...it, status:'uploading', progress:5 } : it);
          render();
          for (const it of items){
            if (it.status !== 'uploading') continue;
            try {
              await new Promise((resolve, reject) => {
                const xhr = new XMLHttpRequest();
                xhr.open('POST', (window.TBP_AUTH_BASE||'') + '/ai/worksheet/upload');
                xhr.upload.onprogress = (e) => {
                  if (!e.lengthComputable) return;
                  const p = Math.round((e.loaded / e.total) * 100);
                  it.progress = p; render();
                };
                xhr.onreadystatechange = function(){
                  if (xhr.readyState === 4){
                    try {
                      const j = JSON.parse(xhr.responseText||'{}');
                      if (xhr.status>=200 && xhr.status<300 && j && j.ok){
                        const fileUrl = j.url || '';
                        const doPre = fileUrl ? fetch((window.TBP_AUTH_BASE||'') + '/ai/worksheet/preprocess', {
                          method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ url: fileUrl, dpi: 300 })
                        }).then(r=>r.json()).catch(()=>({})): Promise.resolve({});
                        doPre.then(pp=>{
                          it.status='done';
                          it.progress=100;
                          if (pp && pp.images) it.pngs = pp.images;
                          render();
                          resolve(null);
                        }).catch(()=>{
                          it.status='done';
                          it.progress=100;
                          render();
                          resolve(null);
                        });
                      } else {
                        it.status='error';
                        it.error=(j&&j.error)||('Upload failed '+xhr.status);
                        render();
                        reject(new Error(it.error));
                      }
                    }
                    catch(e){
                      it.status='error';
                      it.error='Invalid server response';
                      render();
                      reject(e);
                    }
                  }
                };
                const form = new FormData();
                form.append('lessonSlug', slug);
                form.append('file', it.file, it.file.name);
                if (school) form.append('school', school);
                if (course) form.append('course', course);
                if (teacher) form.append('teacher', teacher);
                xhr.send(form);
              });
            } catch { /* already marked */ }
          }
          try { if (timer) clearInterval(timer); } catch{}
          try { overlay.style.display='none'; } catch{}

          const selected = examSelect && examSelect.options[examSelect.selectedIndex];
          const examTitle = selected && !selected.disabled ? (selected.value || selected.textContent || '').trim() : '';
          const examDate = selected && selected.dataset ? selected.dataset.examDate || '' : '';
          const guideTitle = examTitle || (course ? course + ' Study Guide' : slug);
          storeGuideMetadata({
            slug,
            title: guideTitle,
            examDate,
            course,
            school,
            teacher,
            createdAt: new Date().toISOString()
          });
          window.location.href = `jarvis.html?guide=${encodeURIComponent(slug)}`;
        });

        render();
      })();
    </script>
  </body>
</html>
